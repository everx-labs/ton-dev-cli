"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DevDocker = exports.ContainerStatus = void 0;

var _dockerode = _interopRequireDefault(require("dockerode"));

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const ContainerStatus = {
  missing: 0,
  created: 1,
  running: 2
};
exports.ContainerStatus = ContainerStatus;

class DevDocker {
  constructor() {
    _defineProperty(this, "client", void 0);

    _defineProperty(this, "_images", void 0);

    _defineProperty(this, "_containers", void 0);

    _defineProperty(this, "_onStartupImagesPassed", void 0);

    _defineProperty(this, "onStartupImages", void 0);

    _defineProperty(this, "onBeforePull", void 0);

    this.client = new _dockerode.default();
    this.onStartupImages = null;
    this.onBeforePull = null;
    this._onStartupImagesPassed = false;
    this._images = null;
    this._containers = null;
  }

  dropCache() {
    this._images = null;
    this._containers = null;
  }

  async getImageInfos() {
    if (!this._images) {
      const images = await this.client.listImages({
        all: true
      });
      this._images = images;

      if (!this._onStartupImagesPassed) {
        this._onStartupImagesPassed = true;

        if (this.onStartupImages) {
          this.onStartupImages(images);
        }
      }

      this._images = images;
    }

    return this._images || [];
  }

  async getContainerInfos() {
    if (!this._containers) {
      this._containers = await this.client.listContainers({
        all: true
      });
    }

    return this._containers || [];
  }

  async numericVersion() {
    const version = await this.client.version();
    return (0, _utils.versionToNumber)(version.Version);
  }

  async removeImages(nameMatches, containersOnly) {
    // Stop and remove containers that belongs to images
    const containerInfos = (await this.getContainerInfos()).filter(info => {
      return nameMatches.find(match => DevDocker.containersImageMatched(info, match));
    });

    for (let i = 0; i < containerInfos.length; i += 1) {
      const info = containerInfos[i];
      (0, _utils.progress)(`Removing container [${DevDocker.containerTitle(info)}]`);
      const container = this.client.getContainer(info.Id);

      if (DevDocker.isRunning(info)) {
        await container.stop();
      }

      await container.remove();
      (0, _utils.progressDone)();
    }

    if (containersOnly) {
      return;
    } // Remove images


    const imageInfos = (await this.getImageInfos()).filter(info => {
      return nameMatches.find(match => DevDocker.imageHasMatchedName(info, match));
    });

    for (let i = 0; i < imageInfos.length; i += 1) {
      const info = imageInfos[i];
      (0, _utils.progress)(`Removing image [${DevDocker.imageTitle(info)}]`);
      const image = this.client.getImage(info.Id);
      await image.remove();
      (0, _utils.progressDone)();
    }
  }

  async pull(repoTag) {
    if (this.onBeforePull) {
      await this.onBeforePull(repoTag);
    }

    const client = this.client;
    const title = `Pulling [${repoTag}]`;
    (0, _utils.progress)(title);
    const image = await new Promise((resolve, reject) => {
      client.pull(repoTag, {}, function (err, stream) {
        if (!stream) {
          reject(err);
          return;
        }

        let lastReportTime = Date.now();
        client.modem.followProgress(stream, onFinished, onProgress);

        function onFinished(err, output) {
          resolve(output);
        }

        function onProgress(event) {
          (0, _utils.progressLine)(`${title}... ${event.progress || ''}`);
        }
      });
    });
    (0, _utils.progress)(title);
    (0, _utils.progressDone)();
    return image;
  }

  async findImageInfo(name) {
    return (await this.getImageInfos()).find(x => DevDocker.imageHasMatchedName(x, name)) || null;
  }

  async findContainerInfo(name) {
    return (await this.getContainerInfos()).find(x => DevDocker.hasName(x, name)) || null;
  }

  async shutdownContainer(def, downTo) {
    const info = await this.findContainerInfo(def.containerName);

    if (!info) {
      return;
    }

    if (downTo < ContainerStatus.running && DevDocker.isRunning(info)) {
      (0, _utils.progress)(`Stopping [${def.containerName}]`);
      await this.client.getContainer(info.Id).stop();
      (0, _utils.progressDone)();
      this.dropCache();
    }

    if (downTo < ContainerStatus.created) {
      (0, _utils.progress)(`Removing [${def.containerName}]`);
      await this.client.getContainer(info.Id).remove();
      (0, _utils.progressDone)();
      this.dropCache();
    }
  }

  async ensureImage(requiredImage) {
    if (!(await this.findImageInfo(requiredImage))) {
      await this.pull(requiredImage);
      this.dropCache();
    }
  }

  async startupContainer(def, upTo) {
    await this.ensureImage(def.requiredImage);
    let info = await this.findContainerInfo(def.containerName);

    if (upTo >= ContainerStatus.created && !info) {
      (0, _utils.progress)(`Creating ${def.containerName}`);
      await def.createContainer(this);
      (0, _utils.progressDone)();
      this.dropCache();
      info = await this.findContainerInfo(def.containerName);
    }

    if (upTo >= ContainerStatus.running && info && !DevDocker.isRunning(info)) {
      (0, _utils.progress)(`Starting ${def.containerName}`);
      await this.client.getContainer(info.Id).start();
      (0, _utils.progressDone)();
      this.dropCache();
    }
  }

  async shutdownContainers(defs, downTo) {
    for (let i = 0; i < defs.length; i += 1) {
      await this.shutdownContainer(defs[i], downTo);
    }
  }

  async startupContainers(defs, upTo) {
    for (let i = 0; i < defs.length; i += 1) {
      await this.startupContainer(defs[i], upTo);
    }
  }

  async ensureRunning(def) {
    await this.startupContainer(def, ContainerStatus.running);
    const info = await this.findContainerInfo(def.containerName);
    return this.client.getContainer(info && info.Id || def.containerName);
  }

  static hasName(container, name) {
    const nameToFind = `/${name}`.toLowerCase();
    return !!(container.Names || []).find(n => n.toLowerCase() === nameToFind);
  }

  static imageTitle(info) {
    return DevDocker.imageNames(info)[0] || info.Id;
  }

  static containerTitle(info) {
    return info.Names.map(name => name.startsWith('/') ? name.substr(1) : name).join(';');
  } // if match specified with tag compare exactly
  // if match specified without tag compare untagged names


  static imageNameMatched(imageName, match) {
    imageName = imageName.toLowerCase();
    match = match.toLowerCase();
    const matchParts = match.split(':');

    if (matchParts.length > 1) {
      return imageName === match;
    }

    const imageParts = imageName.split(':');
    return imageParts[0] === matchParts[0];
  }

  static imageNames(info) {
    return [...(info.RepoTags || []), ...(info.RepoDigests || []).map(digest => {
      return digest.split('@').join(':');
    })];
  }

  static imageHasMatchedName(info, match) {
    return !!DevDocker.imageNames(info).find(name => this.imageNameMatched(name, match));
  }

  static isRunning(info) {
    return !!info && info.State.toLowerCase() === 'running';
  }

  static containersImageMatched(info, match) {
    return this.imageNameMatched(info.Image, match);
  }

}

exports.DevDocker = DevDocker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9kb2NrZXIuanMiXSwibmFtZXMiOlsiQ29udGFpbmVyU3RhdHVzIiwibWlzc2luZyIsImNyZWF0ZWQiLCJydW5uaW5nIiwiRGV2RG9ja2VyIiwiY29uc3RydWN0b3IiLCJjbGllbnQiLCJEb2NrZXIiLCJvblN0YXJ0dXBJbWFnZXMiLCJvbkJlZm9yZVB1bGwiLCJfb25TdGFydHVwSW1hZ2VzUGFzc2VkIiwiX2ltYWdlcyIsIl9jb250YWluZXJzIiwiZHJvcENhY2hlIiwiZ2V0SW1hZ2VJbmZvcyIsImltYWdlcyIsImxpc3RJbWFnZXMiLCJhbGwiLCJnZXRDb250YWluZXJJbmZvcyIsImxpc3RDb250YWluZXJzIiwibnVtZXJpY1ZlcnNpb24iLCJ2ZXJzaW9uIiwiVmVyc2lvbiIsInJlbW92ZUltYWdlcyIsIm5hbWVNYXRjaGVzIiwiY29udGFpbmVyc09ubHkiLCJjb250YWluZXJJbmZvcyIsImZpbHRlciIsImluZm8iLCJmaW5kIiwibWF0Y2giLCJjb250YWluZXJzSW1hZ2VNYXRjaGVkIiwiaSIsImxlbmd0aCIsImNvbnRhaW5lclRpdGxlIiwiY29udGFpbmVyIiwiZ2V0Q29udGFpbmVyIiwiSWQiLCJpc1J1bm5pbmciLCJzdG9wIiwicmVtb3ZlIiwiaW1hZ2VJbmZvcyIsImltYWdlSGFzTWF0Y2hlZE5hbWUiLCJpbWFnZVRpdGxlIiwiaW1hZ2UiLCJnZXRJbWFnZSIsInB1bGwiLCJyZXBvVGFnIiwidGl0bGUiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImVyciIsInN0cmVhbSIsImxhc3RSZXBvcnRUaW1lIiwiRGF0ZSIsIm5vdyIsIm1vZGVtIiwiZm9sbG93UHJvZ3Jlc3MiLCJvbkZpbmlzaGVkIiwib25Qcm9ncmVzcyIsIm91dHB1dCIsImV2ZW50IiwicHJvZ3Jlc3MiLCJmaW5kSW1hZ2VJbmZvIiwibmFtZSIsIngiLCJmaW5kQ29udGFpbmVySW5mbyIsImhhc05hbWUiLCJzaHV0ZG93bkNvbnRhaW5lciIsImRlZiIsImRvd25UbyIsImNvbnRhaW5lck5hbWUiLCJlbnN1cmVJbWFnZSIsInJlcXVpcmVkSW1hZ2UiLCJzdGFydHVwQ29udGFpbmVyIiwidXBUbyIsImNyZWF0ZUNvbnRhaW5lciIsInN0YXJ0Iiwic2h1dGRvd25Db250YWluZXJzIiwiZGVmcyIsInN0YXJ0dXBDb250YWluZXJzIiwiZW5zdXJlUnVubmluZyIsIm5hbWVUb0ZpbmQiLCJ0b0xvd2VyQ2FzZSIsIk5hbWVzIiwibiIsImltYWdlTmFtZXMiLCJtYXAiLCJzdGFydHNXaXRoIiwic3Vic3RyIiwiam9pbiIsImltYWdlTmFtZU1hdGNoZWQiLCJpbWFnZU5hbWUiLCJtYXRjaFBhcnRzIiwic3BsaXQiLCJpbWFnZVBhcnRzIiwiUmVwb1RhZ3MiLCJSZXBvRGlnZXN0cyIsImRpZ2VzdCIsIlN0YXRlIiwiSW1hZ2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFlQTs7QUFFQTs7Ozs7O0FBNEdPLE1BQU1BLGVBQWUsR0FBRztBQUMzQkMsRUFBQUEsT0FBTyxFQUFFLENBRGtCO0FBRTNCQyxFQUFBQSxPQUFPLEVBQUUsQ0FGa0I7QUFHM0JDLEVBQUFBLE9BQU8sRUFBRTtBQUhrQixDQUF4Qjs7O0FBZ0JQLE1BQU1DLFNBQU4sQ0FBZ0I7QUFRWkMsRUFBQUEsV0FBVyxHQUFHO0FBQUE7O0FBQUE7O0FBQUE7O0FBQUE7O0FBQUE7O0FBQUE7O0FBQ1YsU0FBS0MsTUFBTCxHQUFjLElBQUlDLGtCQUFKLEVBQWQ7QUFDQSxTQUFLQyxlQUFMLEdBQXVCLElBQXZCO0FBQ0EsU0FBS0MsWUFBTCxHQUFvQixJQUFwQjtBQUNBLFNBQUtDLHNCQUFMLEdBQThCLEtBQTlCO0FBQ0EsU0FBS0MsT0FBTCxHQUFlLElBQWY7QUFDQSxTQUFLQyxXQUFMLEdBQW1CLElBQW5CO0FBQ0g7O0FBRURDLEVBQUFBLFNBQVMsR0FBRztBQUNSLFNBQUtGLE9BQUwsR0FBZSxJQUFmO0FBQ0EsU0FBS0MsV0FBTCxHQUFtQixJQUFuQjtBQUNIOztBQUVELFFBQU1FLGFBQU4sR0FBNkM7QUFD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QUNILElBQUlBLElBQUksQ0FBQ3FFLFFBQUwsSUFBaUIsRUFBckIsQ0FERyxFQUVILEdBQUcsQ0FBQ3JFLElBQUksQ0FBQ3NFLFdBQUwsSUFBb0IsRUFBckIsRUFBeUJWLEdBQXpCLENBQThCVyxNQUFELElBQVk7QUFDeEMsYUFBT0EsTUFBTSxDQUFDSixLQUFQLENBQWEsR0FBYixFQUFrQkosSUFBbEIsQ0FBdUIsR0FBdkIsQ0FBUDtBQUNILEtBRkUsQ0FGQSxDQUFQO0FBTUg7O0FBRUQsU0FBT2pELG1CQUFQLENBQTJCZCxJQUEzQixFQUE2Q0UsS0FBN0MsRUFBcUU7QUFDakUsV0FBTyxDQUFDLENBQUMxQixTQUFTLENBQUNtRixVQUFWLENBQXFCM0QsSUFBckIsRUFBMkJDLElBQTNCLENBQWdDb0MsSUFBSSxJQUFJLEtBQUsyQixnQkFBTCxDQUFzQjNCLElBQXRCLEVBQTRCbkMsS0FBNUIsQ0FBeEMsQ0FBVDtBQUNIOztBQUVELFNBQU9RLFNBQVAsQ0FBaUJWLElBQWpCLEVBQWlEO0FBQzdDLFdBQU8sQ0FBQyxDQUFDQSxJQUFGLElBQVVBLElBQUksQ0FBQ3dFLEtBQUwsQ0FBV2hCLFdBQVgsT0FBNkIsU0FBOUM7QUFDSDs7QUFFRCxTQUFPckQsc0JBQVAsQ0FBOEJILElBQTlCLEVBQW9ERSxLQUFwRCxFQUE0RTtBQUN4RSxXQUFPLEtBQUs4RCxnQkFBTCxDQUFzQmhFLElBQUksQ0FBQ3lFLEtBQTNCLEVBQWtDdkUsS0FBbEMsQ0FBUDtBQUNIOztBQWpPVyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOC0yMDIwIFRPTiBERVYgU09MVVRJT05TIExURC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcbiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZVxuICogTGljZW5zZSBhdDogaHR0cHM6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqXG4gKi9cbi8vIEBmbG93XG5pbXBvcnQgRG9ja2VyIGZyb20gJ2RvY2tlcm9kZSc7XG5cbmltcG9ydCB7cHJvZ3Jlc3MsIHByb2dyZXNzRG9uZSwgcHJvZ3Jlc3NMaW5lLCB2ZXJzaW9uVG9OdW1iZXJ9IGZyb20gXCIuL3V0aWxzXCI7XG5cbmV4cG9ydCB0eXBlIERJbWFnZUluZm8gPSB7XG4gICAgSWQ6IHN0cmluZyxcbiAgICBSZXBvVGFnczogc3RyaW5nW10sXG4gICAgUmVwb0RpZ2VzdHM6IHN0cmluZ1tdLFxufVxuXG5leHBvcnQgdHlwZSBETW91bnQgPSB7XG4gICAgRGVzdGluYXRpb246IHN0cmluZyxcbiAgICBTb3VyY2U6IHN0cmluZyxcbiAgICBUeXBlOiAnYmluZCcgfCAndm9sdW1lJyB8ICd0bXBmcycsXG59XG5cbmV4cG9ydCB0eXBlIERDb250YWluZXJJbmZvID0ge1xuICAgIElkOiBzdHJpbmcsXG4gICAgTmFtZXM6IHN0cmluZ1tdLFxuICAgIEltYWdlOiBzdHJpbmcsXG4gICAgSW1hZ2VJRDogc3RyaW5nLFxuICAgIFN0YXRlOiBzdHJpbmcsXG4gICAgTW91bnRzOiBETW91bnRbXSxcbn1cblxuZXhwb3J0IHR5cGUgRENvbnRhaW5lckV4ZWNPcHRpb25zID0ge1xuICAgIEF0dGFjaFN0ZGluPzogYm9vbGVhbixcbiAgICBBdHRhY2hTdGRvdXQ/OiBib29sZWFuLFxuICAgIEF0dGFjaFN0ZGVycj86IGJvb2xlYW4sXG4gICAgRGV0YWNoS2V5cz86IHN0cmluZyxcbiAgICBUdHk/OiBib29sZWFuLFxuICAgIEVudj86IHN0cmluZyxcbiAgICBDbWQ/OiBzdHJpbmdbXSxcbiAgICBQcml2aWxlZ2VkPzogYm9vbGVhbixcbiAgICBVc2VyPzogc3RyaW5nLFxuICAgIFdvcmtpbmdEaXI/OiBzdHJpbmcsXG59XG5cbmV4cG9ydCB0eXBlIERvY2tlck1vZGVtID0ge1xuICAgIGZvbGxvd1Byb2dyZXNzKFxuICAgICAgICBzdHJlYW06IGFueSxcbiAgICAgICAgb25GaW5pc2hlZDogKGVycjogYW55LCBvdXRwdXQ6IGFueSkgPT4gdm9pZCxcbiAgICAgICAgb25Qcm9ncmVzczogKGV2ZW50OiBhbnkpID0+IHZvaWQsXG4gICAgKTogdm9pZCxcblxuICAgIGRlbXV4U3RyZWFtKFxuICAgICAgICBzdHJlYW06IGFueSxcbiAgICAgICAgc3Rkb3V0OiBhbnksXG4gICAgICAgIHN0ZGVycjogYW55LFxuICAgICk6IHZvaWQsXG59XG5cbmV4cG9ydCB0eXBlIERvY2tlckNvbnRhaW5lciA9IHtcbiAgICBpZDogc3RyaW5nLFxuICAgIG1vZGVtOiBEb2NrZXJNb2RlbSxcbiAgICBzdGFydCgpOiBQcm9taXNlPHZvaWQ+LFxuICAgIGV4ZWMob3B0aW9uczogRENvbnRhaW5lckV4ZWNPcHRpb25zLCBjYWxsYmFjazogYW55KTogdm9pZCxcbiAgICBzdG9wKCk6IFByb21pc2U8dm9pZD4sXG4gICAgcmVtb3ZlKCk6IFByb21pc2U8dm9pZD4sXG59XG5cbmV4cG9ydCB0eXBlIERvY2tlckltYWdlID0ge1xuICAgIHJlbW92ZSgpOiBQcm9taXNlPHZvaWQ+LFxufVxuXG5leHBvcnQgdHlwZSBEUG9ydEJpbmRpbmdzID0ge1xuICAgIFtzdHJpbmddOiB7IEhvc3RJcDogc3RyaW5nLCBIb3N0UG9ydDogc3RyaW5nIH1bXVxufTtcblxuZXhwb3J0IHR5cGUgRENyZWF0ZUNvbnRhaW5lck9wdGlvbnMgPSB7XG4gICAgbmFtZT86IHN0cmluZyxcbiAgICBJbWFnZTogc3RyaW5nLFxuICAgIEludGVyYWN0aXZlPzogYm9vbGVhbixcbiAgICBUdHk/OiBib29sZWFuLFxuICAgIFVzZXI/OiBzdHJpbmcsXG4gICAgRW50cnlwb2ludD86IHN0cmluZ1tdLFxuICAgIEVudjogc3RyaW5nW10sXG4gICAgSG9zdENvbmZpZz86IHtcbiAgICAgICAgTW91bnRzPzogRE1vdW50W10sXG4gICAgfSxcbiAgICBFeHBvc2VkUG9ydHM/OiB7XG4gICAgICAgIFtzdHJpbmddOiB7fSxcbiAgICB9LFxuICAgIEhvc3RDb25maWc/OiB7XG4gICAgICAgIFBvcnRCaW5kaW5ncz86IERQb3J0QmluZGluZ3MsXG4gICAgfVxufVxuXG5leHBvcnQgdHlwZSBEVmVyc2lvbiA9IHtcbiAgICBWZXJzaW9uOiBzdHJpbmcsXG59XG5cbmV4cG9ydCB0eXBlIERvY2tlckNsaWVudCA9IHtcbiAgICB2ZXJzaW9uKCk6IFByb21pc2U8RFZlcnNpb24+LFxuXG4gICAgbGlzdENvbnRhaW5lcnMob3B0aW9ucz86IHsgYWxsPzogdHJ1ZSB9KTogUHJvbWlzZTxEQ29udGFpbmVySW5mb1tdPixcblxuICAgIGxpc3RJbWFnZXMob3B0aW9ucz86IHsgYWxsPzogdHJ1ZSB9KTogUHJvbWlzZTxESW1hZ2VJbmZvW10+LFxuXG4gICAgZ2V0Q29udGFpbmVyKGlkOiBzdHJpbmcpOiBEb2NrZXJDb250YWluZXIsXG5cbiAgICBnZXRJbWFnZShuYW1lOiBzdHJpbmcpOiBEb2NrZXJJbWFnZSxcblxuICAgIGNyZWF0ZUNvbnRhaW5lcihvcHRpb25zOiBEQ3JlYXRlQ29udGFpbmVyT3B0aW9ucyk6IFByb21pc2U8RG9ja2VyQ29udGFpbmVyPixcblxuICAgIHB1bGwocmVwb1RhZzogc3RyaW5nLCBhdXRoOiBhbnksIChlcnI6IGFueSwgc3RyZWFtOiBhbnkpID0+IHZvaWQpOiB2b2lkLFxuXG4gICAgbW9kZW06IERvY2tlck1vZGVtLFxufVxuXG5leHBvcnQgY29uc3QgQ29udGFpbmVyU3RhdHVzID0ge1xuICAgIG1pc3Npbmc6IDAsXG4gICAgY3JlYXRlZDogMSxcbiAgICBydW5uaW5nOiAyLFxufTtcblxuZXhwb3J0IHR5cGUgQ29udGFpbmVyU3RhdHVzVHlwZSA9IDAgfCAxIHwgMjtcblxuZXhwb3J0IGludGVyZmFjZSBDb250YWluZXJEZWYge1xuICAgIHJlcXVpcmVkSW1hZ2U6IHN0cmluZyxcbiAgICBjb250YWluZXJOYW1lOiBzdHJpbmcsXG5cbiAgICBjcmVhdGVDb250YWluZXIoZG9ja2VyOiBEZXZEb2NrZXIpOiBQcm9taXNlPERvY2tlckNvbnRhaW5lcj5cbn1cblxuXG5jbGFzcyBEZXZEb2NrZXIge1xuICAgIGNsaWVudDogRG9ja2VyQ2xpZW50O1xuICAgIF9pbWFnZXM6ID8oREltYWdlSW5mb1tdKTtcbiAgICBfY29udGFpbmVyczogPyhEQ29udGFpbmVySW5mb1tdKTtcbiAgICBfb25TdGFydHVwSW1hZ2VzUGFzc2VkOiBib29sZWFuO1xuICAgIG9uU3RhcnR1cEltYWdlczogPygoaW1hZ2VzOiBESW1hZ2VJbmZvW10pID0+IHZvaWQpO1xuICAgIG9uQmVmb3JlUHVsbDogPygocmVwb1RhZzogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+KTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLmNsaWVudCA9IG5ldyBEb2NrZXIoKTtcbiAgICAgICAgdGhpcy5vblN0YXJ0dXBJbWFnZXMgPSBudWxsO1xuICAgICAgICB0aGlzLm9uQmVmb3JlUHVsbCA9IG51bGw7XG4gICAgICAgIHRoaXMuX29uU3RhcnR1cEltYWdlc1Bhc3NlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9pbWFnZXMgPSBudWxsO1xuICAgICAgICB0aGlzLl9jb250YWluZXJzID0gbnVsbDtcbiAgICB9XG5cbiAgICBkcm9wQ2FjaGUoKSB7XG4gICAgICAgIHRoaXMuX2ltYWdlcyA9IG51bGw7XG4gICAgICAgIHRoaXMuX2NvbnRhaW5lcnMgPSBudWxsO1xuICAgIH1cblxuICAgIGFzeW5jIGdldEltYWdlSW5mb3MoKTogUHJvbWlzZTxESW1hZ2VJbmZvW10+IHtcbiAgICAgICAgaWYgKCF0aGlzLl9pbWFnZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IGltYWdlcyA9IGF3YWl0IHRoaXMuY2xpZW50Lmxpc3RJbWFnZXMoe2FsbDogdHJ1ZX0pO1xuICAgICAgICAgICAgdGhpcy5faW1hZ2VzID0gaW1hZ2VzO1xuICAgICAgICAgICAgaWYgKCF0aGlzLl9vblN0YXJ0dXBJbWFnZXNQYXNzZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9vblN0YXJ0dXBJbWFnZXNQYXNzZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLm9uU3RhcnR1cEltYWdlcykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uU3RhcnR1cEltYWdlcyhpbWFnZXMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX2ltYWdlcyA9IGltYWdlcztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5faW1hZ2VzIHx8IFtdO1xuICAgIH1cblxuICAgIGFzeW5jIGdldENvbnRhaW5lckluZm9zKCk6IFByb21pc2U8RENvbnRhaW5lckluZm9bXT4ge1xuICAgICAgICBpZiAoIXRoaXMuX2NvbnRhaW5lcnMpIHtcbiAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lcnMgPSBhd2FpdCB0aGlzLmNsaWVudC5saXN0Q29udGFpbmVycyh7YWxsOiB0cnVlfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnRhaW5lcnMgfHwgW107XG4gICAgfVxuXG4gICAgYXN5bmMgbnVtZXJpY1ZlcnNpb24oKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAgICAgY29uc3QgdmVyc2lvbjogRFZlcnNpb24gPSBhd2FpdCB0aGlzLmNsaWVudC52ZXJzaW9uKCk7XG4gICAgICAgIHJldHVybiB2ZXJzaW9uVG9OdW1iZXIodmVyc2lvbi5WZXJzaW9uKTtcbiAgICB9XG5cbiAgICBhc3luYyByZW1vdmVJbWFnZXMobmFtZU1hdGNoZXM6IHN0cmluZ1tdLCBjb250YWluZXJzT25seTogYm9vbGVhbik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICAvLyBTdG9wIGFuZCByZW1vdmUgY29udGFpbmVycyB0aGF0IGJlbG9uZ3MgdG8gaW1hZ2VzXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lckluZm9zID0gKGF3YWl0IHRoaXMuZ2V0Q29udGFpbmVySW5mb3MoKSkuZmlsdGVyKChpbmZvKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbmFtZU1hdGNoZXMuZmluZChtYXRjaCA9PiBEZXZEb2NrZXIuY29udGFpbmVyc0ltYWdlTWF0Y2hlZChpbmZvLCBtYXRjaCkpO1xuICAgICAgICB9KTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb250YWluZXJJbmZvcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICAgICAgY29uc3QgaW5mbyA9IGNvbnRhaW5lckluZm9zW2ldO1xuICAgICAgICAgICAgcHJvZ3Jlc3MoYFJlbW92aW5nIGNvbnRhaW5lciBbJHtEZXZEb2NrZXIuY29udGFpbmVyVGl0bGUoaW5mbyl9XWApO1xuICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jbGllbnQuZ2V0Q29udGFpbmVyKGluZm8uSWQpO1xuICAgICAgICAgICAgaWYgKERldkRvY2tlci5pc1J1bm5pbmcoaW5mbykpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBjb250YWluZXIuc3RvcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXdhaXQgY29udGFpbmVyLnJlbW92ZSgpO1xuICAgICAgICAgICAgcHJvZ3Jlc3NEb25lKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYoY29udGFpbmVyc09ubHkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAvLyBSZW1vdmUgaW1hZ2VzXG4gICAgICAgIGNvbnN0IGltYWdlSW5mb3MgPSAoYXdhaXQgdGhpcy5nZXRJbWFnZUluZm9zKCkpLmZpbHRlcigoaW5mbykgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5hbWVNYXRjaGVzLmZpbmQobWF0Y2ggPT4gRGV2RG9ja2VyLmltYWdlSGFzTWF0Y2hlZE5hbWUoaW5mbywgbWF0Y2gpKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW1hZ2VJbmZvcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICAgICAgY29uc3QgaW5mbyA9IGltYWdlSW5mb3NbaV07XG4gICAgICAgICAgICBwcm9ncmVzcyhgUmVtb3ZpbmcgaW1hZ2UgWyR7RGV2RG9ja2VyLmltYWdlVGl0bGUoaW5mbyl9XWApO1xuICAgICAgICAgICAgY29uc3QgaW1hZ2UgPSB0aGlzLmNsaWVudC5nZXRJbWFnZShpbmZvLklkKTtcbiAgICAgICAgICAgIGF3YWl0IGltYWdlLnJlbW92ZSgpO1xuICAgICAgICAgICAgcHJvZ3Jlc3NEb25lKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBwdWxsKHJlcG9UYWc6IHN0cmluZyk6IFByb21pc2U8RG9ja2VySW1hZ2U+IHtcbiAgICAgICAgaWYgKHRoaXMub25CZWZvcmVQdWxsKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLm9uQmVmb3JlUHVsbChyZXBvVGFnKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjbGllbnQgPSB0aGlzLmNsaWVudDtcbiAgICAgICAgY29uc3QgdGl0bGUgPSBgUHVsbGluZyBbJHtyZXBvVGFnfV1gO1xuICAgICAgICBwcm9ncmVzcyh0aXRsZSk7XG4gICAgICAgIGNvbnN0IGltYWdlID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY2xpZW50LnB1bGwocmVwb1RhZywge30sIGZ1bmN0aW9uIChlcnIsIHN0cmVhbSkge1xuICAgICAgICAgICAgICAgIGlmICghc3RyZWFtKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxldCBsYXN0UmVwb3J0VGltZSA9IERhdGUubm93KCk7XG4gICAgICAgICAgICAgICAgY2xpZW50Lm1vZGVtLmZvbGxvd1Byb2dyZXNzKHN0cmVhbSwgb25GaW5pc2hlZCwgb25Qcm9ncmVzcyk7XG5cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBvbkZpbmlzaGVkKGVyciwgb3V0cHV0KSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUob3V0cHV0KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBvblByb2dyZXNzKGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIHByb2dyZXNzTGluZShgJHt0aXRsZX0uLi4gJHtldmVudC5wcm9ncmVzcyB8fCAnJ31gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHByb2dyZXNzKHRpdGxlKTtcbiAgICAgICAgcHJvZ3Jlc3NEb25lKCk7XG4gICAgICAgIHJldHVybiBpbWFnZTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kSW1hZ2VJbmZvKG5hbWU6IHN0cmluZyk6IFByb21pc2U8P0RJbWFnZUluZm8+IHtcbiAgICAgICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldEltYWdlSW5mb3MoKSkuZmluZCh4ID0+IERldkRvY2tlci5pbWFnZUhhc01hdGNoZWROYW1lKHgsIG5hbWUpKSB8fCBudWxsO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRDb250YWluZXJJbmZvKG5hbWU6IHN0cmluZyk6IFByb21pc2U8P0RDb250YWluZXJJbmZvPiB7XG4gICAgICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXRDb250YWluZXJJbmZvcygpKS5maW5kKHggPT4gRGV2RG9ja2VyLmhhc05hbWUoeCwgbmFtZSkpIHx8IG51bGw7XG4gICAgfVxuXG4gICAgYXN5bmMgc2h1dGRvd25Db250YWluZXIoZGVmOiBDb250YWluZXJEZWYsIGRvd25UbzogQ29udGFpbmVyU3RhdHVzVHlwZSkge1xuICAgICAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5maW5kQ29udGFpbmVySW5mbyhkZWYuY29udGFpbmVyTmFtZSk7XG4gICAgICAgIGlmICghaW5mbykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkb3duVG8gPCBDb250YWluZXJTdGF0dXMucnVubmluZyAmJiBEZXZEb2NrZXIuaXNSdW5uaW5nKGluZm8pKSB7XG4gICAgICAgICAgICBwcm9ncmVzcyhgU3RvcHBpbmcgWyR7ZGVmLmNvbnRhaW5lck5hbWV9XWApO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5jbGllbnQuZ2V0Q29udGFpbmVyKGluZm8uSWQpLnN0b3AoKTtcbiAgICAgICAgICAgIHByb2dyZXNzRG9uZSgpO1xuICAgICAgICAgICAgdGhpcy5kcm9wQ2FjaGUoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZG93blRvIDwgQ29udGFpbmVyU3RhdHVzLmNyZWF0ZWQpIHtcbiAgICAgICAgICAgIHByb2dyZXNzKGBSZW1vdmluZyBbJHtkZWYuY29udGFpbmVyTmFtZX1dYCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNsaWVudC5nZXRDb250YWluZXIoaW5mby5JZCkucmVtb3ZlKCk7XG4gICAgICAgICAgICBwcm9ncmVzc0RvbmUoKTtcbiAgICAgICAgICAgIHRoaXMuZHJvcENhY2hlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBlbnN1cmVJbWFnZShyZXF1aXJlZEltYWdlOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCEoYXdhaXQgdGhpcy5maW5kSW1hZ2VJbmZvKHJlcXVpcmVkSW1hZ2UpKSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5wdWxsKHJlcXVpcmVkSW1hZ2UpO1xuICAgICAgICAgICAgdGhpcy5kcm9wQ2FjaGUoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIHN0YXJ0dXBDb250YWluZXIoZGVmOiBDb250YWluZXJEZWYsIHVwVG86IENvbnRhaW5lclN0YXR1c1R5cGUpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5lbnN1cmVJbWFnZShkZWYucmVxdWlyZWRJbWFnZSk7XG4gICAgICAgIGxldCBpbmZvOiA/RENvbnRhaW5lckluZm8gPSBhd2FpdCB0aGlzLmZpbmRDb250YWluZXJJbmZvKGRlZi5jb250YWluZXJOYW1lKTtcbiAgICAgICAgaWYgKHVwVG8gPj0gQ29udGFpbmVyU3RhdHVzLmNyZWF0ZWQgJiYgIWluZm8pIHtcbiAgICAgICAgICAgIHByb2dyZXNzKGBDcmVhdGluZyAke2RlZi5jb250YWluZXJOYW1lfWApO1xuICAgICAgICAgICAgYXdhaXQgZGVmLmNyZWF0ZUNvbnRhaW5lcih0aGlzKTtcbiAgICAgICAgICAgIHByb2dyZXNzRG9uZSgpO1xuICAgICAgICAgICAgdGhpcy5kcm9wQ2FjaGUoKTtcbiAgICAgICAgICAgIGluZm8gPSBhd2FpdCB0aGlzLmZpbmRDb250YWluZXJJbmZvKGRlZi5jb250YWluZXJOYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodXBUbyA+PSBDb250YWluZXJTdGF0dXMucnVubmluZyAmJiBpbmZvICYmICFEZXZEb2NrZXIuaXNSdW5uaW5nKGluZm8pKSB7XG4gICAgICAgICAgICBwcm9ncmVzcyhgU3RhcnRpbmcgJHtkZWYuY29udGFpbmVyTmFtZX1gKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2xpZW50LmdldENvbnRhaW5lcihpbmZvLklkKS5zdGFydCgpO1xuICAgICAgICAgICAgcHJvZ3Jlc3NEb25lKCk7XG4gICAgICAgICAgICB0aGlzLmRyb3BDYWNoZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgc2h1dGRvd25Db250YWluZXJzKGRlZnM6ICRSZWFkT25seUFycmF5PENvbnRhaW5lckRlZj4sIGRvd25UbzogQ29udGFpbmVyU3RhdHVzVHlwZSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRlZnMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2h1dGRvd25Db250YWluZXIoZGVmc1tpXSwgZG93blRvKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIHN0YXJ0dXBDb250YWluZXJzKGRlZnM6ICRSZWFkT25seUFycmF5PENvbnRhaW5lckRlZj4sIHVwVG86IENvbnRhaW5lclN0YXR1c1R5cGUpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZWZzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0dXBDb250YWluZXIoZGVmc1tpXSwgdXBUbyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBlbnN1cmVSdW5uaW5nKGRlZjogQ29udGFpbmVyRGVmKTogUHJvbWlzZTxEb2NrZXJDb250YWluZXI+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5zdGFydHVwQ29udGFpbmVyKGRlZiwgQ29udGFpbmVyU3RhdHVzLnJ1bm5pbmcpO1xuICAgICAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5maW5kQ29udGFpbmVySW5mbyhkZWYuY29udGFpbmVyTmFtZSk7XG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5nZXRDb250YWluZXIoKGluZm8gJiYgaW5mby5JZCkgfHwgZGVmLmNvbnRhaW5lck5hbWUpO1xuICAgIH1cblxuICAgIHN0YXRpYyBoYXNOYW1lKGNvbnRhaW5lcjogRENvbnRhaW5lckluZm8sIG5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBuYW1lVG9GaW5kID0gYC8ke25hbWV9YC50b0xvd2VyQ2FzZSgpO1xuICAgICAgICByZXR1cm4gISEoY29udGFpbmVyLk5hbWVzIHx8IFtdKS5maW5kKG4gPT4gbi50b0xvd2VyQ2FzZSgpID09PSBuYW1lVG9GaW5kKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgaW1hZ2VUaXRsZShpbmZvOiBESW1hZ2VJbmZvKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIERldkRvY2tlci5pbWFnZU5hbWVzKGluZm8pWzBdIHx8IGluZm8uSWQ7XG4gICAgfVxuXG4gICAgc3RhdGljIGNvbnRhaW5lclRpdGxlKGluZm86IERDb250YWluZXJJbmZvKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGluZm8uTmFtZXMubWFwKG5hbWUgPT4gbmFtZS5zdGFydHNXaXRoKCcvJykgPyBuYW1lLnN1YnN0cigxKSA6IG5hbWUpLmpvaW4oJzsnKTtcbiAgICB9XG5cbiAgICAvLyBpZiBtYXRjaCBzcGVjaWZpZWQgd2l0aCB0YWcgY29tcGFyZSBleGFjdGx5XG4gICAgLy8gaWYgbWF0Y2ggc3BlY2lmaWVkIHdpdGhvdXQgdGFnIGNvbXBhcmUgdW50YWdnZWQgbmFtZXNcbiAgICBzdGF0aWMgaW1hZ2VOYW1lTWF0Y2hlZChpbWFnZU5hbWU6IHN0cmluZywgbWF0Y2g6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBpbWFnZU5hbWUgPSBpbWFnZU5hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgbWF0Y2ggPSBtYXRjaC50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBjb25zdCBtYXRjaFBhcnRzID0gbWF0Y2guc3BsaXQoJzonKTtcbiAgICAgICAgaWYgKG1hdGNoUGFydHMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgcmV0dXJuIGltYWdlTmFtZSA9PT0gbWF0Y2g7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgaW1hZ2VQYXJ0cyA9IGltYWdlTmFtZS5zcGxpdCgnOicpO1xuICAgICAgICByZXR1cm4gaW1hZ2VQYXJ0c1swXSA9PT0gbWF0Y2hQYXJ0c1swXTtcbiAgICB9XG5cbiAgICBzdGF0aWMgaW1hZ2VOYW1lcyhpbmZvOiBESW1hZ2VJbmZvKTogc3RyaW5nW10ge1xuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgLi4uKGluZm8uUmVwb1RhZ3MgfHwgW10pLFxuICAgICAgICAgICAgLi4uKGluZm8uUmVwb0RpZ2VzdHMgfHwgW10pLm1hcCgoZGlnZXN0KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRpZ2VzdC5zcGxpdCgnQCcpLmpvaW4oJzonKTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICBdO1xuICAgIH1cblxuICAgIHN0YXRpYyBpbWFnZUhhc01hdGNoZWROYW1lKGluZm86IERJbWFnZUluZm8sIG1hdGNoOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhRGV2RG9ja2VyLmltYWdlTmFtZXMoaW5mbykuZmluZChuYW1lID0+IHRoaXMuaW1hZ2VOYW1lTWF0Y2hlZChuYW1lLCBtYXRjaCkpO1xuICAgIH1cblxuICAgIHN0YXRpYyBpc1J1bm5pbmcoaW5mbzogP0RDb250YWluZXJJbmZvKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhIWluZm8gJiYgaW5mby5TdGF0ZS50b0xvd2VyQ2FzZSgpID09PSAncnVubmluZyc7XG4gICAgfVxuXG4gICAgc3RhdGljIGNvbnRhaW5lcnNJbWFnZU1hdGNoZWQoaW5mbzogRENvbnRhaW5lckluZm8sIG1hdGNoOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW1hZ2VOYW1lTWF0Y2hlZChpbmZvLkltYWdlLCBtYXRjaCk7XG4gICAgfVxufVxuXG5cbmV4cG9ydCB7XG4gICAgRGV2RG9ja2VyLFxufVxuIl19