"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.showUsage = showUsage;
exports.run = run;
exports.versionToNumber = versionToNumber;
exports.forceRmDir = forceRmDir;
exports.ensureCleanDirectory = ensureCleanDirectory;
exports.bindPathJoinTo = bindPathJoinTo;
exports.inputLine = inputLine;
exports.breakWords = breakWords;
exports.httpsGetJson = httpsGetJson;
exports.toIdentifier = toIdentifier;
exports.progress = progress;
exports.progressLine = progressLine;
exports.progressDone = progressDone;
exports.parseFileArg = parseFileArg;
exports.tonlabsHomePath = exports.userIdentifier = exports.version = void 0;

var _texts = require("./texts");

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at: https://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 *
 */
const fs = require('fs');

const os = require('os');

const path = require('path');

const {
  spawn
} = require('child_process');

const version = JSON.parse(fs.readFileSync(path.join(__dirname, '..', '..', 'package.json')).toString()).version;
exports.version = version;

function showUsage(usage) {
  console.log(_texts.texts.usageHeader(version));
  console.log(usage);
}

const spawnEnv = { ...process.env
};

function run(name, ...args) {
  return new Promise((resolve, reject) => {
    try {
      const spawned = spawn(name, args, {
        env: spawnEnv
      });
      const errors = [];
      const output = [];
      spawned.stdout.on('data', function (data) {
        output.push(data.toString());
      });
      spawned.stderr.on('data', data => {
        errors.push(data.toString());
      });
      spawned.on('error', err => {
        reject(err);
      });
      spawned.on('close', code => {
        if (code === 0) {
          resolve(output.join(''));
        } else {
          reject(errors.join(''));
        }
      });
    } catch (error) {
      reject(error);
    }
  });
}

function versionToNumber(s) {
  const parts = `${s || ''}`.split('.').map(x => Number.parseInt(x)).slice(0, 3);

  while (parts.length < 3) {
    parts.push(0);
  }

  return parts[0] * 1000000 + parts[1] * 1000 + parts[2];
}

function forceRmDir(dir) {
  fs.readdirSync(dir).forEach(item => {
    const itemPath = path.join(dir, item);
    const stat = fs.statSync(itemPath);

    if (itemPath === "." || itemPath === "..") {} else if (stat.isDirectory()) {
      forceRmDir(itemPath);
    } else {
      fs.unlinkSync(itemPath);
    }
  });
  fs.rmdirSync(dir);
}

function ensureCleanDirectory(path) {
  if (fs.existsSync(path)) {
    forceRmDir(path);
  }

  fs.mkdirSync(path, {
    recursive: true
  });
}

function join(base, item, separator) {
  const baseWithSep = base.endsWith(separator);
  const itemWithSep = item.startsWith(separator);

  if (baseWithSep && itemWithSep) {
    return `${base}${item.substr(1)}`;
  }

  if (!baseWithSep && !itemWithSep) {
    return `${base}/${item}`;
  }

  return `${base}${item}`;
}

function bindPathJoinTo(base, separator) {
  if (separator) {
    const sep = separator;
    return (...items) => {
      let path = base;
      items.forEach(x => path = join(path, x, sep));
      return path;
    };
  }

  return (...items) => {
    return items.length > 0 ? path.join(base, ...items) : base;
  };
}

function inputLine() {
  return new Promise(resolve => {
    const standard_input = process.stdin;
    standard_input.setEncoding('utf-8');
    standard_input.once('data', function (data) {
      resolve(`${data}`.trim());
    });
  });
}

function breakWords(s) {
  const words = s.split(' ');
  let result = '';
  let line = '';
  words.forEach(w => {
    if (line.length + w.length > 80) {
      if (result !== '') {
        result += '\n';
      }

      result += line;
      line = '';
    }

    if (line !== '') {
      line += ' ';
    }

    line += w;
  });

  if (line !== '') {
    if (result !== '') {
      result += '\n';
    }

    result += line;
  }

  return result;
}

const https = require('https');

function httpsGetJson(url) {
  return new Promise((resolve, reject) => {
    const tryUrl = url => {
      https.get(url, function (res) {
        let body = '';
        res.on('data', function (chunk) {
          body += chunk;
        });
        res.on('end', function () {
          if (res.statusCode === 301) {
            const redirectUrl = res.headers['location'];
            tryUrl(redirectUrl);
            return;
          }

          const response = JSON.parse(body);
          resolve(response);
        });
      }).on('error', error => {
        reject(error);
      });
    };

    tryUrl(url);
  });
}

function toIdentifier(s) {
  let identifier = '';

  for (let i = 0; i < s.length; i += 1) {
    const c = s[i];
    const isLetter = c.toLowerCase() !== c.toUpperCase();
    const isDigit = !isLetter && '0123456789'.includes(c);

    if (isLetter || isDigit) {
      identifier += c;
    }
  }

  return identifier;
}

const userIdentifier = toIdentifier(os.userInfo().username).toLowerCase();
exports.userIdentifier = userIdentifier;
const tonlabsHomePath = bindPathJoinTo(path.join(os.homedir(), '.tonlabs'));
exports.tonlabsHomePath = tonlabsHomePath;
let _progressLine = '';

function progressLine(line) {
  process.stdout.write(`\r${line}`);
  const extra = _progressLine.length - line.length;

  if (extra > 0) {
    process.stdout.write(' '.repeat(extra) + '\b'.repeat(extra));
  }

  _progressLine = line;
}

function progress(info) {
  progressLine(`${info}...`);
}

function progressDone() {
  console.log(' âœ“');
  _progressLine = '';
}

function parseFileArg(fileArg, ext, fileMustExists) {
  if (os.platform() === 'darwin' && fileArg.startsWith('~/')) {
    fileArg = path.join(os.homedir(), fileArg.substr(2));
  }

  const filePath = path.resolve(fileArg);
  const dir = bindPathJoinTo(path.dirname(filePath));
  const base = path.basename(filePath, ext);
  const name = base.includes('.') ? base : `${base}${ext}`;
  const result = {
    dir,
    base,
    name
  };

  if (fileMustExists && !fs.existsSync(result.dir(name))) {
    console.error(_texts.texts.sourceFileNotFound(name));
    process.exit(1);
  }

  return result;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy91dGlscy5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJvcyIsInBhdGgiLCJzcGF3biIsInZlcnNpb24iLCJKU09OIiwicGFyc2UiLCJyZWFkRmlsZVN5bmMiLCJqb2luIiwiX19kaXJuYW1lIiwidG9TdHJpbmciLCJzaG93VXNhZ2UiLCJ1c2FnZSIsImNvbnNvbGUiLCJsb2ciLCJ0ZXh0cyIsInVzYWdlSGVhZGVyIiwic3Bhd25FbnYiLCJwcm9jZXNzIiwiZW52IiwicnVuIiwibmFtZSIsImFyZ3MiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInNwYXduZWQiLCJlcnJvcnMiLCJvdXRwdXQiLCJzdGRvdXQiLCJvbiIsImRhdGEiLCJwdXNoIiwic3RkZXJyIiwiZXJyIiwiY29kZSIsImVycm9yIiwidmVyc2lvblRvTnVtYmVyIiwicyIsInBhcnRzIiwic3BsaXQiLCJtYXAiLCJ4IiwiTnVtYmVyIiwicGFyc2VJbnQiLCJzbGljZSIsImxlbmd0aCIsImZvcmNlUm1EaXIiLCJkaXIiLCJyZWFkZGlyU3luYyIsImZvckVhY2giLCJpdGVtIiwiaXRlbVBhdGgiLCJzdGF0Iiwic3RhdFN5bmMiLCJpc0RpcmVjdG9yeSIsInVubGlua1N5bmMiLCJybWRpclN5bmMiLCJlbnN1cmVDbGVhbkRpcmVjdG9yeSIsImV4aXN0c1N5bmMiLCJta2RpclN5bmMiLCJyZWN1cnNpdmUiLCJiYXNlIiwic2VwYXJhdG9yIiwiYmFzZVdpdGhTZXAiLCJlbmRzV2l0aCIsIml0ZW1XaXRoU2VwIiwic3RhcnRzV2l0aCIsInN1YnN0ciIsImJpbmRQYXRoSm9pblRvIiwic2VwIiwiaXRlbXMiLCJpbnB1dExpbmUiLCJzdGFuZGFyZF9pbnB1dCIsInN0ZGluIiwic2V0RW5jb2RpbmciLCJvbmNlIiwidHJpbSIsImJyZWFrV29yZHMiLCJ3b3JkcyIsInJlc3VsdCIsImxpbmUiLCJ3IiwiaHR0cHMiLCJodHRwc0dldEpzb24iLCJ1cmwiLCJ0cnlVcmwiLCJnZXQiLCJyZXMiLCJib2R5IiwiY2h1bmsiLCJzdGF0dXNDb2RlIiwicmVkaXJlY3RVcmwiLCJoZWFkZXJzIiwicmVzcG9uc2UiLCJ0b0lkZW50aWZpZXIiLCJpZGVudGlmaWVyIiwiaSIsImMiLCJpc0xldHRlciIsInRvTG93ZXJDYXNlIiwidG9VcHBlckNhc2UiLCJpc0RpZ2l0IiwiaW5jbHVkZXMiLCJ1c2VySWRlbnRpZmllciIsInVzZXJJbmZvIiwidXNlcm5hbWUiLCJ0b25sYWJzSG9tZVBhdGgiLCJob21lZGlyIiwiX3Byb2dyZXNzTGluZSIsInByb2dyZXNzTGluZSIsIndyaXRlIiwiZXh0cmEiLCJyZXBlYXQiLCJwcm9ncmVzcyIsImluZm8iLCJwcm9ncmVzc0RvbmUiLCJwYXJzZUZpbGVBcmciLCJmaWxlQXJnIiwiZXh0IiwiZmlsZU11c3RFeGlzdHMiLCJwbGF0Zm9ybSIsImZpbGVQYXRoIiwiZGlybmFtZSIsImJhc2VuYW1lIiwic291cmNlRmlsZU5vdEZvdW5kIiwiZXhpdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBZUE7O0FBZkE7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUQsQ0FBbEI7O0FBQ0EsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFDQSxNQUFNRSxJQUFJLEdBQUdGLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUcsRUFBQUE7QUFBRixJQUFZSCxPQUFPLENBQUMsZUFBRCxDQUF6Qjs7QUFDQSxNQUFNSSxPQUFPLEdBQUdDLElBQUksQ0FBQ0MsS0FBTCxDQUFXUCxFQUFFLENBQUNRLFlBQUgsQ0FBZ0JMLElBQUksQ0FBQ00sSUFBTCxDQUFVQyxTQUFWLEVBQXFCLElBQXJCLEVBQTJCLElBQTNCLEVBQWlDLGNBQWpDLENBQWhCLEVBQWtFQyxRQUFsRSxFQUFYLEVBQXlGTixPQUF6Rzs7O0FBRUEsU0FBU08sU0FBVCxDQUFtQkMsS0FBbkIsRUFBa0M7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VVAsRUFBRSxDQUFDMkcsT0FBSCxFQUFWLEVBQXdCVSxPQUFPLENBQUNsRCxNQUFSLENBQWUsQ0FBZixDQUF4QixDQUFWO0FBQ0g7O0FBQ0QsUUFBTXNELFFBQVEsR0FBR3hILElBQUksQ0FBQ3NCLE9BQUwsQ0FBYThGLE9BQWIsQ0FBakI7QUFDQSxRQUFNdEUsR0FBRyxHQUFHcUIsY0FBYyxDQUFDbkUsSUFBSSxDQUFDeUgsT0FBTCxDQUFhRCxRQUFiLENBQUQsQ0FBMUI7QUFDQSxRQUFNNUQsSUFBSSxHQUFHNUQsSUFBSSxDQUFDMEgsUUFBTCxDQUFjRixRQUFkLEVBQXdCSCxHQUF4QixDQUFiO0FBQ0EsUUFBTWxHLElBQUksR0FBR3lDLElBQUksQ0FBQ3lDLFFBQUwsQ0FBYyxHQUFkLElBQXFCekMsSUFBckIsR0FBNkIsR0FBRUEsSUFBSyxHQUFFeUQsR0FBSSxFQUF2RDtBQUNBLFFBQU12QyxNQUFNLEdBQUc7QUFDWGhDLElBQUFBLEdBRFc7QUFFWGMsSUFBQUEsSUFGVztBQUdYekMsSUFBQUE7QUFIVyxHQUFmOztBQUtBLE1BQUltRyxjQUFjLElBQUksQ0FBQ3pILEVBQUUsQ0FBQzRELFVBQUgsQ0FBY3FCLE1BQU0sQ0FBQ2hDLEdBQVAsQ0FBVzNCLElBQVgsQ0FBZCxDQUF2QixFQUF3RDtBQUNwRFIsSUFBQUEsT0FBTyxDQUFDdUIsS0FBUixDQUFjckIsYUFBTThHLGtCQUFOLENBQXlCeEcsSUFBekIsQ0FBZDtBQUNBSCxJQUFBQSxPQUFPLENBQUM0RyxJQUFSLENBQWEsQ0FBYjtBQUNIOztBQUNELFNBQU85QyxNQUFQO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6IGh0dHBzOi8vd3d3LnRvbi5kZXYvbGljZW5zZXNcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKlxuICovXG4vLyBAZmxvd1xuaW1wb3J0IHsgdGV4dHMgfSBmcm9tICcuL3RleHRzJztcblxuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuY29uc3Qgb3MgPSByZXF1aXJlKCdvcycpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgc3Bhd24gfSA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTtcbmNvbnN0IHZlcnNpb24gPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAncGFja2FnZS5qc29uJykpLnRvU3RyaW5nKCkpLnZlcnNpb247XG5cbmZ1bmN0aW9uIHNob3dVc2FnZSh1c2FnZTogc3RyaW5nKSB7XG4gICAgY29uc29sZS5sb2codGV4dHMudXNhZ2VIZWFkZXIodmVyc2lvbikpO1xuICAgIGNvbnNvbGUubG9nKHVzYWdlKTtcbn1cblxuY29uc3Qgc3Bhd25FbnYgPSB7XG4gICAgLi4ucHJvY2Vzcy5lbnYsXG59O1xuXG5mdW5jdGlvbiBydW4obmFtZTogc3RyaW5nLCAuLi5hcmdzOiBzdHJpbmdbXSk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHNwYXduZWQgPSBzcGF3bihuYW1lLCBhcmdzLCB7IGVudjogc3Bhd25FbnYgfSk7XG4gICAgICAgICAgICBjb25zdCBlcnJvcnMgPSBbXTtcbiAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IFtdO1xuXG4gICAgICAgICAgICBzcGF3bmVkLnN0ZG91dC5vbignZGF0YScsIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgb3V0cHV0LnB1c2goZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzcGF3bmVkLnN0ZGVyci5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzcGF3bmVkLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzcGF3bmVkLm9uKCdjbG9zZScsIChjb2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGNvZGUgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShvdXRwdXQuam9pbignJykpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcnMuam9pbignJykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiB2ZXJzaW9uVG9OdW1iZXIoczogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBjb25zdCBwYXJ0cyA9IGAke3MgfHwgJyd9YC5zcGxpdCgnLicpLm1hcCh4ID0+IE51bWJlci5wYXJzZUludCh4KSkuc2xpY2UoMCwgMyk7XG4gICAgd2hpbGUgKHBhcnRzLmxlbmd0aCA8IDMpIHtcbiAgICAgICAgcGFydHMucHVzaCgwKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhcnRzWzBdICogMTAwMDAwMCArIHBhcnRzWzFdICogMTAwMCArIHBhcnRzWzJdO1xufVxuXG5mdW5jdGlvbiBmb3JjZVJtRGlyKGRpcjogc3RyaW5nKSB7XG4gICAgZnMucmVhZGRpclN5bmMoZGlyKS5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgIGNvbnN0IGl0ZW1QYXRoID0gcGF0aC5qb2luKGRpciwgaXRlbSk7XG4gICAgICAgIGNvbnN0IHN0YXQgPSBmcy5zdGF0U3luYyhpdGVtUGF0aCk7XG5cbiAgICAgICAgaWYgKGl0ZW1QYXRoID09PSBcIi5cIiB8fCBpdGVtUGF0aCA9PT0gXCIuLlwiKSB7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICBmb3JjZVJtRGlyKGl0ZW1QYXRoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZzLnVubGlua1N5bmMoaXRlbVBhdGgpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgZnMucm1kaXJTeW5jKGRpcik7XG59XG5cbmZ1bmN0aW9uIGVuc3VyZUNsZWFuRGlyZWN0b3J5KHBhdGg6IHN0cmluZykge1xuICAgIGlmIChmcy5leGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgICAgIGZvcmNlUm1EaXIocGF0aCk7XG4gICAgfVxuICAgIGZzLm1rZGlyU3luYyhwYXRoLCAoeyByZWN1cnNpdmU6IHRydWUgfTogYW55KSk7XG59XG5cbmV4cG9ydCB0eXBlIFBhdGhKb2luID0gKC4uLml0ZW1zOiBzdHJpbmdbXSkgPT4gc3RyaW5nO1xuXG5mdW5jdGlvbiBqb2luKGJhc2U6IHN0cmluZywgaXRlbTogc3RyaW5nLCBzZXBhcmF0b3I6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgYmFzZVdpdGhTZXAgPSBiYXNlLmVuZHNXaXRoKHNlcGFyYXRvcik7XG4gICAgY29uc3QgaXRlbVdpdGhTZXAgPSBpdGVtLnN0YXJ0c1dpdGgoc2VwYXJhdG9yKTtcbiAgICBpZiAoYmFzZVdpdGhTZXAgJiYgaXRlbVdpdGhTZXApIHtcbiAgICAgICAgcmV0dXJuIGAke2Jhc2V9JHtpdGVtLnN1YnN0cigxKX1gO1xuICAgIH1cbiAgICBpZiAoIWJhc2VXaXRoU2VwICYmICFpdGVtV2l0aFNlcCkge1xuICAgICAgICByZXR1cm4gYCR7YmFzZX0vJHtpdGVtfWA7XG4gICAgfVxuICAgIHJldHVybiBgJHtiYXNlfSR7aXRlbX1gO1xufVxuXG5mdW5jdGlvbiBiaW5kUGF0aEpvaW5UbyhiYXNlOiBzdHJpbmcsIHNlcGFyYXRvcj86IHN0cmluZyk6IFBhdGhKb2luIHtcbiAgICBpZiAoc2VwYXJhdG9yKSB7XG4gICAgICAgIGNvbnN0IHNlcCA9IHNlcGFyYXRvcjtcbiAgICAgICAgcmV0dXJuICguLi5pdGVtczogc3RyaW5nW10pOiBzdHJpbmcgPT4ge1xuICAgICAgICAgICAgbGV0IHBhdGggPSBiYXNlO1xuICAgICAgICAgICAgaXRlbXMuZm9yRWFjaCh4ID0+IHBhdGggPSBqb2luKHBhdGgsIHgsIHNlcCkpO1xuICAgICAgICAgICAgcmV0dXJuIHBhdGg7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuICguLi5pdGVtczogc3RyaW5nW10pOiBzdHJpbmcgPT4ge1xuICAgICAgICByZXR1cm4gaXRlbXMubGVuZ3RoID4gMCA/IHBhdGguam9pbihiYXNlLCAuLi5pdGVtcykgOiBiYXNlO1xuICAgIH1cbn1cblxuXG5mdW5jdGlvbiBpbnB1dExpbmUoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgY29uc3Qgc3RhbmRhcmRfaW5wdXQgPSBwcm9jZXNzLnN0ZGluO1xuICAgICAgICBzdGFuZGFyZF9pbnB1dC5zZXRFbmNvZGluZygndXRmLTgnKTtcbiAgICAgICAgc3RhbmRhcmRfaW5wdXQub25jZSgnZGF0YScsIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICByZXNvbHZlKGAke2RhdGF9YC50cmltKCkpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gYnJlYWtXb3JkcyhzOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHdvcmRzID0gcy5zcGxpdCgnICcpO1xuICAgIGxldCByZXN1bHQgPSAnJztcbiAgICBsZXQgbGluZSA9ICcnO1xuICAgIHdvcmRzLmZvckVhY2goKHcpID0+IHtcbiAgICAgICAgaWYgKGxpbmUubGVuZ3RoICsgdy5sZW5ndGggPiA4MCkge1xuICAgICAgICAgICAgaWYgKHJlc3VsdCAhPT0gJycpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgKz0gJ1xcbic7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXN1bHQgKz0gbGluZTtcbiAgICAgICAgICAgIGxpbmUgPSAnJztcbiAgICAgICAgfVxuICAgICAgICBpZiAobGluZSAhPT0gJycpIHtcbiAgICAgICAgICAgIGxpbmUgKz0gJyAnO1xuICAgICAgICB9XG4gICAgICAgIGxpbmUgKz0gdztcbiAgICB9KTtcbiAgICBpZiAobGluZSAhPT0gJycpIHtcbiAgICAgICAgaWYgKHJlc3VsdCAhPT0gJycpIHtcbiAgICAgICAgICAgIHJlc3VsdCArPSAnXFxuJztcbiAgICAgICAgfVxuICAgICAgICByZXN1bHQgKz0gbGluZTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cblxuXG5jb25zdCBodHRwcyA9IHJlcXVpcmUoJ2h0dHBzJyk7XG5cbmZ1bmN0aW9uIGh0dHBzR2V0SnNvbih1cmw6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPCpbXT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBjb25zdCB0cnlVcmwgPSAodXJsKSA9PiB7XG4gICAgICAgICAgICBodHRwcy5nZXQodXJsLCBmdW5jdGlvbiAocmVzKSB7XG4gICAgICAgICAgICAgICAgbGV0IGJvZHkgPSAnJztcblxuICAgICAgICAgICAgICAgIHJlcy5vbignZGF0YScsIGZ1bmN0aW9uIChjaHVuaykge1xuICAgICAgICAgICAgICAgICAgICBib2R5ICs9IGNodW5rO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgcmVzLm9uKCdlbmQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gMzAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZWRpcmVjdFVybCA9IHJlcy5oZWFkZXJzWydsb2NhdGlvbiddO1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5VXJsKHJlZGlyZWN0VXJsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkub24oJ2Vycm9yJywgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICB0cnlVcmwodXJsKTtcbiAgICB9KVxufVxuXG5mdW5jdGlvbiB0b0lkZW50aWZpZXIoczogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBsZXQgaWRlbnRpZmllciA9ICcnO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICBjb25zdCBjID0gc1tpXTtcbiAgICAgICAgY29uc3QgaXNMZXR0ZXIgPSBjLnRvTG93ZXJDYXNlKCkgIT09IGMudG9VcHBlckNhc2UoKTtcbiAgICAgICAgY29uc3QgaXNEaWdpdCA9ICFpc0xldHRlciAmJiAnMDEyMzQ1Njc4OScuaW5jbHVkZXMoYyk7XG4gICAgICAgIGlmIChpc0xldHRlciB8fCBpc0RpZ2l0KSB7XG4gICAgICAgICAgICBpZGVudGlmaWVyICs9IGM7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGlkZW50aWZpZXI7XG59XG5cbmNvbnN0IHVzZXJJZGVudGlmaWVyID0gdG9JZGVudGlmaWVyKG9zLnVzZXJJbmZvKCkudXNlcm5hbWUpLnRvTG93ZXJDYXNlKCk7XG5jb25zdCB0b25sYWJzSG9tZVBhdGggPSBiaW5kUGF0aEpvaW5UbyhwYXRoLmpvaW4ob3MuaG9tZWRpcigpLCAnLnRvbmxhYnMnKSk7XG5cbmxldCBfcHJvZ3Jlc3NMaW5lOiBzdHJpbmcgPSAnJztcblxuZnVuY3Rpb24gcHJvZ3Jlc3NMaW5lKGxpbmU6IHN0cmluZykge1xuICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGBcXHIke2xpbmV9YCk7XG4gICAgY29uc3QgZXh0cmEgPSBfcHJvZ3Jlc3NMaW5lLmxlbmd0aCAtIGxpbmUubGVuZ3RoO1xuICAgIGlmIChleHRyYSA+IDApIHtcbiAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoJyAnLnJlcGVhdChleHRyYSkgKyAnXFxiJy5yZXBlYXQoZXh0cmEpKTtcbiAgICB9XG4gICAgX3Byb2dyZXNzTGluZSA9IGxpbmU7XG59XG5cbmZ1bmN0aW9uIHByb2dyZXNzKGluZm86IHN0cmluZykge1xuICAgIHByb2dyZXNzTGluZShgJHtpbmZvfS4uLmApO1xufVxuXG5mdW5jdGlvbiBwcm9ncmVzc0RvbmUoKSB7XG4gICAgY29uc29sZS5sb2coJyDinJMnKTtcbiAgICBfcHJvZ3Jlc3NMaW5lID0gJyc7XG59XG5cbmV4cG9ydCB0eXBlIEZpbGVBcmcgPSB7XG4gICAgZGlyOiBQYXRoSm9pbixcbiAgICBiYXNlOiBzdHJpbmcsXG4gICAgbmFtZTogc3RyaW5nXG59XG5cbmZ1bmN0aW9uIHBhcnNlRmlsZUFyZyhmaWxlQXJnOiBzdHJpbmcsIGV4dDogc3RyaW5nLCBmaWxlTXVzdEV4aXN0czogYm9vbGVhbik6IEZpbGVBcmcge1xuICAgIGlmIChvcy5wbGF0Zm9ybSgpID09PSAnZGFyd2luJyAmJiBmaWxlQXJnLnN0YXJ0c1dpdGgoJ34vJykpIHtcbiAgICAgICAgZmlsZUFyZyA9IHBhdGguam9pbihvcy5ob21lZGlyKCksIGZpbGVBcmcuc3Vic3RyKDIpKTtcbiAgICB9XG4gICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUoZmlsZUFyZyk7XG4gICAgY29uc3QgZGlyID0gYmluZFBhdGhKb2luVG8ocGF0aC5kaXJuYW1lKGZpbGVQYXRoKSk7XG4gICAgY29uc3QgYmFzZSA9IHBhdGguYmFzZW5hbWUoZmlsZVBhdGgsIGV4dCk7XG4gICAgY29uc3QgbmFtZSA9IGJhc2UuaW5jbHVkZXMoJy4nKSA/IGJhc2UgOiBgJHtiYXNlfSR7ZXh0fWA7XG4gICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICBkaXIsXG4gICAgICAgIGJhc2UsXG4gICAgICAgIG5hbWVcbiAgICB9O1xuICAgIGlmIChmaWxlTXVzdEV4aXN0cyAmJiAhZnMuZXhpc3RzU3luYyhyZXN1bHQuZGlyKG5hbWUpKSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKHRleHRzLnNvdXJjZUZpbGVOb3RGb3VuZChuYW1lKSk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cblxuXG5cbmV4cG9ydCB7XG4gICAgdmVyc2lvbixcbiAgICBzaG93VXNhZ2UsXG4gICAgcnVuLFxuICAgIHZlcnNpb25Ub051bWJlcixcbiAgICBmb3JjZVJtRGlyLFxuICAgIGVuc3VyZUNsZWFuRGlyZWN0b3J5LFxuICAgIGJpbmRQYXRoSm9pblRvLFxuICAgIGlucHV0TGluZSxcbiAgICBicmVha1dvcmRzLFxuICAgIGh0dHBzR2V0SnNvbixcbiAgICB0b0lkZW50aWZpZXIsXG4gICAgdXNlcklkZW50aWZpZXIsXG4gICAgdG9ubGFic0hvbWVQYXRoLFxuICAgIHByb2dyZXNzLFxuICAgIHByb2dyZXNzTGluZSxcbiAgICBwcm9ncmVzc0RvbmUsXG4gICAgcGFyc2VGaWxlQXJnLFxufVxuIl19