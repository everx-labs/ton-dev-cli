"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.showUsage = showUsage;
exports.run = run;
exports.versionToNumber = versionToNumber;
exports.forceRmDir = forceRmDir;
exports.ensureCleanDirectory = ensureCleanDirectory;
exports.bindPathJoinTo = bindPathJoinTo;
exports.inputLine = inputLine;
exports.breakWords = breakWords;
exports.httpsGetJson = httpsGetJson;
exports.toIdentifier = toIdentifier;
exports.progress = progress;
exports.progressLine = progressLine;
exports.progressDone = progressDone;
exports.parseFileArg = parseFileArg;
exports.tonlabsHomePath = exports.userIdentifier = exports.version = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _texts = require("./texts");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var fs = require('fs');

var os = require('os');

var path = require('path');

var _require = require('child_process'),
    spawn = _require.spawn;

var version = JSON.parse(fs.readFileSync(path.join(__dirname, '..', '..', 'package.json')).toString()).version;
exports.version = version;

function showUsage(usage) {
  console.log(_texts.texts.usageHeader(version));
  console.log(usage);
}

var spawnEnv = _objectSpread({}, process.env);

function run(name) {
  for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    args[_key - 1] = arguments[_key];
  }

  return new Promise(function (resolve, reject) {
    try {
      var spawned = spawn(name, args, {
        env: spawnEnv
      });
      var errors = [];
      var output = [];
      spawned.stdout.on('data', function (data) {
        output.push(data.toString());
      });
      spawned.stderr.on('data', function (data) {
        errors.push(data.toString());
      });
      spawned.on('error', function (err) {
        reject(err);
      });
      spawned.on('close', function (code) {
        if (code === 0) {
          resolve(output.join(''));
        } else {
          reject(errors.join(''));
        }
      });
    } catch (error) {
      reject(error);
    }
  });
}

function versionToNumber(s) {
  var parts = "".concat(s || '').split('.').map(function (x) {
    return Number.parseInt(x);
  }).slice(0, 3);

  while (parts.length < 3) {
    parts.push(0);
  }

  return parts[0] * 1000000 + parts[1] * 1000 + parts[2];
}

function forceRmDir(dir) {
  fs.readdirSync(dir).forEach(function (item) {
    var itemPath = path.join(dir, item);
    var stat = fs.statSync(itemPath);

    if (itemPath === "." || itemPath === "..") {} else if (stat.isDirectory()) {
      forceRmDir(itemPath);
    } else {
      fs.unlinkSync(itemPath);
    }
  });
  fs.rmdirSync(dir);
}

function ensureCleanDirectory(path) {
  if (fs.existsSync(path)) {
    forceRmDir(path);
  }

  fs.mkdirSync(path, {
    recursive: true
  });
}

function join(base, item, separator) {
  var baseWithSep = base.endsWith(separator);
  var itemWithSep = item.startsWith(separator);

  if (baseWithSep && itemWithSep) {
    return "".concat(base).concat(item.substr(1));
  }

  if (!baseWithSep && !itemWithSep) {
    return "".concat(base, "/").concat(item);
  }

  return "".concat(base).concat(item);
}

function bindPathJoinTo(base, separator) {
  if (separator) {
    var sep = separator;
    return function () {
      var path = base;

      for (var _len2 = arguments.length, items = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        items[_key2] = arguments[_key2];
      }

      items.forEach(function (x) {
        return path = join(path, x, sep);
      });
      return path;
    };
  }

  return function () {
    for (var _len3 = arguments.length, items = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
      items[_key3] = arguments[_key3];
    }

    return items.length > 0 ? path.join.apply(path, [base].concat(items)) : base;
  };
}

function inputLine() {
  return new Promise(function (resolve) {
    var standard_input = process.stdin;
    standard_input.setEncoding('utf-8');
    standard_input.once('data', function (data) {
      resolve("".concat(data).trim());
    });
  });
}

function breakWords(s) {
  var words = s.split(' ');
  var result = '';
  var line = '';
  words.forEach(function (w) {
    if (line.length + w.length > 80) {
      if (result !== '') {
        result += '\n';
      }

      result += line;
      line = '';
    }

    if (line !== '') {
      line += ' ';
    }

    line += w;
  });

  if (line !== '') {
    if (result !== '') {
      result += '\n';
    }

    result += line;
  }

  return result;
}

var https = require('https');

function httpsGetJson(url) {
  return new Promise(function (resolve, reject) {
    var tryUrl = function tryUrl(url) {
      https.get(url, function (res) {
        var body = '';
        res.on('data', function (chunk) {
          body += chunk;
        });
        res.on('end', function () {
          if (res.statusCode === 301) {
            var redirectUrl = res.headers['location'];
            tryUrl(redirectUrl);
            return;
          }

          var response = JSON.parse(body);
          resolve(response);
        });
      }).on('error', function (error) {
        reject(error);
      });
    };

    tryUrl(url);
  });
}

function toIdentifier(s) {
  var identifier = '';

  for (var i = 0; i < s.length; i += 1) {
    var c = s[i];
    var isLetter = c.toLowerCase() !== c.toUpperCase();
    var isDigit = !isLetter && '0123456789'.includes(c);

    if (isLetter || isDigit) {
      identifier += c;
    }
  }

  return identifier;
}

var userIdentifier = toIdentifier(os.userInfo().username).toLowerCase();
exports.userIdentifier = userIdentifier;
var tonlabsHomePath = bindPathJoinTo(path.join(os.homedir(), '.tonlabs'));
exports.tonlabsHomePath = tonlabsHomePath;
var _progressLine = '';

function progressLine(line) {
  process.stdout.write("\r".concat(line));
  var extra = _progressLine.length - line.length;

  if (extra > 0) {
    process.stdout.write(' '.repeat(extra) + '\b'.repeat(extra));
  }

  _progressLine = line;
}

function progress(info) {
  progressLine("".concat(info, "..."));
}

function progressDone() {
  console.log(' âœ“');
  _progressLine = '';
}

function parseFileArg(fileArg, ext, fileMustExists) {
  if (os.platform() === 'darwin' && fileArg.startsWith('~/')) {
    fileArg = path.join(os.homedir(), fileArg.substr(2));
  }

  var filePath = path.resolve(fileArg);
  var dir = bindPathJoinTo(path.dirname(filePath));
  var base = path.basename(filePath, ext);
  var name = base.includes('.') ? base : "".concat(base).concat(ext);
  var result = {
    dir: dir,
    base: base,
    name: name
  };

  if (fileMustExists && !fs.existsSync(result.dir(name))) {
    console.error(_texts.texts.sourceFileNotFound(name));
    process.exit(1);
  }

  return result;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy91dGlscy5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJvcyIsInBhdGgiLCJzcGF3biIsInZlcnNpb24iLCJKU09OIiwicGFyc2UiLCJyZWFkRmlsZVN5bmMiLCJqb2luIiwiX19kaXJuYW1lIiwidG9TdHJpbmciLCJzaG93VXNhZ2UiLCJ1c2FnZSIsImNvbnNvbGUiLCJsb2ciLCJ0ZXh0cyIsInVzYWdlSGVhZGVyIiwic3Bhd25FbnYiLCJwcm9jZXNzIiwiZW52IiwicnVuIiwibmFtZSIsImFyZ3MiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInNwYXduZWQiLCJlcnJvcnMiLCJvdXRwdXQiLCJzdGRvdXQiLCJvbiIsImRhdGEiLCJwdXNoIiwic3RkZXJyIiwiZXJyIiwiY29kZSIsImVycm9yIiwidmVyc2lvblRvTnVtYmVyIiwicyIsInBhcnRzIiwic3BsaXQiLCJtYXAiLCJ4IiwiTnVtYmVyIiwicGFyc2VJbnQiLCJzbGljZSIsImxlbmd0aCIsImZvcmNlUm1EaXIiLCJkaXIiLCJyZWFkZGlyU3luYyIsImZvckVhY2giLCJpdGVtIiwiaXRlbVBhdGgiLCJzdGF0Iiwic3RhdFN5bmMiLCJpc0RpcmVjdG9yeSIsInVubGlua1N5bmMiLCJybWRpclN5bmMiLCJlbnN1cmVDbGVhbkRpcmVjdG9yeSIsImV4aXN0c1N5bmMiLCJta2RpclN5bmMiLCJyZWN1cnNpdmUiLCJiYXNlIiwic2VwYXJhdG9yIiwiYmFzZVdpdGhTZXAiLCJlbmRzV2l0aCIsIml0ZW1XaXRoU2VwIiwic3RhcnRzV2l0aCIsInN1YnN0ciIsImJpbmRQYXRoSm9pblRvIiwic2VwIiwiaXRlbXMiLCJpbnB1dExpbmUiLCJzdGFuZGFyZF9pbnB1dCIsInN0ZGluIiwic2V0RW5jb2RpbmciLCJvbmNlIiwidHJpbSIsImJyZWFrV29yZHMiLCJ3b3JkcyIsInJlc3VsdCIsImxpbmUiLCJ3IiwiaHR0cHMiLCJodHRwc0dldEpzb24iLCJ1cmwiLCJ0cnlVcmwiLCJnZXQiLCJyZXMiLCJib2R5IiwiY2h1bmsiLCJzdGF0dXNDb2RlIiwicmVkaXJlY3RVcmwiLCJoZWFkZXJzIiwicmVzcG9uc2UiLCJ0b0lkZW50aWZpZXIiLCJpZGVudGlmaWVyIiwiaSIsImMiLCJpc0xldHRlciIsInRvTG93ZXJDYXNlIiwidG9VcHBlckNhc2UiLCJpc0RpZ2l0IiwiaW5jbHVkZXMiLCJ1c2VySWRlbnRpZmllciIsInVzZXJJbmZvIiwidXNlcm5hbWUiLCJ0b25sYWJzSG9tZVBhdGgiLCJob21lZGlyIiwiX3Byb2dyZXNzTGluZSIsInByb2dyZXNzTGluZSIsIndyaXRlIiwiZXh0cmEiLCJyZXBlYXQiLCJwcm9ncmVzcyIsImluZm8iLCJwcm9ncmVzc0RvbmUiLCJwYXJzZUZpbGVBcmciLCJmaWxlQXJnIiwiZXh0IiwiZmlsZU11c3RFeGlzdHMiLCJwbGF0Zm9ybSIsImZpbGVQYXRoIiwiZGlybmFtZSIsImJhc2VuYW1lIiwic291cmNlRmlsZU5vdEZvdW5kIiwiZXhpdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWVBOzs7Ozs7QUFFQSxJQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxJQUFELENBQWxCOztBQUNBLElBQU1DLEVBQUUsR0FBR0QsT0FBTyxDQUFDLElBQUQsQ0FBbEI7O0FBQ0EsSUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsTUFBRCxDQUFwQjs7ZUFDa0JBLE9BQU8sQ0FBQyxlQUFELEM7SUFBakJHLEssWUFBQUEsSzs7QUFDUixJQUFNQyxPQUFPLEdBQUdDLElBQUksQ0FBQ0MsS0FBTCxDQUFXUCxFQUFFLENBQUNRLFlBQUgsQ0FBZ0JMLElBQUksQ0FBQ00sSUFBTCxDQUFVQyxTQUFWLEVBQXFCLElBQXJCLEVBQTJCLElBQTNCLEVBQWlDLGNBQWpDLENBQWhCLEVBQWtFQyxRQUFsRSxFQUFYLEVBQXlGTixPQUF6Rzs7O0FBRUEsU0FBU08sU0FBVCxDQUFtQkMsS0FBbkIsRUFBa0M7QUFDOUJDLEVBQUFBLE9BQU8sQ0FBQ0Ms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QkgsT0FBTyxDQUFDbkQsVUFBUixDQUFtQixJQUFuQixDQUFsQyxFQUE0RDtBQUN4RG1ELElBQUFBLE9BQU8sR0FBR3BILElBQUksQ0FBQ00sSUFBTCxDQUFVUCxFQUFFLENBQUMyRyxPQUFILEVBQVYsRUFBd0JVLE9BQU8sQ0FBQ2xELE1BQVIsQ0FBZSxDQUFmLENBQXhCLENBQVY7QUFDSDs7QUFDRCxNQUFNc0QsUUFBUSxHQUFHeEgsSUFBSSxDQUFDc0IsT0FBTCxDQUFhOEYsT0FBYixDQUFqQjtBQUNBLE1BQU10RSxHQUFHLEdBQUdxQixjQUFjLENBQUNuRSxJQUFJLENBQUN5SCxPQUFMLENBQWFELFFBQWIsQ0FBRCxDQUExQjtBQUNBLE1BQU01RCxJQUFJLEdBQUc1RCxJQUFJLENBQUMwSCxRQUFMLENBQWNGLFFBQWQsRUFBd0JILEdBQXhCLENBQWI7QUFDQSxNQUFNbEcsSUFBSSxHQUFHeUMsSUFBSSxDQUFDeUMsUUFBTCxDQUFjLEdBQWQsSUFBcUJ6QyxJQUFyQixhQUErQkEsSUFBL0IsU0FBc0N5RCxHQUF0QyxDQUFiO0FBQ0EsTUFBTXZDLE1BQU0sR0FBRztBQUNYaEMsSUFBQUEsR0FBRyxFQUFIQSxHQURXO0FBRVhjLElBQUFBLElBQUksRUFBSkEsSUFGVztBQUdYekMsSUFBQUEsSUFBSSxFQUFKQTtBQUhXLEdBQWY7O0FBS0EsTUFBSW1HLGNBQWMsSUFBSSxDQUFDekgsRUFBRSxDQUFDNEQsVUFBSCxDQUFjcUIsTUFBTSxDQUFDaEMsR0FBUCxDQUFXM0IsSUFBWCxDQUFkLENBQXZCLEVBQXdEO0FBQ3BEUixJQUFBQSxPQUFPLENBQUN1QixLQUFSLENBQWNyQixhQUFNOEcsa0JBQU4sQ0FBeUJ4RyxJQUF6QixDQUFkO0FBQ0FILElBQUFBLE9BQU8sQ0FBQzRHLElBQVIsQ0FBYSxDQUFiO0FBQ0g7O0FBQ0QsU0FBTzlDLE1BQVA7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOC0yMDE5IFRPTiBERVYgU09MVVRJT05TIExURC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcbiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZVxuICogTGljZW5zZSBhdDogaHR0cHM6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqXG4gKi9cbi8vIEBmbG93XG5pbXBvcnQgeyB0ZXh0cyB9IGZyb20gJy4vdGV4dHMnO1xuXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5jb25zdCBvcyA9IHJlcXVpcmUoJ29zJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBzcGF3biB9ID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xuY29uc3QgdmVyc2lvbiA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICcuLicsICdwYWNrYWdlLmpzb24nKSkudG9TdHJpbmcoKSkudmVyc2lvbjtcblxuZnVuY3Rpb24gc2hvd1VzYWdlKHVzYWdlOiBzdHJpbmcpIHtcbiAgICBjb25zb2xlLmxvZyh0ZXh0cy51c2FnZUhlYWRlcih2ZXJzaW9uKSk7XG4gICAgY29uc29sZS5sb2codXNhZ2UpO1xufVxuXG5jb25zdCBzcGF3bkVudiA9IHtcbiAgICAuLi5wcm9jZXNzLmVudixcbn07XG5cbmZ1bmN0aW9uIHJ1bihuYW1lOiBzdHJpbmcsIC4uLmFyZ3M6IHN0cmluZ1tdKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3Qgc3Bhd25lZCA9IHNwYXduKG5hbWUsIGFyZ3MsIHsgZW52OiBzcGF3bkVudiB9KTtcbiAgICAgICAgICAgIGNvbnN0IGVycm9ycyA9IFtdO1xuICAgICAgICAgICAgY29uc3Qgb3V0cHV0ID0gW107XG5cbiAgICAgICAgICAgIHNwYXduZWQuc3Rkb3V0Lm9uKCdkYXRhJywgZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgICAgICBvdXRwdXQucHVzaChkYXRhLnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHNwYXduZWQuc3RkZXJyLm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBlcnJvcnMucHVzaChkYXRhLnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHNwYXduZWQub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHNwYXduZWQub24oJ2Nsb3NlJywgKGNvZGUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoY29kZSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG91dHB1dC5qb2luKCcnKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9ycy5qb2luKCcnKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIHZlcnNpb25Ub051bWJlcihzOiBzdHJpbmcpOiBudW1iZXIge1xuICAgIGNvbnN0IHBhcnRzID0gYCR7cyB8fCAnJ31gLnNwbGl0KCcuJykubWFwKHggPT4gTnVtYmVyLnBhcnNlSW50KHgpKS5zbGljZSgwLCAzKTtcbiAgICB3aGlsZSAocGFydHMubGVuZ3RoIDwgMykge1xuICAgICAgICBwYXJ0cy5wdXNoKDApO1xuICAgIH1cbiAgICByZXR1cm4gcGFydHNbMF0gKiAxMDAwMDAwICsgcGFydHNbMV0gKiAxMDAwICsgcGFydHNbMl07XG59XG5cbmZ1bmN0aW9uIGZvcmNlUm1EaXIoZGlyOiBzdHJpbmcpIHtcbiAgICBmcy5yZWFkZGlyU3luYyhkaXIpLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgY29uc3QgaXRlbVBhdGggPSBwYXRoLmpvaW4oZGlyLCBpdGVtKTtcbiAgICAgICAgY29uc3Qgc3RhdCA9IGZzLnN0YXRTeW5jKGl0ZW1QYXRoKTtcblxuICAgICAgICBpZiAoaXRlbVBhdGggPT09IFwiLlwiIHx8IGl0ZW1QYXRoID09PSBcIi4uXCIpIHtcbiAgICAgICAgfSBlbHNlIGlmIChzdGF0LmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICAgIGZvcmNlUm1EaXIoaXRlbVBhdGgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZnMudW5saW5rU3luYyhpdGVtUGF0aCk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBmcy5ybWRpclN5bmMoZGlyKTtcbn1cblxuZnVuY3Rpb24gZW5zdXJlQ2xlYW5EaXJlY3RvcnkocGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKGZzLmV4aXN0c1N5bmMocGF0aCkpIHtcbiAgICAgICAgZm9yY2VSbURpcihwYXRoKTtcbiAgICB9XG4gICAgZnMubWtkaXJTeW5jKHBhdGgsICh7IHJlY3Vyc2l2ZTogdHJ1ZSB9OiBhbnkpKTtcbn1cblxuZXhwb3J0IHR5cGUgUGF0aEpvaW4gPSAoLi4uaXRlbXM6IHN0cmluZ1tdKSA9PiBzdHJpbmc7XG5cbmZ1bmN0aW9uIGpvaW4oYmFzZTogc3RyaW5nLCBpdGVtOiBzdHJpbmcsIHNlcGFyYXRvcjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBiYXNlV2l0aFNlcCA9IGJhc2UuZW5kc1dpdGgoc2VwYXJhdG9yKTtcbiAgICBjb25zdCBpdGVtV2l0aFNlcCA9IGl0ZW0uc3RhcnRzV2l0aChzZXBhcmF0b3IpO1xuICAgIGlmIChiYXNlV2l0aFNlcCAmJiBpdGVtV2l0aFNlcCkge1xuICAgICAgICByZXR1cm4gYCR7YmFzZX0ke2l0ZW0uc3Vic3RyKDEpfWA7XG4gICAgfVxuICAgIGlmICghYmFzZVdpdGhTZXAgJiYgIWl0ZW1XaXRoU2VwKSB7XG4gICAgICAgIHJldHVybiBgJHtiYXNlfS8ke2l0ZW19YDtcbiAgICB9XG4gICAgcmV0dXJuIGAke2Jhc2V9JHtpdGVtfWA7XG59XG5cbmZ1bmN0aW9uIGJpbmRQYXRoSm9pblRvKGJhc2U6IHN0cmluZywgc2VwYXJhdG9yPzogc3RyaW5nKTogUGF0aEpvaW4ge1xuICAgIGlmIChzZXBhcmF0b3IpIHtcbiAgICAgICAgY29uc3Qgc2VwID0gc2VwYXJhdG9yO1xuICAgICAgICByZXR1cm4gKC4uLml0ZW1zOiBzdHJpbmdbXSk6IHN0cmluZyA9PiB7XG4gICAgICAgICAgICBsZXQgcGF0aCA9IGJhc2U7XG4gICAgICAgICAgICBpdGVtcy5mb3JFYWNoKHggPT4gcGF0aCA9IGpvaW4ocGF0aCwgeCwgc2VwKSk7XG4gICAgICAgICAgICByZXR1cm4gcGF0aDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gKC4uLml0ZW1zOiBzdHJpbmdbXSk6IHN0cmluZyA9PiB7XG4gICAgICAgIHJldHVybiBpdGVtcy5sZW5ndGggPiAwID8gcGF0aC5qb2luKGJhc2UsIC4uLml0ZW1zKSA6IGJhc2U7XG4gICAgfVxufVxuXG5cbmZ1bmN0aW9uIGlucHV0TGluZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICBjb25zdCBzdGFuZGFyZF9pbnB1dCA9IHByb2Nlc3Muc3RkaW47XG4gICAgICAgIHN0YW5kYXJkX2lucHV0LnNldEVuY29kaW5nKCd1dGYtOCcpO1xuICAgICAgICBzdGFuZGFyZF9pbnB1dC5vbmNlKCdkYXRhJywgZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgIHJlc29sdmUoYCR7ZGF0YX1gLnRyaW0oKSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBicmVha1dvcmRzKHM6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3Qgd29yZHMgPSBzLnNwbGl0KCcgJyk7XG4gICAgbGV0IHJlc3VsdCA9ICcnO1xuICAgIGxldCBsaW5lID0gJyc7XG4gICAgd29yZHMuZm9yRWFjaCgodykgPT4ge1xuICAgICAgICBpZiAobGluZS5sZW5ndGggKyB3Lmxlbmd0aCA+IDgwKSB7XG4gICAgICAgICAgICBpZiAocmVzdWx0ICE9PSAnJykge1xuICAgICAgICAgICAgICAgIHJlc3VsdCArPSAnXFxuJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc3VsdCArPSBsaW5lO1xuICAgICAgICAgICAgbGluZSA9ICcnO1xuICAgICAgICB9XG4gICAgICAgIGlmIChsaW5lICE9PSAnJykge1xuICAgICAgICAgICAgbGluZSArPSAnICc7XG4gICAgICAgIH1cbiAgICAgICAgbGluZSArPSB3O1xuICAgIH0pO1xuICAgIGlmIChsaW5lICE9PSAnJykge1xuICAgICAgICBpZiAocmVzdWx0ICE9PSAnJykge1xuICAgICAgICAgICAgcmVzdWx0ICs9ICdcXG4nO1xuICAgICAgICB9XG4gICAgICAgIHJlc3VsdCArPSBsaW5lO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xufVxuXG5cbmNvbnN0IGh0dHBzID0gcmVxdWlyZSgnaHR0cHMnKTtcblxuZnVuY3Rpb24gaHR0cHNHZXRKc29uKHVybDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8KltdPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IHRyeVVybCA9ICh1cmwpID0+IHtcbiAgICAgICAgICAgIGh0dHBzLmdldCh1cmwsIGZ1bmN0aW9uIChyZXMpIHtcbiAgICAgICAgICAgICAgICBsZXQgYm9keSA9ICcnO1xuXG4gICAgICAgICAgICAgICAgcmVzLm9uKCdkYXRhJywgZnVuY3Rpb24gKGNodW5rKSB7XG4gICAgICAgICAgICAgICAgICAgIGJvZHkgKz0gY2h1bms7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICByZXMub24oJ2VuZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlID09PSAzMDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlZGlyZWN0VXJsID0gcmVzLmhlYWRlcnNbJ2xvY2F0aW9uJ107XG4gICAgICAgICAgICAgICAgICAgICAgICB0cnlVcmwocmVkaXJlY3RVcmwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KS5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIHRyeVVybCh1cmwpO1xuICAgIH0pXG59XG5cbmZ1bmN0aW9uIHRvSWRlbnRpZmllcihzOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGxldCBpZGVudGlmaWVyID0gJyc7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGNvbnN0IGMgPSBzW2ldO1xuICAgICAgICBjb25zdCBpc0xldHRlciA9IGMudG9Mb3dlckNhc2UoKSAhPT0gYy50b1VwcGVyQ2FzZSgpO1xuICAgICAgICBjb25zdCBpc0RpZ2l0ID0gIWlzTGV0dGVyICYmICcwMTIzNDU2Nzg5Jy5pbmNsdWRlcyhjKTtcbiAgICAgICAgaWYgKGlzTGV0dGVyIHx8IGlzRGlnaXQpIHtcbiAgICAgICAgICAgIGlkZW50aWZpZXIgKz0gYztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaWRlbnRpZmllcjtcbn1cblxuY29uc3QgdXNlcklkZW50aWZpZXIgPSB0b0lkZW50aWZpZXIob3MudXNlckluZm8oKS51c2VybmFtZSkudG9Mb3dlckNhc2UoKTtcbmNvbnN0IHRvbmxhYnNIb21lUGF0aCA9IGJpbmRQYXRoSm9pblRvKHBhdGguam9pbihvcy5ob21lZGlyKCksICcudG9ubGFicycpKTtcblxubGV0IF9wcm9ncmVzc0xpbmU6IHN0cmluZyA9ICcnO1xuXG5mdW5jdGlvbiBwcm9ncmVzc0xpbmUobGluZTogc3RyaW5nKSB7XG4gICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoYFxcciR7bGluZX1gKTtcbiAgICBjb25zdCBleHRyYSA9IF9wcm9ncmVzc0xpbmUubGVuZ3RoIC0gbGluZS5sZW5ndGg7XG4gICAgaWYgKGV4dHJhID4gMCkge1xuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSgnICcucmVwZWF0KGV4dHJhKSArICdcXGInLnJlcGVhdChleHRyYSkpO1xuICAgIH1cbiAgICBfcHJvZ3Jlc3NMaW5lID0gbGluZTtcbn1cblxuZnVuY3Rpb24gcHJvZ3Jlc3MoaW5mbzogc3RyaW5nKSB7XG4gICAgcHJvZ3Jlc3NMaW5lKGAke2luZm99Li4uYCk7XG59XG5cbmZ1bmN0aW9uIHByb2dyZXNzRG9uZSgpIHtcbiAgICBjb25zb2xlLmxvZygnIOKckycpO1xuICAgIF9wcm9ncmVzc0xpbmUgPSAnJztcbn1cblxuZXhwb3J0IHR5cGUgRmlsZUFyZyA9IHtcbiAgICBkaXI6IFBhdGhKb2luLFxuICAgIGJhc2U6IHN0cmluZyxcbiAgICBuYW1lOiBzdHJpbmdcbn1cblxuZnVuY3Rpb24gcGFyc2VGaWxlQXJnKGZpbGVBcmc6IHN0cmluZywgZXh0OiBzdHJpbmcsIGZpbGVNdXN0RXhpc3RzOiBib29sZWFuKTogRmlsZUFyZyB7XG4gICAgaWYgKG9zLnBsYXRmb3JtKCkgPT09ICdkYXJ3aW4nICYmIGZpbGVBcmcuc3RhcnRzV2l0aCgnfi8nKSkge1xuICAgICAgICBmaWxlQXJnID0gcGF0aC5qb2luKG9zLmhvbWVkaXIoKSwgZmlsZUFyZy5zdWJzdHIoMikpO1xuICAgIH1cbiAgICBjb25zdCBmaWxlUGF0aCA9IHBhdGgucmVzb2x2ZShmaWxlQXJnKTtcbiAgICBjb25zdCBkaXIgPSBiaW5kUGF0aEpvaW5UbyhwYXRoLmRpcm5hbWUoZmlsZVBhdGgpKTtcbiAgICBjb25zdCBiYXNlID0gcGF0aC5iYXNlbmFtZShmaWxlUGF0aCwgZXh0KTtcbiAgICBjb25zdCBuYW1lID0gYmFzZS5pbmNsdWRlcygnLicpID8gYmFzZSA6IGAke2Jhc2V9JHtleHR9YDtcbiAgICBjb25zdCByZXN1bHQgPSB7XG4gICAgICAgIGRpcixcbiAgICAgICAgYmFzZSxcbiAgICAgICAgbmFtZVxuICAgIH07XG4gICAgaWYgKGZpbGVNdXN0RXhpc3RzICYmICFmcy5leGlzdHNTeW5jKHJlc3VsdC5kaXIobmFtZSkpKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IodGV4dHMuc291cmNlRmlsZU5vdEZvdW5kKG5hbWUpKTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xufVxuXG5cblxuZXhwb3J0IHtcbiAgICB2ZXJzaW9uLFxuICAgIHNob3dVc2FnZSxcbiAgICBydW4sXG4gICAgdmVyc2lvblRvTnVtYmVyLFxuICAgIGZvcmNlUm1EaXIsXG4gICAgZW5zdXJlQ2xlYW5EaXJlY3RvcnksXG4gICAgYmluZFBhdGhKb2luVG8sXG4gICAgaW5wdXRMaW5lLFxuICAgIGJyZWFrV29yZHMsXG4gICAgaHR0cHNHZXRKc29uLFxuICAgIHRvSWRlbnRpZmllcixcbiAgICB1c2VySWRlbnRpZmllcixcbiAgICB0b25sYWJzSG9tZVBhdGgsXG4gICAgcHJvZ3Jlc3MsXG4gICAgcHJvZ3Jlc3NMaW5lLFxuICAgIHByb2dyZXNzRG9uZSxcbiAgICBwYXJzZUZpbGVBcmcsXG59XG4iXX0=