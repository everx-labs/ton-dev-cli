"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Dev = void 0;

var _compilers = require("./compilers/compilers");

var _networks = require("./networks/networks");

var _docker = require("./utils/docker");

var _texts = require("./utils/texts");

var _utils = require("./utils/utils");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const fs = require('fs');

const os = require('os');

const path = require('path');

function excludeCompilers(dev, defs) {
  return defs.filter(x => x !== dev.compilers);
}

class Dev {
  constructor() {
    _defineProperty(this, "name", void 0);

    _defineProperty(this, "version", void 0);

    _defineProperty(this, "docker", void 0);

    _defineProperty(this, "networks", void 0);

    _defineProperty(this, "compilers", void 0);

    _defineProperty(this, "agreementRequired", void 0);

    _defineProperty(this, "configFilePath", void 0);

    _defineProperty(this, "onStartupImages", images => {
      this.agreementRequired = !images.find(Dev.isDevImage);
    });

    _defineProperty(this, "onBeforePull", async _repoTag => {
      if (!this.agreementRequired) {
        return;
      }

      const license = fs.readFileSync(path.join(__dirname, '..', 'LICENSE')).toString().split('\n').map(_utils.breakWords).join('\n');
      console.log(license);
      process.stdout.write(_texts.texts.agreementConfirmation);
      const answer = (await (0, _utils.inputLine)()).trim().toLowerCase();

      if (answer !== 'yes') {
        console.log(_texts.texts.agreementRejected);
        process.exit(0);
      }

      console.log(_texts.texts.agreementAccepted);
      this.agreementRequired = false;
    });

    this.name = 'tondev';
    this.version = _utils.version;
    this.agreementRequired = true;
    this.docker = new _docker.DevDocker();
    this.docker.onStartupImages = this.onStartupImages;
    this.docker.onBeforePull = this.onBeforePull;
    this.compilers = new _compilers.Compilers(_compilers.Compilers.defaultConfig);
    this.networks = [new _networks.Network(_networks.Network.defaultConfig)];
    this.configFilePath = (0, _utils.tonlabsHomePath)('config.json');
    fs.mkdirSync((0, _utils.tonlabsHomePath)(), {
      recursive: true
    });
    this.loadConfig();
  }

  loadConfig() {
    try {
      const config = JSON.parse(fs.readFileSync(this.configFilePath, {
        encoding: 'utf8'
      }));
      this.compilers.setConfig(config.compilers);
      this.networks = config.networks.map(x => new _networks.Network(x));
    } catch {}
  }

  saveConfig() {
    const config = {
      compilers: this.compilers.getConfig(),
      networks: this.networks.map(x => x.getConfig())
    };
    fs.mkdirSync((0, _utils.tonlabsHomePath)(''), {
      recursive: true
    });
    fs.writeFileSync(this.configFilePath, JSON.stringify(config), {
      encoding: 'utf8'
    });
  }

  networksFromNames(names) {
    return names.map(name => {
      const network = this.networks.find(x => x.name.toLowerCase() === name.toLowerCase());

      if (!network) {
        throw new Error(`Network not found: ${name}`);
      }

      return network;
    });
  }

  networksOrAll(names) {
    return names.length > 0 ? this.networksFromNames(names) : this.networks;
  }

  getDefs(source) {
    return source.compilers ? source.networks.concat(this.compilers) : [...source.networks];
  }

  async start(source) {
    await this.docker.startupContainers(excludeCompilers(this, this.getDefs(source)), _docker.ContainerStatus.running);
  }

  async stop(source) {
    await this.docker.shutdownContainers(this.getDefs(source), _docker.ContainerStatus.created);
  }

  async restart(source) {
    const defs = this.getDefs(source);
    await this.docker.shutdownContainers(defs, _docker.ContainerStatus.created);
    await this.docker.startupContainers(excludeCompilers(this, defs), _docker.ContainerStatus.running);
  }

  async recreate(source) {
    const defs = this.getDefs(source);
    await this.docker.shutdownContainers(defs, _docker.ContainerStatus.missing);
    await this.docker.startupContainers(excludeCompilers(this, defs), _docker.ContainerStatus.created);
  }

  async clean(compilers, networks, containersOnly) {
    const imageMatches = [];

    if (compilers) {
      imageMatches.push(_compilers.Compilers.imagePrefix);
    }

    if (networks) {
      imageMatches.push(_networks.Network.imagePrefix);
    }

    await this.docker.removeImages(imageMatches, containersOnly);
  }

  async useVersion(version, source) {
    const defs = this.getDefs(source);
    await this.docker.shutdownContainers(defs, _docker.ContainerStatus.missing);

    if (source.compilers) {
      this.compilers.setConfig({ ...this.compilers.getConfig(),
        version
      });
    }

    source.networks.forEach(network => {
      const config = network.getConfig();
      config.version = version;
      network.setConfig(config);
    });
    this.saveConfig();
    await this.docker.startupContainers(excludeCompilers(this, defs), _docker.ContainerStatus.running);
  } // Compilers


  hostPathToMountSource(hostPath) {
    if (os.platform() !== 'win32') {
      return hostPath.toLowerCase();
    }

    return `/host_mnt/${hostPath.replace(/:\\|\\/g, '/').toLowerCase()}`;
  }

  async getCompilersMountedTo(hostPath) {
    let info = (await this.docker.getContainerInfos()).find(info => {
      return _docker.DevDocker.containersImageMatched(info, this.compilers.requiredImage) && info.Mounts.find(mount => mount.Source.toLowerCase() === this.hostPathToMountSource(hostPath));
    });
    let container;

    if (info) {
      container = this.docker.client.getContainer(info.Id);

      if (!_docker.DevDocker.isRunning(info)) {
        await container.start();
      }
    } else {
      container = await this.compilers.createContainerMountedTo(hostPath, this.docker);
      await container.start();
    }

    return {
      container,
      guestPath: (0, _utils.bindPathJoinTo)(this.compilers.mountDestination, '/')
    };
  } // Networks


  ensureNetwork(name) {
    const existing = this.networks.find(x => x.name.toLowerCase() === name.toLowerCase());

    if (existing) {
      return existing;
    }

    const network = new _networks.Network({ ..._networks.Network.defaultConfig,
      name
    });
    this.networks.push(network);
    return network;
  }

  checkUniqueName(name) {
    if (this.networks.find(x => x.name.toLowerCase() === name.toLowerCase())) {
      throw new Error(`Network with name [${name}] already exists`);
    }
  }

  addNetworks(names) {
    names.forEach(name => {
      this.checkUniqueName(name);
      const network = new _networks.Network({ ..._networks.Network.defaultConfig,
        name
      });
      this.networks.push(network);
    });
    this.saveConfig();
  }

  async removeNetworks(networks) {
    await this.docker.shutdownContainers(networks, _docker.ContainerStatus.missing);
    networks.forEach(network => {
      const index = this.networks.findIndex(x => x === network);

      if (index >= 0) {
        this.networks.splice(index, 1);
      }
    });
    this.saveConfig();
  }

  async updateNetworkConfigs(networks, update) {
    const defs = [...networks];
    await this.docker.shutdownContainers(defs, _docker.ContainerStatus.missing);
    networks.forEach(network => {
      const config = network.getConfig();
      const saveName = config.name;
      update(config);

      if (config.name.toLowerCase() !== saveName.toLowerCase()) {
        this.checkUniqueName(config.name);
      }

      network.setConfig(config);
    });
    this.saveConfig();
    await this.docker.startupContainers(defs, _docker.ContainerStatus.running);
  }

  static isDevContainer(info) {
    return _docker.DevDocker.containersImageMatched(info, _compilers.Compilers.imagePrefix) || _docker.DevDocker.containersImageMatched(info, _networks.Network.imagePrefix);
  }

  static isDevImage(info) {
    return _docker.DevDocker.imageHasMatchedName(info, _compilers.Compilers.imagePrefix) || _docker.DevDocker.imageHasMatchedName(info, _networks.Network.imagePrefix);
  }

}

exports.Dev = Dev;

_defineProperty(Dev, "defaultConfig", Object.freeze({
  compilers: _compilers.Compilers.defaultConfig,
  networks: [_networks.Network.defaultConfig]
}));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9kZXYuanMiXSwibmFtZXMiOlsiZnMiLCJyZXF1aXJlIiwib3MiLCJwYXRoIiwiZXhjbHVkZUNvbXBpbGVycyIsImRldiIsImRlZnMiLCJmaWx0ZXIiLCJ4IiwiY29tcGlsZXJzIiwiRGV2IiwiY29uc3RydWN0b3IiLCJpbWFnZXMiLCJhZ3JlZW1lbnRSZXF1aXJlZCIsImZpbmQiLCJpc0RldkltYWdlIiwiX3JlcG9UYWciLCJsaWNlbnNlIiwicmVhZEZpbGVTeW5jIiwiam9pbiIsIl9fZGlybmFtZSIsInRvU3RyaW5nIiwic3BsaXQiLCJtYXAiLCJicmVha1dvcmRzIiwiY29uc29sZSIsImxvZyIsInByb2Nlc3MiLCJzdGRvdXQiLCJ3cml0ZSIsInRleHRzIiwiYWdyZWVtZW50Q29uZmlybWF0aW9uIiwiYW5zd2VyIiwidHJpbSIsInRvTG93ZXJDYXNlIiwiYWdyZWVtZW50UmVqZWN0ZWQiLCJleGl0IiwiYWdyZWVtZW50QWNjZXB0ZWQiLCJuYW1lIiwidmVyc2lvbiIsImRvY2tlciIsIkRldkRvY2tlciIsIm9uU3RhcnR1cEltYWdlcyIsIm9uQmVmb3JlUHVsbCIsIkNvbXBpbGVycyIsImRlZmF1bHRDb25maWciLCJuZXR3b3JrcyIsIk5ldHdvcmsiLCJjb25maWdGaWxlUGF0aCIsIm1rZGlyU3luYyIsInJlY3Vyc2l2ZSIsImxvYWRDb25maWciLCJjb25maWciLCJKU09OIiwicGFyc2UiLCJlbmNvZGluZyIsInNldENvbmZpZyIsInNhdmVDb25maWciLCJnZXRDb25maWciLCJ3cml0ZUZpbGVTeW5jIiwic3RyaW5naWZ5IiwibmV0d29ya3NGcm9tTmFtZXMiLCJuYW1lcyIsIm5ldHdvcmsiLCJFcnJvciIsIm5ldHdvcmtzT3JBbGwiLCJsZW5ndGgiLCJnZXREZWZzIiwic291cmNlIiwiY29uY2F0Iiwic3RhcnQiLCJzdGFydHVwQ29udGFpbmVycyIsIkNvbnRhaW5lclN0YXR1cyIsInJ1bm5pbmciLCJzdG9wIiwic2h1dGRvd25Db250YWluZXJzIiwiY3JlYXRlZCIsInJlc3RhcnQiLCJyZWNyZWF0ZSIsIm1pc3NpbmciLCJjbGVhbiIsImNvbnRhaW5lcnNPbmx5IiwiaW1hZ2VNYXRjaGVzIiwicHVzaCIsImltYWdlUHJlZml4IiwicmVtb3ZlSW1hZ2VzIiwidXNlVmVyc2lvbiIsImZvckVhY2giLCJob3N0UGF0aFRvTW91bnRTb3VyY2UiLCJob3N0UGF0aCIsInBsYXRmb3JtIiwicmVwbGFjZSIsImdldENvbXBpbGVyc01vdW50ZWRUbyIsImluZm8iLCJnZXRDb250YWluZXJJbmZvcyIsImNvbnRhaW5lcnNJbWFnZU1hdGNoZWQiLCJyZXF1aXJlZEltYWdlIiwiTW91bnRzIiwibW91bnQiLCJTb3VyY2UiLCJjb250YWluZXIiLCJjbGllbnQiLCJnZXRDb250YWluZXIiLCJJZCIsImlzUnVubmluZyIsImNyZWF0ZUNvbnRhaW5lck1vdW50ZWRUbyIsImd1ZXN0UGF0aCIsIm1vdW50RGVzdGluYXRpb24iLCJlbnN1cmVOZXR3b3JrIiwiZXhpc3RpbmciLCJjaGVja1VuaXF1ZU5hbWUiLCJhZGROZXR3b3JrcyIsInJlbW92ZU5ldHdvcmtzIiwiaW5kZXgiLCJmaW5kSW5kZXgiLCJzcGxpY2UiLCJ1cGRhdGVOZXR3b3JrQ29uZmlncyIsInVwZGF0ZSIsInNhdmVOYW1lIiwiaXNEZXZDb250YWluZXIiLCJpbWFnZUhhc01hdGNoZWROYW1lIiwiT2JqZWN0IiwiZnJlZXplIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBZ0JBOztBQUdBOztBQUVBOztBQUNBOztBQUVBOzs7O0FBRUEsTUFBTUEsRUFBRSxHQUFHQyxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFDQSxNQUFNQyxFQUFFLEdBQUdELE9BQU8sQ0FBQyxJQUFELENBQWxCOztBQUNBLE1BQU1FLElBQUksR0FBR0YsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBWUEsU0FBU0csZ0JBQVQsQ0FBMEJDLEdBQTFCLEVBQW9DQyxJQUFwQyxFQUEwRTtBQUN0RSxTQUFPQSxJQUFJLENBQUNDLE1BQUwsQ0FB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Q2QsSUFBeEI7QUFDQStFLE1BQUFBLE1BQU0sQ0FBQ2pFLE1BQUQsQ0FBTjs7QUFDQSxVQUFJQSxNQUFNLENBQUNkLElBQVAsQ0FBWUosV0FBWixPQUE4Qm9GLFFBQVEsQ0FBQ3BGLFdBQVQsRUFBbEMsRUFBMEQ7QUFDdEQsYUFBSzRFLGVBQUwsQ0FBcUIxRCxNQUFNLENBQUNkLElBQTVCO0FBQ0g7O0FBQ0R5QixNQUFBQSxPQUFPLENBQUNQLFNBQVIsQ0FBa0JKLE1BQWxCO0FBQ0gsS0FSRDtBQVNBLFNBQUtLLFVBQUw7QUFDQSxVQUFNLEtBQUtqQixNQUFMLENBQVkrQixpQkFBWixDQUE4QmpFLElBQTlCLEVBQW9Da0Usd0JBQWdCQyxPQUFwRCxDQUFOO0FBQ0g7O0FBRUQsU0FBTzhDLGNBQVAsQ0FBc0IxQixJQUF0QixFQUFxRDtBQUNqRCxXQUFPcEQsa0JBQVVzRCxzQkFBVixDQUFpQ0YsSUFBakMsRUFBdUNqRCxxQkFBVXdDLFdBQWpELEtBQ0EzQyxrQkFBVXNELHNCQUFWLENBQWlDRixJQUFqQyxFQUF1QzlDLGtCQUFRcUMsV0FBL0MsQ0FEUDtBQUVIOztBQUVELFNBQU9yRSxVQUFQLENBQWtCOEUsSUFBbEIsRUFBNkM7QUFDekMsV0FBT3BELGtCQUFVK0UsbUJBQVYsQ0FBOEIzQixJQUE5QixFQUFvQ2pELHFCQUFVd0MsV0FBOUMsS0FDQTNDLGtCQUFVK0UsbUJBQVYsQ0FBOEIzQixJQUE5QixFQUFvQzlDLGtCQUFRcUMsV0FBNUMsQ0FEUDtBQUVIOztBQTlPSzs7OztnQkFBSjFFLEcsbUJBQ2dDK0csTUFBTSxDQUFDQyxNQUFQLENBQWM7QUFDNUNqSCxFQUFBQSxTQUFTLEVBQUVtQyxxQkFBVUMsYUFEdUI7QUFFNUNDLEVBQUFBLFFBQVEsRUFBRSxDQUFDQyxrQkFBUUYsYUFBVDtBQUZrQyxDQUFkLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6IGh0dHBzOi8vd3d3LnRvbi5kZXYvbGljZW5zZXNcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKlxuICovXG4vLyBAZmxvd1xuXG5pbXBvcnQgeyBDb21waWxlcnMgfSBmcm9tIFwiLi9jb21waWxlcnMvY29tcGlsZXJzXCI7XG5pbXBvcnQgdHlwZSB7IENvbXBpbGVyc0NvbmZpZyB9IGZyb20gXCIuL2NvbXBpbGVycy9jb21waWxlcnNcIjtcbmltcG9ydCB0eXBlIHsgTmV0d29ya0NvbmZpZyB9IGZyb20gXCIuL25ldHdvcmtzL25ldHdvcmtzXCI7XG5pbXBvcnQgeyBOZXR3b3JrIH0gZnJvbSBcIi4vbmV0d29ya3MvbmV0d29ya3NcIjtcbmltcG9ydCB0eXBlIHsgQ29udGFpbmVyRGVmLCBEQ29udGFpbmVySW5mbywgREltYWdlSW5mbywgRE1vdW50LCBEb2NrZXJDb250YWluZXIgfSBmcm9tIFwiLi91dGlscy9kb2NrZXJcIjtcbmltcG9ydCB7IENvbnRhaW5lclN0YXR1cywgRGV2RG9ja2VyIH0gZnJvbSBcIi4vdXRpbHMvZG9ja2VyXCI7XG5pbXBvcnQgeyB0ZXh0cyB9IGZyb20gXCIuL3V0aWxzL3RleHRzXCI7XG5pbXBvcnQgdHlwZSB7IFBhdGhKb2luIH0gZnJvbSBcIi4vdXRpbHMvdXRpbHNcIjtcbmltcG9ydCB7IGJpbmRQYXRoSm9pblRvLCBicmVha1dvcmRzLCBpbnB1dExpbmUsIHRvbmxhYnNIb21lUGF0aCwgdmVyc2lvbiB9IGZyb20gXCIuL3V0aWxzL3V0aWxzXCI7XG5cbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IG9zID0gcmVxdWlyZSgnb3MnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbnR5cGUgRGV2Q29uZmlnID0ge1xuICAgIGNvbXBpbGVyczogQ29tcGlsZXJzQ29uZmlnLFxuICAgIG5ldHdvcmtzOiBOZXR3b3JrQ29uZmlnW10sXG59O1xuXG5leHBvcnQgdHlwZSBDb21waWxlcnNXaXRoTmV0d29ya3MgPSB7XG4gICAgY29tcGlsZXJzOiBib29sZWFuLFxuICAgIG5ldHdvcmtzOiBOZXR3b3JrW10sXG59XG5cbmZ1bmN0aW9uIGV4Y2x1ZGVDb21waWxlcnMoZGV2OiBEZXYsIGRlZnM6IENvbnRhaW5lckRlZltdKTogQ29udGFpbmVyRGVmW10ge1xuICAgIHJldHVybiBkZWZzLmZpbHRlcih4ID0+IHggIT09IGRldi5jb21waWxlcnMpO1xufVxuXG5jbGFzcyBEZXYge1xuICAgIHN0YXRpYyBkZWZhdWx0Q29uZmlnOiBEZXZDb25maWcgPSBPYmplY3QuZnJlZXplKHtcbiAgICAgICAgY29tcGlsZXJzOiBDb21waWxlcnMuZGVmYXVsdENvbmZpZyxcbiAgICAgICAgbmV0d29ya3M6IFtOZXR3b3JrLmRlZmF1bHRDb25maWddLFxuICAgIH0pO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB2ZXJzaW9uOiBzdHJpbmc7XG4gICAgZG9ja2VyOiBEZXZEb2NrZXI7XG4gICAgbmV0d29ya3M6IE5ldHdvcmtbXTtcbiAgICBjb21waWxlcnM6IENvbXBpbGVycztcbiAgICBhZ3JlZW1lbnRSZXF1aXJlZDogYm9vbGVhbjtcbiAgICBjb25maWdGaWxlUGF0aDogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMubmFtZSA9ICd0b25kZXYnO1xuICAgICAgICB0aGlzLnZlcnNpb24gPSB2ZXJzaW9uO1xuICAgICAgICB0aGlzLmFncmVlbWVudFJlcXVpcmVkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5kb2NrZXIgPSBuZXcgRGV2RG9ja2VyKCk7XG4gICAgICAgIHRoaXMuZG9ja2VyLm9uU3RhcnR1cEltYWdlcyA9IHRoaXMub25TdGFydHVwSW1hZ2VzO1xuICAgICAgICB0aGlzLmRvY2tlci5vbkJlZm9yZVB1bGwgPSB0aGlzLm9uQmVmb3JlUHVsbDtcbiAgICAgICAgdGhpcy5jb21waWxlcnMgPSBuZXcgQ29tcGlsZXJzKENvbXBpbGVycy5kZWZhdWx0Q29uZmlnKTtcbiAgICAgICAgdGhpcy5uZXR3b3JrcyA9IFtuZXcgTmV0d29yayhOZXR3b3JrLmRlZmF1bHRDb25maWcpXTtcbiAgICAgICAgdGhpcy5jb25maWdGaWxlUGF0aCA9IHRvbmxhYnNIb21lUGF0aCgnY29uZmlnLmpzb24nKTtcbiAgICAgICAgZnMubWtkaXJTeW5jKHRvbmxhYnNIb21lUGF0aCgpLCAoeyByZWN1cnNpdmU6IHRydWUgfTogYW55KSk7XG4gICAgICAgIHRoaXMubG9hZENvbmZpZygpO1xuICAgIH1cblxuICAgIGxvYWRDb25maWcoKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBjb25maWc6IERldkNvbmZpZyA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKHRoaXMuY29uZmlnRmlsZVBhdGgsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KSk7XG4gICAgICAgICAgICB0aGlzLmNvbXBpbGVycy5zZXRDb25maWcoY29uZmlnLmNvbXBpbGVycyk7XG4gICAgICAgICAgICB0aGlzLm5ldHdvcmtzID0gY29uZmlnLm5ldHdvcmtzLm1hcCh4ID0+IG5ldyBOZXR3b3JrKHgpKTtcbiAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHNhdmVDb25maWcoKSB7XG4gICAgICAgIGNvbnN0IGNvbmZpZzogRGV2Q29uZmlnID0ge1xuICAgICAgICAgICAgY29tcGlsZXJzOiB0aGlzLmNvbXBpbGVycy5nZXRDb25maWcoKSxcbiAgICAgICAgICAgIG5ldHdvcmtzOiB0aGlzLm5ldHdvcmtzLm1hcCh4ID0+IHguZ2V0Q29uZmlnKCkpLFxuICAgICAgICB9O1xuICAgICAgICBmcy5ta2RpclN5bmModG9ubGFic0hvbWVQYXRoKCcnKSwgKHsgcmVjdXJzaXZlOiB0cnVlIH06IGFueSkpO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHRoaXMuY29uZmlnRmlsZVBhdGgsIEpTT04uc3RyaW5naWZ5KGNvbmZpZyksIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KTtcbiAgICB9XG5cbiAgICBvblN0YXJ0dXBJbWFnZXMgPSAoaW1hZ2VzOiBESW1hZ2VJbmZvW10pID0+IHtcbiAgICAgICAgdGhpcy5hZ3JlZW1lbnRSZXF1aXJlZCA9ICFpbWFnZXMuZmluZChEZXYuaXNEZXZJbWFnZSk7XG4gICAgfTtcblxuICAgIG9uQmVmb3JlUHVsbCA9IGFzeW5jIChfcmVwb1RhZzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgICAgIGlmICghdGhpcy5hZ3JlZW1lbnRSZXF1aXJlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGxpY2Vuc2UgPSBmc1xuICAgICAgICAgICAgLnJlYWRGaWxlU3luYyhwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnTElDRU5TRScpKVxuICAgICAgICAgICAgLnRvU3RyaW5nKClcbiAgICAgICAgICAgIC5zcGxpdCgnXFxuJylcbiAgICAgICAgICAgIC5tYXAoYnJlYWtXb3Jkcykuam9pbignXFxuJyk7XG4gICAgICAgIGNvbnNvbGUubG9nKGxpY2Vuc2UpO1xuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSh0ZXh0cy5hZ3JlZW1lbnRDb25maXJtYXRpb24pO1xuICAgICAgICBjb25zdCBhbnN3ZXIgPSAoYXdhaXQgaW5wdXRMaW5lKCkpLnRyaW0oKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBpZiAoYW5zd2VyICE9PSAneWVzJykge1xuICAgICAgICAgICAgY29uc29sZS5sb2codGV4dHMuYWdyZWVtZW50UmVqZWN0ZWQpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDApO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKHRleHRzLmFncmVlbWVudEFjY2VwdGVkKTtcbiAgICAgICAgdGhpcy5hZ3JlZW1lbnRSZXF1aXJlZCA9IGZhbHNlO1xuICAgIH07XG5cbiAgICBuZXR3b3Jrc0Zyb21OYW1lcyhuYW1lczogc3RyaW5nW10pOiBOZXR3b3JrW10ge1xuICAgICAgICByZXR1cm4gbmFtZXMubWFwKChuYW1lKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBuZXR3b3JrID0gdGhpcy5uZXR3b3Jrcy5maW5kKHggPT4geC5uYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKSk7XG4gICAgICAgICAgICBpZiAoIW5ldHdvcmspIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5ldHdvcmsgbm90IGZvdW5kOiAke25hbWV9YClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBuZXR3b3JrO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBuZXR3b3Jrc09yQWxsKG5hbWVzOiBzdHJpbmdbXSk6IE5ldHdvcmtbXSB7XG4gICAgICAgIHJldHVybiBuYW1lcy5sZW5ndGggPiAwID8gdGhpcy5uZXR3b3Jrc0Zyb21OYW1lcyhuYW1lcykgOiB0aGlzLm5ldHdvcmtzO1xuICAgIH1cblxuICAgIGdldERlZnMoc291cmNlOiBDb21waWxlcnNXaXRoTmV0d29ya3MpOiBDb250YWluZXJEZWZbXSB7XG4gICAgICAgIHJldHVybiBzb3VyY2UuY29tcGlsZXJzID8gc291cmNlLm5ldHdvcmtzLmNvbmNhdCh0aGlzLmNvbXBpbGVycykgOiBbLi4uc291cmNlLm5ldHdvcmtzXTtcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydChzb3VyY2U6IENvbXBpbGVyc1dpdGhOZXR3b3Jrcykge1xuICAgICAgICBhd2FpdCB0aGlzLmRvY2tlci5zdGFydHVwQ29udGFpbmVycyhleGNsdWRlQ29tcGlsZXJzKHRoaXMsIHRoaXMuZ2V0RGVmcyhzb3VyY2UpKSwgQ29udGFpbmVyU3RhdHVzLnJ1bm5pbmcpO1xuICAgIH1cblxuICAgIGFzeW5jIHN0b3Aoc291cmNlOiBDb21waWxlcnNXaXRoTmV0d29ya3MpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5kb2NrZXIuc2h1dGRvd25Db250YWluZXJzKHRoaXMuZ2V0RGVmcyhzb3VyY2UpLCBDb250YWluZXJTdGF0dXMuY3JlYXRlZCk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVzdGFydChzb3VyY2U6IENvbXBpbGVyc1dpdGhOZXR3b3Jrcykge1xuICAgICAgICBjb25zdCBkZWZzID0gdGhpcy5nZXREZWZzKHNvdXJjZSk7XG4gICAgICAgIGF3YWl0IHRoaXMuZG9ja2VyLnNodXRkb3duQ29udGFpbmVycyhkZWZzLCBDb250YWluZXJTdGF0dXMuY3JlYXRlZCk7XG4gICAgICAgIGF3YWl0IHRoaXMuZG9ja2VyLnN0YXJ0dXBDb250YWluZXJzKGV4Y2x1ZGVDb21waWxlcnModGhpcywgZGVmcyksIENvbnRhaW5lclN0YXR1cy5ydW5uaW5nKTtcbiAgICB9XG5cbiAgICBhc3luYyByZWNyZWF0ZShzb3VyY2U6IENvbXBpbGVyc1dpdGhOZXR3b3Jrcykge1xuICAgICAgICBjb25zdCBkZWZzID0gdGhpcy5nZXREZWZzKHNvdXJjZSk7XG4gICAgICAgIGF3YWl0IHRoaXMuZG9ja2VyLnNodXRkb3duQ29udGFpbmVycyhkZWZzLCBDb250YWluZXJTdGF0dXMubWlzc2luZyk7XG4gICAgICAgIGF3YWl0IHRoaXMuZG9ja2VyLnN0YXJ0dXBDb250YWluZXJzKGV4Y2x1ZGVDb21waWxlcnModGhpcywgZGVmcyksIENvbnRhaW5lclN0YXR1cy5jcmVhdGVkKTtcbiAgICB9XG5cblxuICAgIGFzeW5jIGNsZWFuKGNvbXBpbGVyczogYm9vbGVhbiwgbmV0d29ya3M6IGJvb2xlYW4sIGNvbnRhaW5lcnNPbmx5OiBib29sZWFuKSB7XG4gICAgICAgIGNvbnN0IGltYWdlTWF0Y2hlcyA9IFtdO1xuICAgICAgICBpZiAoY29tcGlsZXJzKSB7XG4gICAgICAgICAgICBpbWFnZU1hdGNoZXMucHVzaChDb21waWxlcnMuaW1hZ2VQcmVmaXgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChuZXR3b3Jrcykge1xuICAgICAgICAgICAgaW1hZ2VNYXRjaGVzLnB1c2goTmV0d29yay5pbWFnZVByZWZpeCk7XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgdGhpcy5kb2NrZXIucmVtb3ZlSW1hZ2VzKGltYWdlTWF0Y2hlcywgY29udGFpbmVyc09ubHkpO1xuICAgIH1cblxuICAgIGFzeW5jIHVzZVZlcnNpb24odmVyc2lvbjogc3RyaW5nLCBzb3VyY2U6IENvbXBpbGVyc1dpdGhOZXR3b3Jrcykge1xuICAgICAgICBjb25zdCBkZWZzID0gdGhpcy5nZXREZWZzKHNvdXJjZSk7XG4gICAgICAgIGF3YWl0IHRoaXMuZG9ja2VyLnNodXRkb3duQ29udGFpbmVycyhkZWZzLCBDb250YWluZXJTdGF0dXMubWlzc2luZyk7XG4gICAgICAgIGlmIChzb3VyY2UuY29tcGlsZXJzKSB7XG4gICAgICAgICAgICB0aGlzLmNvbXBpbGVycy5zZXRDb25maWcoe1xuICAgICAgICAgICAgICAgIC4uLnRoaXMuY29tcGlsZXJzLmdldENvbmZpZygpLFxuICAgICAgICAgICAgICAgIHZlcnNpb25cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHNvdXJjZS5uZXR3b3Jrcy5mb3JFYWNoKChuZXR3b3JrKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb25maWcgPSBuZXR3b3JrLmdldENvbmZpZygpO1xuICAgICAgICAgICAgY29uZmlnLnZlcnNpb24gPSB2ZXJzaW9uO1xuICAgICAgICAgICAgbmV0d29yay5zZXRDb25maWcoY29uZmlnKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc2F2ZUNvbmZpZygpO1xuICAgICAgICBhd2FpdCB0aGlzLmRvY2tlci5zdGFydHVwQ29udGFpbmVycyhleGNsdWRlQ29tcGlsZXJzKHRoaXMsIGRlZnMpLCBDb250YWluZXJTdGF0dXMucnVubmluZyk7XG4gICAgfVxuXG4gICAgLy8gQ29tcGlsZXJzXG5cbiAgICBob3N0UGF0aFRvTW91bnRTb3VyY2UoaG9zdFBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGlmIChvcy5wbGF0Zm9ybSgpICE9PSAnd2luMzInKSB7XG4gICAgICAgICAgICByZXR1cm4gaG9zdFBhdGgudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYC9ob3N0X21udC8ke2hvc3RQYXRoLnJlcGxhY2UoLzpcXFxcfFxcXFwvZywgJy8nKS50b0xvd2VyQ2FzZSgpfWA7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0Q29tcGlsZXJzTW91bnRlZFRvKGhvc3RQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHtjb250YWluZXI6IERvY2tlckNvbnRhaW5lciwgZ3Vlc3RQYXRoOiBQYXRoSm9pbn0+IHtcbiAgICAgICAgbGV0IGluZm8gPSAoYXdhaXQgdGhpcy5kb2NrZXIuZ2V0Q29udGFpbmVySW5mb3MoKSkuZmluZCgoaW5mbzogRENvbnRhaW5lckluZm8pID0+IHtcbiAgICAgICAgICAgIHJldHVybiBEZXZEb2NrZXIuY29udGFpbmVyc0ltYWdlTWF0Y2hlZChpbmZvLCB0aGlzLmNvbXBpbGVycy5yZXF1aXJlZEltYWdlKVxuICAgICAgICAgICAgICAgICYmIGluZm8uTW91bnRzLmZpbmQoKG1vdW50OiBETW91bnQpID0+IG1vdW50LlNvdXJjZS50b0xvd2VyQ2FzZSgpID09PSB0aGlzLmhvc3RQYXRoVG9Nb3VudFNvdXJjZShob3N0UGF0aCkpO1xuICAgICAgICB9KTtcbiAgICAgICAgbGV0IGNvbnRhaW5lcjogRG9ja2VyQ29udGFpbmVyO1xuICAgICAgICBpZiAoaW5mbykge1xuICAgICAgICAgICAgY29udGFpbmVyID0gdGhpcy5kb2NrZXIuY2xpZW50LmdldENvbnRhaW5lcihpbmZvLklkKTtcbiAgICAgICAgICAgIGlmICghRGV2RG9ja2VyLmlzUnVubmluZyhpbmZvKSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IGNvbnRhaW5lci5zdGFydCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29udGFpbmVyID0gYXdhaXQgdGhpcy5jb21waWxlcnMuY3JlYXRlQ29udGFpbmVyTW91bnRlZFRvKGhvc3RQYXRoLCB0aGlzLmRvY2tlcik7XG4gICAgICAgICAgICBhd2FpdCBjb250YWluZXIuc3RhcnQoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29udGFpbmVyLFxuICAgICAgICAgICAgZ3Vlc3RQYXRoOiBiaW5kUGF0aEpvaW5Ubyh0aGlzLmNvbXBpbGVycy5tb3VudERlc3RpbmF0aW9uLCAnLycpXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gTmV0d29ya3NcblxuICAgIGVuc3VyZU5ldHdvcmsobmFtZTogc3RyaW5nKTogTmV0d29yayB7XG4gICAgICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5uZXR3b3Jrcy5maW5kKHggPT4geC5uYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKSk7XG4gICAgICAgIGlmIChleGlzdGluZykge1xuICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG5ldHdvcmsgPSBuZXcgTmV0d29yayh7XG4gICAgICAgICAgICAuLi5OZXR3b3JrLmRlZmF1bHRDb25maWcsXG4gICAgICAgICAgICBuYW1lXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLm5ldHdvcmtzLnB1c2gobmV0d29yayk7XG4gICAgICAgIHJldHVybiBuZXR3b3JrO1xuICAgIH1cblxuICAgIGNoZWNrVW5pcXVlTmFtZShuYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKHRoaXMubmV0d29ya3MuZmluZCh4ID0+IHgubmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCkpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5ldHdvcmsgd2l0aCBuYW1lIFske25hbWV9XSBhbHJlYWR5IGV4aXN0c2ApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYWRkTmV0d29ya3MobmFtZXM6IHN0cmluZ1tdKSB7XG4gICAgICAgIG5hbWVzLmZvckVhY2goKG5hbWUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuY2hlY2tVbmlxdWVOYW1lKG5hbWUpO1xuICAgICAgICAgICAgY29uc3QgbmV0d29yayA9IG5ldyBOZXR3b3JrKHtcbiAgICAgICAgICAgICAgICAuLi5OZXR3b3JrLmRlZmF1bHRDb25maWcsXG4gICAgICAgICAgICAgICAgbmFtZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLm5ldHdvcmtzLnB1c2gobmV0d29yayk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNhdmVDb25maWcoKTtcbiAgICB9XG5cblxuICAgIGFzeW5jIHJlbW92ZU5ldHdvcmtzKG5ldHdvcmtzOiBOZXR3b3JrW10pIHtcbiAgICAgICAgYXdhaXQgdGhpcy5kb2NrZXIuc2h1dGRvd25Db250YWluZXJzKG5ldHdvcmtzLCBDb250YWluZXJTdGF0dXMubWlzc2luZyk7XG4gICAgICAgIG5ldHdvcmtzLmZvckVhY2goKG5ldHdvcmspID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5uZXR3b3Jrcy5maW5kSW5kZXgoeCA9PiB4ID09PSBuZXR3b3JrKTtcbiAgICAgICAgICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5uZXR3b3Jrcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zYXZlQ29uZmlnKCk7XG4gICAgfVxuXG5cbiAgICBhc3luYyB1cGRhdGVOZXR3b3JrQ29uZmlncyhuZXR3b3JrczogTmV0d29ya1tdLCB1cGRhdGU6IChjb25maWc6IE5ldHdvcmtDb25maWcpID0+IHZvaWQpIHtcbiAgICAgICAgY29uc3QgZGVmcyA9IFsuLi5uZXR3b3Jrc107XG4gICAgICAgIGF3YWl0IHRoaXMuZG9ja2VyLnNodXRkb3duQ29udGFpbmVycyhkZWZzLCBDb250YWluZXJTdGF0dXMubWlzc2luZyk7XG4gICAgICAgIG5ldHdvcmtzLmZvckVhY2goKG5ldHdvcmspID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbmZpZyA9IG5ldHdvcmsuZ2V0Q29uZmlnKCk7XG4gICAgICAgICAgICBjb25zdCBzYXZlTmFtZSA9IGNvbmZpZy5uYW1lO1xuICAgICAgICAgICAgdXBkYXRlKGNvbmZpZyk7XG4gICAgICAgICAgICBpZiAoY29uZmlnLm5hbWUudG9Mb3dlckNhc2UoKSAhPT0gc2F2ZU5hbWUudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tVbmlxdWVOYW1lKGNvbmZpZy5uYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5ldHdvcmsuc2V0Q29uZmlnKGNvbmZpZylcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc2F2ZUNvbmZpZygpO1xuICAgICAgICBhd2FpdCB0aGlzLmRvY2tlci5zdGFydHVwQ29udGFpbmVycyhkZWZzLCBDb250YWluZXJTdGF0dXMucnVubmluZyk7XG4gICAgfVxuXG4gICAgc3RhdGljIGlzRGV2Q29udGFpbmVyKGluZm86IERDb250YWluZXJJbmZvKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBEZXZEb2NrZXIuY29udGFpbmVyc0ltYWdlTWF0Y2hlZChpbmZvLCBDb21waWxlcnMuaW1hZ2VQcmVmaXgpXG4gICAgICAgICAgICB8fCBEZXZEb2NrZXIuY29udGFpbmVyc0ltYWdlTWF0Y2hlZChpbmZvLCBOZXR3b3JrLmltYWdlUHJlZml4KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgaXNEZXZJbWFnZShpbmZvOiBESW1hZ2VJbmZvKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBEZXZEb2NrZXIuaW1hZ2VIYXNNYXRjaGVkTmFtZShpbmZvLCBDb21waWxlcnMuaW1hZ2VQcmVmaXgpXG4gICAgICAgICAgICB8fCBEZXZEb2NrZXIuaW1hZ2VIYXNNYXRjaGVkTmFtZShpbmZvLCBOZXR3b3JrLmltYWdlUHJlZml4KTtcbiAgICB9XG59XG5cbmV4cG9ydCB7IERldiB9O1xuIl19