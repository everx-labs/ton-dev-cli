"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ClientCode = exports.JSModule = exports.ClientCodeLevel = void 0;

var _utils = require("../utils/utils");

var _handlebars = _interopRequireDefault(require("handlebars"));

var _solidity = require("./solidity");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const path = require('path');

const fs = require('fs');

_handlebars.default.registerHelper('LB', () => '{');

_handlebars.default.registerHelper('RB', () => '}');

function compileTemplate(...pathItems) {
  const templatePath = path.resolve(__dirname, '..', '..', ...pathItems);
  const templateText = fs.readFileSync(templatePath, {
    encoding: 'utf8'
  });
  return {
    build: _handlebars.default.compile(templateText, {
      noEscape: true
    })
  };
}

async function applyTemplate(template, context) {
  return template.build(context);
}

const jsContractTemplate = compileTemplate('js-templates', 'contract.js.hbs');
const ClientCodeLevel = {
  none: 'none',
  run: 'run',
  deploy: 'deploy'
};
exports.ClientCodeLevel = ClientCodeLevel;
const JSModule = {
  node: 'node',
  nodeNoDefault: 'nodeNoDefault',
  es: 'es',
  esNoDefault: 'esNoDefault'
};
exports.JSModule = JSModule;

class ClientCode {
  static register(language) {
    ClientCode.languages[language.shortName.toLowerCase()] = language;
  }

  static async generate(files, options) {
    for (const name of options.clientLanguages) {
      const language = ClientCode.languages[name.toLocaleLowerCase()];

      if (!language) {
        throw Error(`Unknown client code language: ${name}`);
      }

      await language.generate(files, options);
    }
  }

}

exports.ClientCode = ClientCode;

_defineProperty(ClientCode, "languages", {});

const JsClientCode = {
  name: 'JavaScript',
  shortName: 'js',

  getTemplateContext(fileArg, options) {
    const file = (0, _solidity.parseSolidityFileArg)(fileArg, false);
    const {
      dir,
      name
    } = file;

    const readText = (name, encoding) => {
      if (!fs.existsSync(dir(name))) {
        throw new Error(`File not exists: ${name}`);
      }

      return fs.readFileSync(dir(name)).toString(encoding);
    };

    const imageBase64 = options.clientLevel === ClientCodeLevel.deploy ? readText(name.tvc, 'base64') : '';
    const abiJson = readText(name.abi, 'utf8').trimRight();
    const abi = {
      functions: [],
      data: [],
      ...JSON.parse(abiJson)
    };
    const className = `${name.base[0].toUpperCase()}${name.base.substr(1)}Contract`;
    const isDeploy = (options.clientLevel || 'deploy') === 'deploy';

    const varContext = v => {
      const jsType = {
        address: 'string',
        'address[]': 'string[]',
        uint256: 'string',
        uint32: 'number',
        uint16: 'number',
        uint8: 'number',
        'uint256[]': 'string[]',
        'uint32[]': 'number[]',
        'uint16[]': 'number[]',
        'uint8[]': 'number[]'
      }[v.type] || v.type;
      return { ...v,
        jsType,
        isSameJsType: jsType === v.type
      };
    };

    const funContext = f => {
      return { ...f,
        hasData: false,
        hasInputsAndData: false,
        hasInputs: f.inputs.length > 0,
        hasOutputs: f.outputs.length > 0,
        inputs: f.inputs.map(varContext),
        outputs: f.outputs.map(varContext)
      };
    };

    const constructor = funContext(abi.functions.find(x => x.name === 'constructor') || {
      name: 'constructor',
      inputs: [],
      outputs: [],
      data: []
    });
    constructor.hasData = abi.data.length > 0;
    constructor.hasInputsAndData = constructor.hasInputs && constructor.hasData;
    constructor.data = abi.data.map(varContext);
    const functions = abi.functions.filter(x => x.name !== 'constructor').map(funContext);
    return {
      imageBase64,
      abiJson,
      abi,
      className,
      isDeploy,
      constructor,
      functions,
      jsModuleNode: options.jsModule === JSModule.node || options.jsModule === JSModule.nodeNoDefault,
      jsModuleNodeDefault: options.jsModule === JSModule.node,
      jsModuleEs: options.jsModule === JSModule.es || options.jsModule === JSModule.esNoDefault,
      jsModuleEsDefault: options.jsModule === JSModule.es
    };
  },

  async generate(files, options) {
    for (const file of files) {
      const {
        dir,
        base
      } = (0, _utils.parseFileArg)(file, '.sol', false);
      const js = await applyTemplate(jsContractTemplate, JsClientCode.getTemplateContext(file, options));
      fs.writeFileSync(dir(`${base}Contract.js`), js, {
        encoding: 'utf8'
      });
    }
  }

};
ClientCode.register(JsClientCode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21waWxlcnMvY2xpZW50LWNvZGUuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJmcyIsIkhhbmRsZWJhcnMiLCJyZWdpc3RlckhlbHBlciIsImNvbXBpbGVUZW1wbGF0ZSIsInBhdGhJdGVtcyIsInRlbXBsYXRlUGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJ0ZW1wbGF0ZVRleHQiLCJyZWFkRmlsZVN5bmMiLCJlbmNvZGluZyIsImJ1aWxkIiwiY29tcGlsZSIsIm5vRXNjYXBlIiwiYXBwbHlUZW1wbGF0ZSIsInRlbXBsYXRlIiwiY29udGV4dCIsImpzQ29udHJhY3RUZW1wbGF0ZSIsIkNsaWVudENvZGVMZXZlbCIsIm5vbmUiLCJydW4iLCJkZXBsb3kiLCJKU01vZHVsZSIsIm5vZGUiLCJub2RlTm9EZWZhdWx0IiwiZXMiLCJlc05vRGVmYXVsdCIsIkNsaWVudENvZGUiLCJyZWdpc3RlciIsImxhbmd1YWdlIiwibGFuZ3VhZ2VzIiwic2hvcnROYW1lIiwidG9Mb3dlckNhc2UiLCJnZW5lcmF0ZSIsImZpbGVzIiwib3B0aW9ucyIsIm5hbWUiLCJjbGllbnRMYW5ndWFnZXMiLCJ0b0xvY2FsZUxvd2VyQ2FzZSIsIkVycm9yIiwiSnNDbGllbnRDb2RlIiwiZ2V0VGVtcGxhdGVDb250ZXh0IiwiZmlsZUFyZyIsImZpbGUiLCJkaXIiLCJyZWFkVGV4dCIsImV4aXN0c1N5bmMiLCJ0b1N0cmluZyIsImltYWdlQmFzZTY0IiwiY2xpZW50TGV2ZWwiLCJ0dmMiLCJhYmlKc29uIiwiYWJpIiwidHJpbVJpZ2h0IiwiZnVuY3Rpb25zIiwiZGF0YSIsIkpTT04iLCJwYXJzZSIsImNsYXNzTmFtZSIsImJhc2UiLCJ0b1VwcGVyQ2FzZSIsInN1YnN0ciIsImlzRGVwbG95IiwidmFyQ29udGV4dCIsInYiLCJqc1R5cGUiLCJhZGRyZXNzIiwidWludDI1NiIsInVpbnQzMiIsInVpbnQxNiIsInVpbnQ4IiwidHlwZSIsImlzU2FtZUpzVHlwZSIsImZ1bkNvbnRleHQiLCJmIiwiaGFzRGF0YSIsImhhc0lucHV0c0FuZERhdGEiLCJoYXNJbnB1dHMiLCJpbnB1dHMiLCJsZW5ndGgiLCJoYXNPdXRwdXRzIiwib3V0cHV0cyIsIm1hcCIsImNvbnN0cnVjdG9yIiwiZmluZCIsIngiLCJmaWx0ZXIiLCJqc01vZHVsZU5vZGUiLCJqc01vZHVsZSIsImpzTW9kdWxlTm9kZURlZmF1bHQiLCJqc01vZHVsZUVzIiwianNNb2R1bGVFc0RlZmF1bHQiLCJqcyIsIndyaXRlRmlsZVN5bmMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFpQkE7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFNQUUsb0JBQVdDLGNBQVgsQ0FBMEIsSUFBMUIsRUFBZ0MsTUFBTSxHQUF0Qzs7QUFDQUQsb0JBQVdDLGNBQVgsQ0FBMEIsSUFBMUIsRUFBZ0MsTUFBTSxHQUF0Qzs7QUFFQSxTQUFTQyxlQUFULENBQXlCLEdBQUdDLFNBQTVCLEVBQTJEO0FBQ3ZELFFBQU1DLFlBQVksR0FBR1AsSUFBSSxDQUFDUSxPQUFMLENBQWFDLFNBQWIsRUFBd0IsSUFBeEIsRUFBOEIsSUFBOUIsRUFBb0MsR0FBR0gsU0FBdkMsQ0FBckI7QUFDQSxRQUFNSSxZQUFZLEdBQUdSLEVBQUUsQ0FBQ1MsWUFBSCxDQUFnQkosWUFBaEIsRUFBOEI7QUFBRUssSUFBQUEsUUFBUSxFQUFFO0FBQVosR0FBOUIsQ0FBckI7QUFDQSxTQUFPO0FBQ0hDLElBQUFBLEtBQUssRUFBRVYsb0JBQVdXLE9BQVgsQ0FBbUJKLFlBQW5CLEVBQWlDO0FBQ3BDSyxNQUFBQSxRQUFRLEVBQUU7QUFEMEIsS0FBakM7QUFESixHQUFQO0FBS0g7O0FBRUQsZUFBZUMsYUFBZixDQUE2QkMsUUFBN0IsRUFBaURDLE9BQWpELEVBQWdGO0FBQzVFLFNBQU9ELFFBQVEsQ0FBQ0osS0FBVCxDQUFl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QUFxQmxFLFFBQVEsQ0FBQ0MsSUFUaEQ7QUFVSG1FLE1BQUFBLFVBQVUsRUFBRXZELE9BQU8sQ0FBQ3FELFFBQVIsS0FBcUJsRSxRQUFRLENBQUNHLEVBQTlCLElBQW9DVSxPQUFPLENBQUNxRCxRQUFSLEtBQXFCbEUsUUFBUSxDQUFDSSxXQVYzRTtBQVdIaUUsTUFBQUEsaUJBQWlCLEVBQUV4RCxPQUFPLENBQUNxRCxRQUFSLEtBQXFCbEUsUUFBUSxDQUFDRztBQVg5QyxLQUFQO0FBYUgsR0FsRmdCOztBQW1GakIsUUFBTVEsUUFBTixDQUFlQyxLQUFmLEVBQWdDQyxPQUFoQyxFQUE0RDtBQUN4RCxTQUFLLE1BQU1RLElBQVgsSUFBbUJULEtBQW5CLEVBQTBCO0FBQ3RCLFlBQU07QUFBRVUsUUFBQUEsR0FBRjtBQUFPZSxRQUFBQTtBQUFQLFVBQWdCLHlCQUFhaEIsSUFBYixFQUFtQixNQUFuQixFQUEyQixLQUEzQixDQUF0QjtBQUNBLFlBQU1pRCxFQUFFLEdBQUcsTUFBTTlFLGFBQWEsQ0FBQ0csa0JBQUQsRUFBcUJ1QixZQUFZLENBQUNDLGtCQUFiLENBQWdDRSxJQUFoQyxFQUFzQ1IsT0FBdEMsQ0FBckIsQ0FBOUI7QUFDQW5DLE1BQUFBLEVBQUUsQ0FBQzZGLGFBQUgsQ0FBaUJqRCxHQUFHLENBQUUsR0FBRWUsSUFBSyxhQUFULENBQXBCLEVBQTRDaUMsRUFBNUMsRUFBZ0Q7QUFBRWxGLFFBQUFBLFFBQVEsRUFBRTtBQUFaLE9BQWhEO0FBQ0g7QUFDSjs7QUF6RmdCLENBQXJCO0FBNEZBaUIsVUFBVSxDQUFDQyxRQUFYLENBQW9CWSxZQUFwQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOC0yMDIwIFRPTiBERVYgU09MVVRJT05TIExURC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcbiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZVxuICogTGljZW5zZSBhdDogaHR0cHM6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqXG4gKi9cblxuLy8gQGZsb3dcblxuaW1wb3J0IHsgcGFyc2VGaWxlQXJnIH0gZnJvbSBcIi4uL3V0aWxzL3V0aWxzXCI7XG5pbXBvcnQgSGFuZGxlYmFycyBmcm9tICdoYW5kbGViYXJzJztcbmltcG9ydCB7IHBhcnNlU29saWRpdHlGaWxlQXJnIH0gZnJvbSBcIi4vc29saWRpdHlcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcblxudHlwZSBUZW1wbGF0ZSA9IHtcbiAgICBidWlsZDogYW55XG59XG5cbkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ0xCJywgKCkgPT4gJ3snKTtcbkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ1JCJywgKCkgPT4gJ30nKTtcblxuZnVuY3Rpb24gY29tcGlsZVRlbXBsYXRlKC4uLnBhdGhJdGVtczogc3RyaW5nW10pOiBUZW1wbGF0ZSB7XG4gICAgY29uc3QgdGVtcGxhdGVQYXRoID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgLi4ucGF0aEl0ZW1zKTtcbiAgICBjb25zdCB0ZW1wbGF0ZVRleHQgPSBmcy5yZWFkRmlsZVN5bmModGVtcGxhdGVQYXRoLCB7IGVuY29kaW5nOiAndXRmOCcgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgYnVpbGQ6IEhhbmRsZWJhcnMuY29tcGlsZSh0ZW1wbGF0ZVRleHQsIHtcbiAgICAgICAgICAgIG5vRXNjYXBlOiB0cnVlLFxuICAgICAgICB9KVxuICAgIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGFwcGx5VGVtcGxhdGUodGVtcGxhdGU6IFRlbXBsYXRlLCBjb250ZXh0OiBhbnkpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiB0ZW1wbGF0ZS5idWlsZChjb250ZXh0KTtcbn1cblxuY29uc3QganNDb250cmFjdFRlbXBsYXRlID0gY29tcGlsZVRlbXBsYXRlKCdqcy10ZW1wbGF0ZXMnLCAnY29udHJhY3QuanMuaGJzJyk7XG5cbmV4cG9ydCBjb25zdCBDbGllbnRDb2RlTGV2ZWwgPSB7XG4gICAgbm9uZTogJ25vbmUnLFxuICAgIHJ1bjogJ3J1bicsXG4gICAgZGVwbG95OiAnZGVwbG95J1xufTtcblxuZXhwb3J0IHR5cGUgQ2xpZW50Q29kZUxldmVsVHlwZSA9ICRLZXlzPHR5cGVvZiBDbGllbnRDb2RlTGV2ZWw+O1xuXG5leHBvcnQgdHlwZSBDbGllbnRDb2RlTGFuZ3VhZ2VUeXBlID0gc3RyaW5nO1xuXG5leHBvcnQgY29uc3QgSlNNb2R1bGUgPSB7XG4gICAgbm9kZTogJ25vZGUnLFxuICAgIG5vZGVOb0RlZmF1bHQ6ICdub2RlTm9EZWZhdWx0JyxcbiAgICBlczogJ2VzJyxcbiAgICBlc05vRGVmYXVsdDogJ2VzTm9EZWZhdWx0Jyxcbn07XG5cbmV4cG9ydCB0eXBlIEpTTW9kdWxlVHlwZSA9ICRLZXlzPHR5cGVvZiBKU01vZHVsZT47XG5cbmV4cG9ydCB0eXBlIENsaWVudENvZGVPcHRpb25zID0ge1xuICAgIGNsaWVudExhbmd1YWdlczogQ2xpZW50Q29kZUxhbmd1YWdlVHlwZVtdLFxuICAgIGNsaWVudExldmVsOiBDbGllbnRDb2RlTGV2ZWxUeXBlLFxuICAgIGpzTW9kdWxlOiBKU01vZHVsZVR5cGUsXG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIENsaWVudENvZGVMYW5ndWFnZSB7XG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHNob3J0TmFtZTogc3RyaW5nLFxuICAgIGdlbmVyYXRlOiAoZmlsZXM6IHN0cmluZ1tdLCBvcHRpb25zOiBDbGllbnRDb2RlT3B0aW9ucykgPT4gUHJvbWlzZTx2b2lkPlxufVxuXG5leHBvcnQgY2xhc3MgQ2xpZW50Q29kZSB7XG4gICAgc3RhdGljIGxhbmd1YWdlczogeyBbc3RyaW5nXTogQ2xpZW50Q29kZUxhbmd1YWdlIH0gPSB7fTtcblxuICAgIHN0YXRpYyByZWdpc3RlcihsYW5ndWFnZTogQ2xpZW50Q29kZUxhbmd1YWdlKSB7XG4gICAgICAgIENsaWVudENvZGUubGFuZ3VhZ2VzW2xhbmd1YWdlLnNob3J0TmFtZS50b0xvd2VyQ2FzZSgpXSA9IGxhbmd1YWdlO1xuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyBnZW5lcmF0ZShmaWxlczogc3RyaW5nW10sIG9wdGlvbnM6IENsaWVudENvZGVPcHRpb25zKSB7XG4gICAgICAgIGZvciAoY29uc3QgbmFtZSBvZiBvcHRpb25zLmNsaWVudExhbmd1YWdlcykge1xuICAgICAgICAgICAgY29uc3QgbGFuZ3VhZ2UgPSBDbGllbnRDb2RlLmxhbmd1YWdlc1tuYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCldO1xuICAgICAgICAgICAgaWYgKCFsYW5ndWFnZSkge1xuICAgICAgICAgICAgICAgIHRocm93IEVycm9yKGBVbmtub3duIGNsaWVudCBjb2RlIGxhbmd1YWdlOiAke25hbWV9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhd2FpdCBsYW5ndWFnZS5nZW5lcmF0ZShmaWxlcywgb3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmNvbnN0IEpzQ2xpZW50Q29kZSA9IHtcbiAgICBuYW1lOiAnSmF2YVNjcmlwdCcsXG4gICAgc2hvcnROYW1lOiAnanMnLFxuICAgIGdldFRlbXBsYXRlQ29udGV4dChmaWxlQXJnOiBzdHJpbmcsIG9wdGlvbnM6IENsaWVudENvZGVPcHRpb25zKTogYW55IHtcbiAgICAgICAgY29uc3QgZmlsZSA9IHBhcnNlU29saWRpdHlGaWxlQXJnKGZpbGVBcmcsIGZhbHNlKTtcbiAgICAgICAgY29uc3QgeyBkaXIsIG5hbWUgfSA9IGZpbGU7XG4gICAgICAgIGNvbnN0IHJlYWRUZXh0ID0gKG5hbWU6IHN0cmluZywgZW5jb2Rpbmc6ICd1dGY4JyB8ICdiYXNlNjQnKTogc3RyaW5nID0+IHtcbiAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhkaXIobmFtZSkpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlIG5vdCBleGlzdHM6ICR7bmFtZX1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmcy5yZWFkRmlsZVN5bmMoZGlyKG5hbWUpKS50b1N0cmluZyhlbmNvZGluZyk7XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgaW1hZ2VCYXNlNjQgPSBvcHRpb25zLmNsaWVudExldmVsID09PSBDbGllbnRDb2RlTGV2ZWwuZGVwbG95XG4gICAgICAgICAgICA/IHJlYWRUZXh0KG5hbWUudHZjLCAnYmFzZTY0JylcbiAgICAgICAgICAgIDogJyc7XG4gICAgICAgIGNvbnN0IGFiaUpzb24gPSByZWFkVGV4dChuYW1lLmFiaSwgJ3V0ZjgnKS50cmltUmlnaHQoKTtcbiAgICAgICAgY29uc3QgYWJpID0ge1xuICAgICAgICAgICAgZnVuY3Rpb25zOiBbXSxcbiAgICAgICAgICAgIGRhdGE6IFtdLFxuICAgICAgICAgICAgLi4uSlNPTi5wYXJzZShhYmlKc29uKVxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGNsYXNzTmFtZSA9IGAke25hbWUuYmFzZVswXS50b1VwcGVyQ2FzZSgpfSR7bmFtZS5iYXNlLnN1YnN0cigxKX1Db250cmFjdGA7XG4gICAgICAgIGNvbnN0IGlzRGVwbG95ID0gKG9wdGlvbnMuY2xpZW50TGV2ZWwgfHwgJ2RlcGxveScpID09PSAnZGVwbG95JztcblxuICAgICAgICBjb25zdCB2YXJDb250ZXh0ID0gKHYpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGpzVHlwZSA9IHtcbiAgICAgICAgICAgICAgICBhZGRyZXNzOiAnc3RyaW5nJyxcbiAgICAgICAgICAgICAgICAnYWRkcmVzc1tdJzogJ3N0cmluZ1tdJyxcbiAgICAgICAgICAgICAgICB1aW50MjU2OiAnc3RyaW5nJyxcbiAgICAgICAgICAgICAgICB1aW50MzI6ICdudW1iZXInLFxuICAgICAgICAgICAgICAgIHVpbnQxNjogJ251bWJlcicsXG4gICAgICAgICAgICAgICAgdWludDg6ICdudW1iZXInLFxuICAgICAgICAgICAgICAgICd1aW50MjU2W10nOiAnc3RyaW5nW10nLFxuICAgICAgICAgICAgICAgICd1aW50MzJbXSc6ICdudW1iZXJbXScsXG4gICAgICAgICAgICAgICAgJ3VpbnQxNltdJzogJ251bWJlcltdJyxcbiAgICAgICAgICAgICAgICAndWludDhbXSc6ICdudW1iZXJbXScsXG4gICAgICAgICAgICB9W3YudHlwZV0gfHwgdi50eXBlO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAuLi52LFxuICAgICAgICAgICAgICAgIGpzVHlwZSxcbiAgICAgICAgICAgICAgICBpc1NhbWVKc1R5cGU6IGpzVHlwZSA9PT0gdi50eXBlLFxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGZ1bkNvbnRleHQgPSAoZikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAuLi5mLFxuICAgICAgICAgICAgICAgIGhhc0RhdGE6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGhhc0lucHV0c0FuZERhdGE6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGhhc0lucHV0czogZi5pbnB1dHMubGVuZ3RoID4gMCxcbiAgICAgICAgICAgICAgICBoYXNPdXRwdXRzOiBmLm91dHB1dHMubGVuZ3RoID4gMCxcbiAgICAgICAgICAgICAgICBpbnB1dHM6IGYuaW5wdXRzLm1hcCh2YXJDb250ZXh0KSxcbiAgICAgICAgICAgICAgICBvdXRwdXRzOiBmLm91dHB1dHMubWFwKHZhckNvbnRleHQpLFxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGNvbnN0cnVjdG9yID0gZnVuQ29udGV4dChhYmkuZnVuY3Rpb25zLmZpbmQoeCA9PiB4Lm5hbWUgPT09ICdjb25zdHJ1Y3RvcicpIHx8IHtcbiAgICAgICAgICAgIG5hbWU6ICdjb25zdHJ1Y3RvcicsXG4gICAgICAgICAgICBpbnB1dHM6IFtdLFxuICAgICAgICAgICAgb3V0cHV0czogW10sXG4gICAgICAgICAgICBkYXRhOiBbXSxcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0cnVjdG9yLmhhc0RhdGEgPSBhYmkuZGF0YS5sZW5ndGggPiAwO1xuICAgICAgICBjb25zdHJ1Y3Rvci5oYXNJbnB1dHNBbmREYXRhID0gY29uc3RydWN0b3IuaGFzSW5wdXRzICYmIGNvbnN0cnVjdG9yLmhhc0RhdGE7XG4gICAgICAgIGNvbnN0cnVjdG9yLmRhdGEgPSBhYmkuZGF0YS5tYXAodmFyQ29udGV4dCk7XG5cbiAgICAgICAgY29uc3QgZnVuY3Rpb25zID0gYWJpLmZ1bmN0aW9ucy5maWx0ZXIoeCA9PiB4Lm5hbWUgIT09ICdjb25zdHJ1Y3RvcicpLm1hcChmdW5Db250ZXh0KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGltYWdlQmFzZTY0LFxuICAgICAgICAgICAgYWJpSnNvbixcbiAgICAgICAgICAgIGFiaSxcbiAgICAgICAgICAgIGNsYXNzTmFtZSxcbiAgICAgICAgICAgIGlzRGVwbG95LFxuICAgICAgICAgICAgY29uc3RydWN0b3IsXG4gICAgICAgICAgICBmdW5jdGlvbnMsXG4gICAgICAgICAgICBqc01vZHVsZU5vZGU6IG9wdGlvbnMuanNNb2R1bGUgPT09IEpTTW9kdWxlLm5vZGUgfHwgb3B0aW9ucy5qc01vZHVsZSA9PT0gSlNNb2R1bGUubm9kZU5vRGVmYXVsdCxcbiAgICAgICAgICAgIGpzTW9kdWxlTm9kZURlZmF1bHQ6IG9wdGlvbnMuanNNb2R1bGUgPT09IEpTTW9kdWxlLm5vZGUsXG4gICAgICAgICAgICBqc01vZHVsZUVzOiBvcHRpb25zLmpzTW9kdWxlID09PSBKU01vZHVsZS5lcyB8fCBvcHRpb25zLmpzTW9kdWxlID09PSBKU01vZHVsZS5lc05vRGVmYXVsdCxcbiAgICAgICAgICAgIGpzTW9kdWxlRXNEZWZhdWx0OiBvcHRpb25zLmpzTW9kdWxlID09PSBKU01vZHVsZS5lcyxcbiAgICAgICAgfTtcbiAgICB9LFxuICAgIGFzeW5jIGdlbmVyYXRlKGZpbGVzOiBzdHJpbmdbXSwgb3B0aW9uczogQ2xpZW50Q29kZU9wdGlvbnMpIHtcbiAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgICAgICBjb25zdCB7IGRpciwgYmFzZSB9ID0gcGFyc2VGaWxlQXJnKGZpbGUsICcuc29sJywgZmFsc2UpO1xuICAgICAgICAgICAgY29uc3QganMgPSBhd2FpdCBhcHBseVRlbXBsYXRlKGpzQ29udHJhY3RUZW1wbGF0ZSwgSnNDbGllbnRDb2RlLmdldFRlbXBsYXRlQ29udGV4dChmaWxlLCBvcHRpb25zKSk7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGRpcihgJHtiYXNlfUNvbnRyYWN0LmpzYCksIGpzLCB7IGVuY29kaW5nOiAndXRmOCcgfSk7XG4gICAgICAgIH1cbiAgICB9XG59O1xuXG5DbGllbnRDb2RlLnJlZ2lzdGVyKEpzQ2xpZW50Q29kZSk7XG4iXX0=