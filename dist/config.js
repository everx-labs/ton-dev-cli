"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.updatePreferences = updatePreferences;
exports.completeConfig = completeConfig;
exports.netsFromArgsOrAll = netsFromArgsOrAll;
exports.netsFromArgsOrDefault = netsFromArgsOrDefault;
exports.defaultValues = exports.config = void 0;

var _utils = require("./utils");

/*
 * Copyright 2018-2019 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at: https://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 *
 */
var path = require('path');

var os = require('os');

var fs = require('fs');

var tonlabsHome = path.join(os.homedir(), '.tonlabs');
var defaultValues = {
  version: 'latest',
  net: {
    name: 'default',
    image: 'tonlabs/local-node',
    container: 'tonlabs-local-node',
    port: '80',
    arangoPort: '8529'
  },
  compilers: {
    image: 'tonlabs/compilers',
    container: 'tonlabs-compilers'
  }
};
exports.defaultValues = defaultValues;
var defaultPreferences = {
  net: {
    name: defaultValues.net.name,
    version: defaultValues.version,
    hostPort: defaultValues.net.port,
    arangoHostPort: ''
  },
  compilers: {
    version: defaultValues.version
  }
};
var user = (0, _utils.toIdentifier)(os.userInfo().username).toLowerCase();

function createNetConfig(preferences) {
  var containerNameSuffix = preferences.name !== defaultValues.net.name ? "-".concat(preferences.name) : '';
  return {
    preferences: preferences,
    image: "".concat(defaultValues.net.image, ":").concat(preferences.version),
    container: "".concat(defaultValues.net.container, "-").concat(user).concat(containerNameSuffix)
  };
}

function createCompilersConfig(preferences) {
  return {
    preferences: preferences,
    image: "".concat(defaultValues.compilers.image, ":").concat(preferences.version),
    container: "".concat(defaultValues.compilers.container, "-").concat(user),
    mountSource: path.join(tonlabsHome, 'compilers', 'projects'),
    mountDestination: '/projects'
  };
}

var preferences = {
  compilers: defaultPreferences.compilers,
  nets: []
};
var config = {
  auth: {
    authconfig: {
      username: process.env.TONDEV_DH_USER || '',
      password: process.env.TONDEV_DH_PASSWORD || ''
    }
  },
  compilers: createCompilersConfig(defaultPreferences.compilers),
  net: {
    "default": createNetConfig(defaultPreferences.net),
    all: [],
    fromArgs: []
  }
};
exports.config = config;

function preferencesFilePath() {
  return path.join(tonlabsHome, 'preferences.json');
}

var options = {
  net: []
};

function readPreferencesOrDefault(path, def) {
  try {
    return JSON.parse(fs.readFileSync(path, {
      encoding: 'utf8'
    }));
  } catch (_unused) {}

  return def;
}

function writePreferences(path, preferences) {
  fs.writeFileSync(path, JSON.stringify(preferences), {
    encoding: 'utf8'
  });
}

function ensureNetPreferences(name) {
  var existing = preferences.nets.find(function (x) {
    return x.name.toLowerCase() === name.toLowerCase();
  });

  if (existing) {
    return existing;
  }

  var created = Object.assign({}, defaultPreferences.net);
  created.name = name;
  preferences.nets.push(created);
  return created;
}

function applyPreferences() {
  preferences.compilers = preferences.compilers || Object.assign({}, defaultPreferences.compilers);
  preferences.nets = preferences.nets || [];
  config.compilers = createCompilersConfig(preferences.compilers);
  ensureNetPreferences(defaultValues.net.name);
  options.net.forEach(ensureNetPreferences);
  var namesFromArgs = new Set(options.net);
  config.net.all = preferences.nets.map(createNetConfig);
  config.net["default"] = config.net.all.find(function (x) {
    return x.preferences.name === defaultValues.net.name;
  }) || config.net["default"];
  config.net.fromArgs = config.net.all.filter(function (x) {
    return namesFromArgs.has(x.preferences.name);
  });
}

function updatePreferences() {
  writePreferences(preferencesFilePath(), preferences);
  applyPreferences();
}

function completeConfig(args) {
  options = (0, _utils.argsToOptions)(args, {
    net: {
      def: '',
      valueCount: 1000,
      "short": 'n'
    }
  });
  preferences = readPreferencesOrDefault(preferencesFilePath(), preferences);
  applyPreferences();
  updatePreferences();
}

function netsFromArgsOrAll() {
  return config.net.fromArgs.length > 0 ? config.net.fromArgs : config.net.all;
}

function netsFromArgsOrDefault() {
  return config.net.fromArgs.length > 0 ? config.net.fromArgs : [config.net["default"]];
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb25maWcuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJvcyIsImZzIiwidG9ubGFic0hvbWUiLCJqb2luIiwiaG9tZWRpciIsImRlZmF1bHRWYWx1ZXMiLCJ2ZXJzaW9uIiwibmV0IiwibmFtZSIsImltYWdlIiwiY29udGFpbmVyIiwicG9ydCIsImFyYW5nb1BvcnQiLCJjb21waWxlcnMiLCJkZWZhdWx0UHJlZmVyZW5jZXMiLCJob3N0UG9ydCIsImFyYW5nb0hvc3RQb3J0IiwidXNlciIsInVzZXJJbmZvIiwidXNlcm5hbWUiLCJ0b0xvd2VyQ2FzZSIsImNyZWF0ZU5ldENvbmZpZyIsInByZWZlcmVuY2VzIiwiY29udGFpbmVyTmFtZVN1ZmZpeCIsImNyZWF0ZUNvbXBpbGVyc0NvbmZpZyIsIm1vdW50U291cmNlIiwibW91bnREZXN0aW5hdGlvbiIsIm5ldHMiLCJjb25maWciLCJhdXRoIiwiYXV0aGNvbmZpZyIsInByb2Nlc3MiLCJlbnYiLCJUT05ERVZfREhfVVNFUiIsInBhc3N3b3JkIiwiVE9OREVWX0RIX1BBU1NXT1JEIiwiYWxsIiwiZnJvbUFyZ3MiLCJwcmVmZXJlbmNlc0ZpbGVQYXRoIiwib3B0aW9ucyIsInJlYWRQcmVmZXJlbmNlc09yRGVmYXVsdCIsImRlZiIsIkpTT04iLCJwYXJzZSIsInJlYWRGaWxlU3luYyIsImVuY29kaW5nIiwid3JpdGVQcmVmZXJlbmNlcyIsIndyaXRlRmlsZVN5bmMiLCJzdHJpbmdpZnkiLCJlbnN1cmVOZXRQcmVmZXJlbmNlcyIsImV4aXN0aW5nIiwiZmluZCIsIngiLCJjcmVhdGVkIiwiT2JqZWN0IiwiYXNzaWduIiwicHVzaCIsImFwcGx5UHJlZmVyZW5jZXMiLCJmb3JFYWNoIiwibmFtZXNGcm9tQXJncyIsIlNldCIsIm1hcCIsImZpbHRlciIsImhhcyIsInVwZGF0ZVByZWZlcmVuY2VzIiwiY29tcGxldGVDb25maWciLCJhcmdzIiwidmFsdWVDb3VudCIsIm5ldHNGcm9tQXJnc09y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QkFBbUIsRUFBcEIsRUFBd0JoQixXQUF4QixDQUF0QztBQUNBbUMsRUFBQUEsZ0JBQWdCO0FBQ2hCTyxFQUFBQSxpQkFBaUI7QUFDcEI7O0FBRUQsU0FBU0ksaUJBQVQsR0FBMEM7QUFDdEMsU0FBT3hDLE1BQU0sQ0FBQ3JCLEdBQVAsQ0FBVzhCLFFBQVgsQ0FBb0JnQyxNQUFwQixHQUE2QixDQUE3QixHQUFpQ3pDLE1BQU0sQ0FBQ3JCLEdBQVAsQ0FBVzhCLFFBQTVDLEdBQXVEVCxNQUFNLENBQUNyQixHQUFQLENBQVc2QixHQUF6RTtBQUNIOztBQUVELFNBQVNrQyxxQkFBVCxHQUE4QztBQUMxQyxTQUFPMUMsTUFBTSxDQUFDckIsR0FBUCxDQUFXOEIsUUFBWCxDQUFvQmdDLE1BQXBCLEdBQTZCLENBQTdCLEdBQWlDekMsTUFBTSxDQUFDckIsR0FBUCxDQUFXOEIsUUFBNUMsR0FBdUQsQ0FBQ1QsTUFBTSxDQUFDckIsR0FBUCxXQUFELENBQTlEO0FBRUgiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTgtMjAxOSBUT04gREVWIFNPTFVUSU9OUyBMVEQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcbiAqIExpY2Vuc2UgYXQ6IGh0dHBzOi8vd3d3LnRvbi5kZXYvbGljZW5zZXNcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKlxuICovXG4vLyBAZmxvd1xuXG5pbXBvcnQgeyBhcmdzVG9PcHRpb25zLCB0b0lkZW50aWZpZXIgfSBmcm9tIFwiLi91dGlsc1wiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3Qgb3MgPSByZXF1aXJlKCdvcycpO1xuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuXG5jb25zdCB0b25sYWJzSG9tZSA9IHBhdGguam9pbihvcy5ob21lZGlyKCksICcudG9ubGFicycpO1xuXG5jb25zdCBkZWZhdWx0VmFsdWVzID0ge1xuICAgIHZlcnNpb246ICdsYXRlc3QnLFxuICAgIG5ldDoge1xuICAgICAgICBuYW1lOiAnZGVmYXVsdCcsXG4gICAgICAgIGltYWdlOiAndG9ubGFicy9sb2NhbC1ub2RlJyxcbiAgICAgICAgY29udGFpbmVyOiAndG9ubGFicy1sb2NhbC1ub2RlJyxcbiAgICAgICAgcG9ydDogJzgwJyxcbiAgICAgICAgYXJhbmdvUG9ydDogJzg1MjknLFxuICAgIH0sXG4gICAgY29tcGlsZXJzOiB7XG4gICAgICAgIGltYWdlOiAndG9ubGFicy9jb21waWxlcnMnLFxuICAgICAgICBjb250YWluZXI6ICd0b25sYWJzLWNvbXBpbGVycycsXG4gICAgfSxcbn07XG5cbmV4cG9ydCB0eXBlIE5ldFByZWZlcmVuY2VzID0ge1xuICAgIG5hbWU6IHN0cmluZyxcbiAgICB2ZXJzaW9uOiBzdHJpbmcsXG4gICAgaG9zdFBvcnQ6IHN0cmluZyxcbiAgICBhcmFuZ29Ib3N0UG9ydDogc3RyaW5nLFxufTtcblxuZXhwb3J0IHR5cGUgQ29tcGlsZXJzUHJlZmVyZW5jZXMgPSB7XG4gICAgdmVyc2lvbjogc3RyaW5nLFxufTtcblxuY29uc3QgZGVmYXVsdFByZWZlcmVuY2VzID0ge1xuICAgIG5ldDoge1xuICAgICAgICBuYW1lOiBkZWZhdWx0VmFsdWVzLm5ldC5uYW1lLFxuICAgICAgICB2ZXJzaW9uOiBkZWZhdWx0VmFsdWVzLnZlcnNpb24sXG4gICAgICAgIGhvc3RQb3J0OiBkZWZhdWx0VmFsdWVzLm5ldC5wb3J0LFxuICAgICAgICBhcmFuZ29Ib3N0UG9ydDogJycsXG4gICAgfSxcbiAgICBjb21waWxlcnM6IHtcbiAgICAgICAgdmVyc2lvbjogZGVmYXVsdFZhbHVlcy52ZXJzaW9uLFxuICAgIH0sXG59O1xuXG5leHBvcnQgdHlwZSBOZXRDb25maWcgPSB7XG4gICAgcHJlZmVyZW5jZXM6IE5ldFByZWZlcmVuY2VzLFxuICAgIGltYWdlOiBzdHJpbmcsXG4gICAgY29udGFpbmVyOiBzdHJpbmcsXG59O1xuXG5leHBvcnQgdHlwZSBDb21waWxlcnNDb25maWcgPSB7XG4gICAgcHJlZmVyZW5jZXM6IENvbXBpbGVyc1ByZWZlcmVuY2VzLFxuICAgIGltYWdlOiBzdHJpbmcsXG4gICAgY29udGFpbmVyOiBzdHJpbmcsXG4gICAgbW91bnRTb3VyY2U6IHN0cmluZyxcbiAgICBtb3VudERlc3RpbmF0aW9uOiBzdHJpbmcsXG59XG5cblxuZXhwb3J0IHR5cGUgUHJlZmVyZW5jZXMgPSB7XG4gICAgY29tcGlsZXJzOiBDb21waWxlcnNQcmVmZXJlbmNlcyxcbiAgICBuZXRzOiBOZXRQcmVmZXJlbmNlc1tdLFxufVxuXG5jb25zdCB1c2VyID0gdG9JZGVudGlmaWVyKG9zLnVzZXJJbmZvKCkudXNlcm5hbWUpLnRvTG93ZXJDYXNlKCk7XG5cbmZ1bmN0aW9uIGNyZWF0ZU5ldENvbmZpZyhwcmVmZXJlbmNlczogTmV0UHJlZmVyZW5jZXMpOiBOZXRDb25maWcge1xuICAgIGNvbnN0IGNvbnRhaW5lck5hbWVTdWZmaXggPSBwcmVmZXJlbmNlcy5uYW1lICE9PSBkZWZhdWx0VmFsdWVzLm5ldC5uYW1lID8gYC0ke3ByZWZlcmVuY2VzLm5hbWV9YCA6ICcnO1xuICAgIHJldHVybiB7XG4gICAgICAgIHByZWZlcmVuY2VzLFxuICAgICAgICBpbWFnZTogYCR7ZGVmYXVsdFZhbHVlcy5uZXQuaW1hZ2V9OiR7cHJlZmVyZW5jZXMudmVyc2lvbn1gLFxuICAgICAgICBjb250YWluZXI6IGAke2RlZmF1bHRWYWx1ZXMubmV0LmNvbnRhaW5lcn0tJHt1c2VyfSR7Y29udGFpbmVyTmFtZVN1ZmZpeH1gLFxuICAgIH07XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUNvbXBpbGVyc0NvbmZpZyhwcmVmZXJlbmNlczogQ29tcGlsZXJzUHJlZmVyZW5jZXMpOiBDb21waWxlcnNDb25maWcge1xuICAgIHJldHVybiB7XG4gICAgICAgIHByZWZlcmVuY2VzLFxuICAgICAgICBpbWFnZTogYCR7ZGVmYXVsdFZhbHVlcy5jb21waWxlcnMuaW1hZ2V9OiR7cHJlZmVyZW5jZXMudmVyc2lvbn1gLFxuICAgICAgICBjb250YWluZXI6IGAke2RlZmF1bHRWYWx1ZXMuY29tcGlsZXJzLmNvbnRhaW5lcn0tJHt1c2VyfWAsXG4gICAgICAgIG1vdW50U291cmNlOiBwYXRoLmpvaW4odG9ubGFic0hvbWUsICdjb21waWxlcnMnLCAncHJvamVjdHMnKSxcbiAgICAgICAgbW91bnREZXN0aW5hdGlvbjogJy9wcm9qZWN0cycsXG4gICAgfTtcbn1cblxubGV0IHByZWZlcmVuY2VzOiBQcmVmZXJlbmNlcyA9IHtcbiAgICBjb21waWxlcnM6IGRlZmF1bHRQcmVmZXJlbmNlcy5jb21waWxlcnMsXG4gICAgbmV0czogW10sXG59O1xuXG5leHBvcnQgdHlwZSBDb25maWcgPSB7XG4gICAgYXV0aDoge1xuICAgICAgICBhdXRoY29uZmlnOiB7XG4gICAgICAgICAgICB1c2VybmFtZTogc3RyaW5nLFxuICAgICAgICAgICAgcGFzc3dvcmQ6IHN0cmluZyxcbiAgICAgICAgfVxuICAgIH0sXG4gICAgY29tcGlsZXJzOiBDb21waWxlcnNDb25maWcsXG4gICAgbmV0OiB7XG4gICAgICAgIGRlZmF1bHQ6IE5ldENvbmZpZyxcbiAgICAgICAgYWxsOiBOZXRDb25maWdbXSxcbiAgICAgICAgZnJvbUFyZ3M6IE5ldENvbmZpZ1tdLFxuICAgIH1cbn07XG5cblxuY29uc3QgY29uZmlnOiBDb25maWcgPSB7XG4gICAgYXV0aDoge1xuICAgICAgICBhdXRoY29uZmlnOiB7XG4gICAgICAgICAgICB1c2VybmFtZTogcHJvY2Vzcy5lbnYuVE9OREVWX0RIX1VTRVIgfHwgJycsXG4gICAgICAgICAgICBwYXNzd29yZDogcHJvY2Vzcy5lbnYuVE9OREVWX0RIX1BBU1NXT1JEIHx8ICcnLFxuICAgICAgICB9XG4gICAgfSxcbiAgICBjb21waWxlcnM6IGNyZWF0ZUNvbXBpbGVyc0NvbmZpZyhkZWZhdWx0UHJlZmVyZW5jZXMuY29tcGlsZXJzKSxcbiAgICBuZXQ6IHtcbiAgICAgICAgZGVmYXVsdDogY3JlYXRlTmV0Q29uZmlnKGRlZmF1bHRQcmVmZXJlbmNlcy5uZXQpLFxuICAgICAgICBhbGw6IFtdLFxuICAgICAgICBmcm9tQXJnczogW11cbiAgICB9LFxufTtcblxuXG5mdW5jdGlvbiBwcmVmZXJlbmNlc0ZpbGVQYXRoKCkge1xuICAgIHJldHVybiBwYXRoLmpvaW4odG9ubGFic0hvbWUsICdwcmVmZXJlbmNlcy5qc29uJyk7XG59XG5cbmxldCBvcHRpb25zOiB7IG5ldDogc3RyaW5nW10gfSA9IHtcbiAgICBuZXQ6IFtdLFxufTtcblxuZnVuY3Rpb24gcmVhZFByZWZlcmVuY2VzT3JEZWZhdWx0KHBhdGg6IHN0cmluZywgZGVmOiBQcmVmZXJlbmNlcyk6IFByZWZlcmVuY2VzIHtcbiAgICB0cnkge1xuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMocGF0aCwgeyBlbmNvZGluZzogJ3V0ZjgnIH0pKTtcbiAgICB9IGNhdGNoIHtcbiAgICB9XG4gICAgcmV0dXJuIGRlZjtcbn1cblxuZnVuY3Rpb24gd3JpdGVQcmVmZXJlbmNlcyhwYXRoOiBzdHJpbmcsIHByZWZlcmVuY2VzOiBQcmVmZXJlbmNlcykge1xuICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aCwgSlNPTi5zdHJpbmdpZnkocHJlZmVyZW5jZXMpLCB7IGVuY29kaW5nOiAndXRmOCcgfSk7XG59XG5cbmZ1bmN0aW9uIGVuc3VyZU5ldFByZWZlcmVuY2VzKG5hbWU6IHN0cmluZyk6IE5ldFByZWZlcmVuY2VzIHtcbiAgICBjb25zdCBleGlzdGluZyA9IHByZWZlcmVuY2VzLm5ldHMuZmluZCh4ID0+IHgubmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCkpO1xuICAgIGlmIChleGlzdGluZykge1xuICAgICAgICByZXR1cm4gZXhpc3Rpbmc7XG4gICAgfVxuICAgIGNvbnN0IGNyZWF0ZWQgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0UHJlZmVyZW5jZXMubmV0KTtcbiAgICBjcmVhdGVkLm5hbWUgPSBuYW1lO1xuICAgIHByZWZlcmVuY2VzLm5ldHMucHVzaChjcmVhdGVkKTtcbiAgICByZXR1cm4gY3JlYXRlZDtcbn1cblxuZnVuY3Rpb24gYXBwbHlQcmVmZXJlbmNlcygpIHtcbiAgICBwcmVmZXJlbmNlcy5jb21waWxlcnMgPSBwcmVmZXJlbmNlcy5jb21waWxlcnMgfHwgT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdFByZWZlcmVuY2VzLmNvbXBpbGVycyk7XG4gICAgcHJlZmVyZW5jZXMubmV0cyA9IHByZWZlcmVuY2VzLm5ldHMgfHwgW107XG4gICAgY29uZmlnLmNvbXBpbGVycyA9IGNyZWF0ZUNvbXBpbGVyc0NvbmZpZyhwcmVmZXJlbmNlcy5jb21waWxlcnMpO1xuXG4gICAgZW5zdXJlTmV0UHJlZmVyZW5jZXMoZGVmYXVsdFZhbHVlcy5uZXQubmFtZSk7XG4gICAgb3B0aW9ucy5uZXQuZm9yRWFjaChlbnN1cmVOZXRQcmVmZXJlbmNlcyk7XG4gICAgY29uc3QgbmFtZXNGcm9tQXJncyA9IG5ldyBTZXQ8c3RyaW5nPihvcHRpb25zLm5ldCk7XG4gICAgY29uZmlnLm5ldC5hbGwgPSBwcmVmZXJlbmNlcy5uZXRzLm1hcChjcmVhdGVOZXRDb25maWcpO1xuICAgIGNvbmZpZy5uZXQuZGVmYXVsdCA9IGNvbmZpZy5uZXQuYWxsLmZpbmQoeCA9PiB4LnByZWZlcmVuY2VzLm5hbWUgPT09IGRlZmF1bHRWYWx1ZXMubmV0Lm5hbWUpXG4gICAgICAgIHx8IGNvbmZpZy5uZXQuZGVmYXVsdDtcbiAgICBjb25maWcubmV0LmZyb21BcmdzID0gY29uZmlnLm5ldC5hbGwuZmlsdGVyKHggPT4gbmFtZXNGcm9tQXJncy5oYXMoeC5wcmVmZXJlbmNlcy5uYW1lKSk7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZVByZWZlcmVuY2VzKCkge1xuICAgIHdyaXRlUHJlZmVyZW5jZXMocHJlZmVyZW5jZXNGaWxlUGF0aCgpLCBwcmVmZXJlbmNlcyk7XG4gICAgYXBwbHlQcmVmZXJlbmNlcygpO1xufVxuXG5mdW5jdGlvbiBjb21wbGV0ZUNvbmZpZyhhcmdzOiBzdHJpbmdbXSkge1xuICAgIG9wdGlvbnMgPSBhcmdzVG9PcHRpb25zKGFyZ3MsIHtcbiAgICAgICAgbmV0OiB7IGRlZjogJycsIHZhbHVlQ291bnQ6IDEwMDAsIHNob3J0OiAnbicgfVxuICAgIH0pO1xuICAgIHByZWZlcmVuY2VzID0gcmVhZFByZWZlcmVuY2VzT3JEZWZhdWx0KHByZWZlcmVuY2VzRmlsZVBhdGgoKSwgcHJlZmVyZW5jZXMpO1xuICAgIGFwcGx5UHJlZmVyZW5jZXMoKTtcbiAgICB1cGRhdGVQcmVmZXJlbmNlcygpO1xufVxuXG5mdW5jdGlvbiBuZXRzRnJvbUFyZ3NPckFsbCgpOiBOZXRDb25maWdbXSB7XG4gICAgcmV0dXJuIGNvbmZpZy5uZXQuZnJvbUFyZ3MubGVuZ3RoID4gMCA/IGNvbmZpZy5uZXQuZnJvbUFyZ3MgOiBjb25maWcubmV0LmFsbDtcbn1cblxuZnVuY3Rpb24gbmV0c0Zyb21BcmdzT3JEZWZhdWx0KCk6IE5ldENvbmZpZ1tdIHtcbiAgICByZXR1cm4gY29uZmlnLm5ldC5mcm9tQXJncy5sZW5ndGggPiAwID8gY29uZmlnLm5ldC5mcm9tQXJncyA6IFtjb25maWcubmV0LmRlZmF1bHRdO1xuXG59XG5cbmV4cG9ydCB7IGNvbmZpZywgdXBkYXRlUHJlZmVyZW5jZXMsIGRlZmF1bHRWYWx1ZXMsIGNvbXBsZXRlQ29uZmlnLCBuZXRzRnJvbUFyZ3NPckFsbCwgbmV0c0Zyb21BcmdzT3JEZWZhdWx0IH07XG5cblxuIl19