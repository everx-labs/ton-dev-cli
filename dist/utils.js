"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.showUsage = showUsage;
exports.run = run;
exports.versionToNumber = versionToNumber;
exports.forceRmDir = forceRmDir;
exports.ensureCleanDirectory = ensureCleanDirectory;
exports.argsToOptions = argsToOptions;
exports.bindPathJoinTo = bindPathJoinTo;
exports.inputLine = inputLine;
exports.breakWords = breakWords;
exports.httpsGetJson = httpsGetJson;
exports.toIdentifier = toIdentifier;
exports.version = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _texts = require("./texts");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var fs = require('fs');

var path = require('path');

var _require = require('child_process'),
    spawn = _require.spawn;

var version = JSON.parse(fs.readFileSync(path.join(__dirname, '../package.json')).toString()).version;
exports.version = version;

function showUsage(usage) {
  console.log(_texts.texts.usageHeader(version));
  console.log(usage);
}

var spawnEnv = _objectSpread({}, process.env);

function run(name) {
  for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    args[_key - 1] = arguments[_key];
  }

  return new Promise(function (resolve, reject) {
    try {
      var spawned = spawn(name, args, {
        env: spawnEnv
      });
      var errors = [];
      var output = [];
      spawned.stdout.on('data', function (data) {
        output.push(data.toString());
      });
      spawned.stderr.on('data', function (data) {
        errors.push(data.toString());
      });
      spawned.on('error', function (err) {
        reject(err);
      });
      spawned.on('close', function (code) {
        if (code === 0) {
          resolve(output.join(''));
        } else {
          reject(errors.join(''));
        }
      });
    } catch (error) {
      reject(error);
    }
  });
}

function versionToNumber(s) {
  var parts = "".concat(s || '').split('.').map(function (x) {
    return Number.parseInt(x);
  }).slice(0, 3);

  while (parts.length < 3) {
    parts.push(0);
  }

  return parts[0] * 1000000 + parts[1] * 1000 + parts[2];
}

function forceRmDir(dir) {
  fs.readdirSync(dir).forEach(function (item) {
    var itemPath = path.join(dir, item);
    var stat = fs.statSync(itemPath);

    if (itemPath === "." || itemPath === "..") {} else if (stat.isDirectory()) {
      forceRmDir(itemPath);
    } else {
      fs.unlinkSync(itemPath);
    }
  });
  fs.rmdirSync(dir);
}

function ensureCleanDirectory(path) {
  if (fs.existsSync(path)) {
    forceRmDir(path);
  }

  fs.mkdirSync(path, {
    recursive: true
  });
}

function findOptionName(arg, types, strict) {
  if (arg.startsWith('--')) {
    var name = arg.substr(2);
    var optionName = Object.keys(types).find(function (x) {
      return x.toLowerCase() === name.toLowerCase();
    });

    if (!optionName) {
      if (!strict) {
        return null;
      }

      throw _texts.texts.invalidOption(arg);
    }

    return optionName;
  }

  if (arg.startsWith('-')) {
    var _name = arg.substr(1);

    var optionEntry = Object.entries(types).find(function (_ref) {
      var _ref2 = (0, _slicedToArray2["default"])(_ref, 2),
          _ = _ref2[0],
          _type = _ref2[1];

      var type = _type;
      return "".concat(type["short"] || '').toLowerCase() === _name.toLowerCase();
    });

    if (!optionEntry) {
      if (!strict) {
        return null;
      }

      throw _texts.texts.invalidOption(arg);
    }

    return optionEntry[0];
  }

  return null;
}

function argsToOptions(args, types, strict) {
  var options = {
    files: []
  };
  Object.entries(types).forEach(function (_ref3) {
    var _ref4 = (0, _slicedToArray2["default"])(_ref3, 2),
        name = _ref4[0],
        _type = _ref4[1];

    var type = _type;

    if ((type.valueCount || 0) > 1) {
      options[name] = [];
    } else {
      options[name] = type.def;
    }
  });
  var pendingOption = null;
  args.forEach(function (arg) {
    if (pendingOption) {
      var type = types[pendingOption];

      if ((type.valueCount || 0) > 1) {
        options[pendingOption].push(arg);
      } else {
        options[pendingOption] = arg;
      }

      pendingOption = null;
    } else {
      var optionName = findOptionName(arg, types, strict);

      if (optionName) {
        var _type2 = types[optionName];

        if ((_type2.valueCount || 0) > 0) {
          pendingOption = optionName;
        } else {
          options[optionName] = true;
        }
      } else {
        options.files.push(arg);
      }
    }
  });
  return options;
}

function join(base, item, separator) {
  var baseWithSep = base.endsWith(separator);
  var itemWithSep = item.startsWith(separator);

  if (baseWithSep && itemWithSep) {
    return "".concat(base).concat(item.substr(1));
  }

  if (!baseWithSep && !itemWithSep) {
    return "".concat(base, "/").concat(item);
  }

  return "".concat(base).concat(item);
}

function bindPathJoinTo(base, separator) {
  if (separator) {
    var sep = separator;
    return function () {
      var path = base;

      for (var _len2 = arguments.length, items = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        items[_key2] = arguments[_key2];
      }

      items.forEach(function (x) {
        return path = join(path, x, sep);
      });
      return path;
    };
  }

  return function () {
    for (var _len3 = arguments.length, items = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
      items[_key3] = arguments[_key3];
    }

    return items.length > 0 ? path.join.apply(path, [base].concat(items)) : base;
  };
}

function inputLine() {
  return new Promise(function (resolve) {
    var standard_input = process.stdin;
    standard_input.setEncoding('utf-8');
    standard_input.once('data', function (data) {
      resolve("".concat(data).trim());
    });
  });
}

function breakWords(s) {
  var words = s.split(' ');
  var result = '';
  var line = '';
  words.forEach(function (w) {
    if (line.length + w.length > 80) {
      if (result !== '') {
        result += '\n';
      }

      result += line;
      line = '';
    }

    if (line !== '') {
      line += ' ';
    }

    line += w;
  });

  if (line !== '') {
    if (result !== '') {
      result += '\n';
    }

    result += line;
  }

  return result;
}

var https = require('https');

function httpsGetJson(url) {
  return new Promise(function (resolve, reject) {
    var tryUrl = function tryUrl(url) {
      https.get(url, function (res) {
        var body = '';
        res.on('data', function (chunk) {
          body += chunk;
        });
        res.on('end', function () {
          if (res.statusCode === 301) {
            var redirectUrl = res.headers['location'];
            tryUrl(redirectUrl);
            return;
          }

          var response = JSON.parse(body);
          resolve(response);
        });
      }).on('error', function (error) {
        reject(error);
      });
    };

    tryUrl(url);
  });
}

function toIdentifier(s) {
  var identifier = '';

  for (var i = 0; i < s.length; i += 1) {
    var c = s[i];
    var isLetter = c.toLowerCase() !== c.toUpperCase();
    var isDigit = !isLetter && '0123456789'.includes(c);

    if (isLetter || isDigit) {
      identifier += c;
    }
  }

  return identifier;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwYXRoIiwic3Bhd24iLCJ2ZXJzaW9uIiwiSlNPTiIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwiam9pbiIsIl9fZGlybmFtZSIsInRvU3RyaW5nIiwic2hvd1VzYWdlIiwidXNhZ2UiLCJjb25zb2xlIiwibG9nIiwidGV4dHMiLCJ1c2FnZUhlYWRlciIsInNwYXduRW52IiwicHJvY2VzcyIsImVudiIsInJ1biIsIm5hbWUiLCJhcmdzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJzcGF3bmVkIiwiZXJyb3JzIiwib3V0cHV0Iiwic3Rkb3V0Iiwib24iLCJkYXRhIiwicHVzaCIsInN0ZGVyciIsImVyciIsImNvZGUiLCJlcnJvciIsInZlcnNpb25Ub051bWJlciIsInMiLCJwYXJ0cyIsInNwbGl0IiwibWFwIiwieCIsIk51bWJlciIsInBhcnNlSW50Iiwic2xpY2UiLCJsZW5ndGgiLCJmb3JjZVJtRGlyIiwiZGlyIiwicmVhZGRpclN5bmMiLCJmb3JFYWNoIiwiaXRlbSIsIml0ZW1QYXRoIiwic3RhdCIsInN0YXRTeW5jIiwiaXNEaXJlY3RvcnkiLCJ1bmxpbmtTeW5jIiwicm1kaXJTeW5jIiwiZW5zdXJlQ2xlYW5EaXJlY3RvcnkiLCJleGlzdHNTeW5jIiwibWtkaXJTeW5jIiwicmVjdXJzaXZlIiwiZmluZE9wdGlvbk5hbWUiLCJhcmciLCJ0eXBlcyIsInN0cmljdCIsInN0YXJ0c1dpdGgiLCJzdWJzdHIiLCJvcHRpb25OYW1lIiwiT2JqZWN0Iiwia2V5cyIsImZpbmQiLCJ0b0xvd2VyQ2FzZSIsImludmFsaWRPcHRpb24iLCJvcHRpb25FbnRyeSIsImVudHJpZXMiLCJfIiwiX3R5cGUiLCJ0eXBlIiwiYXJnc1RvT3B0aW9ucyIsIm9wdGlvbnMiLCJmaWxlcyIsInZhbHVlQ291bnQiLCJkZWYiLCJwZW5kaW5nT3B0aW9uIiwiYmFzZSIsInNlcGFyYXRvciIsImJhc2VXaXRoU2VwIiwiZW5kc1dpdGgiLCJpdGVtV2l0aFNlcCIsImJpbmRQYXRoSm9pblRvIiwic2VwIiwiaXRlbXMiLCJpbnB1dExpbmUiLCJzdGFuZGFyZF9pbnB1dCIsInN0ZGluIiwic2V0RW5jb2RpbmciLCJvbmNlIiwidHJpbSIsImJyZWFrV29yZHMiLCJ3b3JkcyIsInJlc3VsdCIsImxpbmUiLCJ3IiwiaHR0cHMiLCJodHRwc0dldEpzb24iLCJ1cmwiLCJ0cnlVcmwiLCJnZXQiLCJyZXMiLCJib2R5IiwiY2h1bmsiLCJzdGF0dXNDb2RlIiwicmVkaXJlY3RVcmwiLCJoZWFkZXJzIiwicmVzcG9uc2UiLCJ0b0lkZW50aWZpZXIiLCJpZGVudGlmaWVyIiwiaSIsImMiLCJpc0xldHRlciIsInRvVXBwZXJDYXNlIiwiaXNEaWdpdCIsImluY2x1ZGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFlQTs7Ozs7O0FBRUEsSUFBTUEsRUFBRSxHQUFHQyxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFDQSxJQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztlQUNrQkEsT0FBTyxDQUFDLGVBQUQsQztJQUFqQkUsSyxZQUFBQSxLOztBQUNSLElBQU1DLE9BQU8sR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVdOLEVBQUUsQ0FBQ08sWUFBSCxDQUFnQkwsSUFBSSxDQUFDTSxJQUFMLENBQVVDLFNBQVYsRUFBcUIsaUJBQXJCLENBQWhCLEVBQXlEQyxRQUF6RCxFQUFYLEVBQWdGTixPQUFoRzs7O0FBRUEsU0FBU08sU0FBVCxDQUFtQkMsS0FBbkIsRUFBa0M7QUFDOUJDLEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxhQUFNQyxXQUFOLENBQWtCWixPQUFsQixDQUFaO0FBQ0FTLEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRixLQUFaO0FBQ0g7O0FBRUQsSUFBTUssUUFBUSxxQkFDUEMsT0FBTyxDQUFDQyxHQURELENBQWQ7O0FBSUEsU0FBU0MsR0FBVCxDQUFhQyxJ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QyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHaEYsQ0FBQyxDQUFDUSxNQUF0QixFQUE4QndFLENBQUMsSUFBSSxDQUFuQyxFQUFzQztBQUNsQyxRQUFNQyxDQUFDLEdBQUdqRixDQUFDLENBQUNnRixDQUFELENBQVg7QUFDQSxRQUFNRSxRQUFRLEdBQUdELENBQUMsQ0FBQy9DLFdBQUYsT0FBb0IrQyxDQUFDLENBQUNFLFdBQUYsRUFBckM7QUFDQSxRQUFNQyxPQUFPLEdBQUcsQ0FBQ0YsUUFBRCxJQUFhLGFBQWFHLFFBQWIsQ0FBc0JKLENBQXRCLENBQTdCOztBQUNBLFFBQUlDLFFBQVEsSUFBSUUsT0FBaEIsRUFBeUI7QUFDckJMLE1BQUFBLFVBQVUsSUFBSUUsQ0FBZDtBQUNIO0FBQ0o7O0FBQ0QsU0FBT0YsVUFBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4LTIwMTkgVE9OIERFViBTT0xVVElPTlMgTFRELlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXG4gKiBMaWNlbnNlIGF0OiBodHRwczovL3d3dy50b24uZGV2L2xpY2Vuc2VzXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICpcbiAqL1xuLy8gQGZsb3dcbmltcG9ydCB7IHRleHRzIH0gZnJvbSAnLi90ZXh0cyc7XG5cbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IHNwYXduIH0gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7XG5jb25zdCB2ZXJzaW9uID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3BhY2thZ2UuanNvbicpKS50b1N0cmluZygpKS52ZXJzaW9uO1xuXG5mdW5jdGlvbiBzaG93VXNhZ2UodXNhZ2U6IHN0cmluZykge1xuICAgIGNvbnNvbGUubG9nKHRleHRzLnVzYWdlSGVhZGVyKHZlcnNpb24pKTtcbiAgICBjb25zb2xlLmxvZyh1c2FnZSk7XG59XG5cbmNvbnN0IHNwYXduRW52ID0ge1xuICAgIC4uLnByb2Nlc3MuZW52LFxufTtcblxuZnVuY3Rpb24gcnVuKG5hbWU6IHN0cmluZywgLi4uYXJnczogc3RyaW5nW10pOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBzcGF3bmVkID0gc3Bhd24obmFtZSwgYXJncywgeyBlbnY6IHNwYXduRW52IH0pO1xuICAgICAgICAgICAgY29uc3QgZXJyb3JzID0gW107XG4gICAgICAgICAgICBjb25zdCBvdXRwdXQgPSBbXTtcblxuICAgICAgICAgICAgc3Bhd25lZC5zdGRvdXQub24oJ2RhdGEnLCBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKGRhdGEudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgc3Bhd25lZC5zdGRlcnIub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKGRhdGEudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgc3Bhd25lZC5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgc3Bhd25lZC5vbignY2xvc2UnLCAoY29kZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChjb2RlID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUob3V0cHV0LmpvaW4oJycpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3JzLmpvaW4oJycpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gdmVyc2lvblRvTnVtYmVyKHM6IHN0cmluZyk6IG51bWJlciB7XG4gICAgY29uc3QgcGFydHMgPSBgJHtzIHx8ICcnfWAuc3BsaXQoJy4nKS5tYXAoeCA9PiBOdW1iZXIucGFyc2VJbnQoeCkpLnNsaWNlKDAsIDMpO1xuICAgIHdoaWxlIChwYXJ0cy5sZW5ndGggPCAzKSB7XG4gICAgICAgIHBhcnRzLnB1c2goMCk7XG4gICAgfVxuICAgIHJldHVybiBwYXJ0c1swXSAqIDEwMDAwMDAgKyBwYXJ0c1sxXSAqIDEwMDAgKyBwYXJ0c1syXTtcbn1cblxuZnVuY3Rpb24gZm9yY2VSbURpcihkaXI6IHN0cmluZykge1xuICAgIGZzLnJlYWRkaXJTeW5jKGRpcikuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgICBjb25zdCBpdGVtUGF0aCA9IHBhdGguam9pbihkaXIsIGl0ZW0pO1xuICAgICAgICBjb25zdCBzdGF0ID0gZnMuc3RhdFN5bmMoaXRlbVBhdGgpO1xuXG4gICAgICAgIGlmIChpdGVtUGF0aCA9PT0gXCIuXCIgfHwgaXRlbVBhdGggPT09IFwiLi5cIikge1xuICAgICAgICB9IGVsc2UgaWYgKHN0YXQuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgZm9yY2VSbURpcihpdGVtUGF0aCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmcy51bmxpbmtTeW5jKGl0ZW1QYXRoKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGZzLnJtZGlyU3luYyhkaXIpO1xufVxuXG5mdW5jdGlvbiBlbnN1cmVDbGVhbkRpcmVjdG9yeShwYXRoOiBzdHJpbmcpIHtcbiAgICBpZiAoZnMuZXhpc3RzU3luYyhwYXRoKSkge1xuICAgICAgICBmb3JjZVJtRGlyKHBhdGgpO1xuICAgIH1cbiAgICBmcy5ta2RpclN5bmMocGF0aCwgKHsgcmVjdXJzaXZlOiB0cnVlIH06IGFueSkpO1xufVxuXG5cbmV4cG9ydCB0eXBlIEFyZ1R5cGUgPSB7XG4gICAgZGVmOiBhbnksXG4gICAgc2hvcnQ/OiBzdHJpbmcsXG4gICAgdmFsdWVDb3VudD86IG51bWJlcixcbn1cblxuZXhwb3J0IHR5cGUgQXJnVHlwZXMgPSB7XG4gICAgW3N0cmluZ106IEFyZ1R5cGVcbn1cblxuZnVuY3Rpb24gZmluZE9wdGlvbk5hbWUoYXJnOiBzdHJpbmcsIHR5cGVzOiBBcmdUeXBlcywgc3RyaWN0OiBib29sZWFuKSB7XG4gICAgaWYgKGFyZy5zdGFydHNXaXRoKCctLScpKSB7XG4gICAgICAgIGNvbnN0IG5hbWUgPSBhcmcuc3Vic3RyKDIpO1xuICAgICAgICBjb25zdCBvcHRpb25OYW1lID0gT2JqZWN0LmtleXModHlwZXMpLmZpbmQoeCA9PiB4LnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKSk7XG4gICAgICAgIGlmICghb3B0aW9uTmFtZSkge1xuICAgICAgICAgICAgaWYgKCFzdHJpY3QpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRocm93IHRleHRzLmludmFsaWRPcHRpb24oYXJnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gb3B0aW9uTmFtZTtcbiAgICB9XG4gICAgaWYgKGFyZy5zdGFydHNXaXRoKCctJykpIHtcbiAgICAgICAgY29uc3QgbmFtZSA9IGFyZy5zdWJzdHIoMSk7XG4gICAgICAgIGNvbnN0IG9wdGlvbkVudHJ5ID0gT2JqZWN0LmVudHJpZXModHlwZXMpLmZpbmQoKFtfLCBfdHlwZV0pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHR5cGU6IEFyZ1R5cGUgPSAoX3R5cGU6IGFueSk7XG4gICAgICAgICAgICByZXR1cm4gYCR7dHlwZS5zaG9ydCB8fCAnJ31gLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICghb3B0aW9uRW50cnkpIHtcbiAgICAgICAgICAgIGlmICghc3RyaWN0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyB0ZXh0cy5pbnZhbGlkT3B0aW9uKGFyZyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG9wdGlvbkVudHJ5WzBdO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbn1cblxuXG5mdW5jdGlvbiBhcmdzVG9PcHRpb25zKGFyZ3M6IHN0cmluZ1tdLCB0eXBlczogeyBbc3RyaW5nXTogQXJnVHlwZSB9LCBzdHJpY3Q/OiBib29sZWFuKTogYW55IHtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICBmaWxlczogW10sXG4gICAgfTtcbiAgICBPYmplY3QuZW50cmllcyh0eXBlcykuZm9yRWFjaCgoW25hbWUsIF90eXBlXSkgPT4ge1xuICAgICAgICBjb25zdCB0eXBlOiBBcmdUeXBlID0gKF90eXBlOiBhbnkpO1xuICAgICAgICBpZiAoKHR5cGUudmFsdWVDb3VudCB8fCAwKSA+IDEpIHtcbiAgICAgICAgICAgIG9wdGlvbnNbbmFtZV0gPSBbXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9wdGlvbnNbbmFtZV0gPSB0eXBlLmRlZjtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGxldCBwZW5kaW5nT3B0aW9uID0gbnVsbDtcbiAgICBhcmdzLmZvckVhY2goKGFyZykgPT4ge1xuICAgICAgICBpZiAocGVuZGluZ09wdGlvbikge1xuICAgICAgICAgICAgY29uc3QgdHlwZSA9IHR5cGVzW3BlbmRpbmdPcHRpb25dO1xuICAgICAgICAgICAgaWYgKCh0eXBlLnZhbHVlQ291bnQgfHwgMCkgPiAxKSB7XG4gICAgICAgICAgICAgICAgb3B0aW9uc1twZW5kaW5nT3B0aW9uXS5wdXNoKGFyZyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG9wdGlvbnNbcGVuZGluZ09wdGlvbl0gPSBhcmc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwZW5kaW5nT3B0aW9uID0gbnVsbDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbk5hbWUgPSBmaW5kT3B0aW9uTmFtZShhcmcsIHR5cGVzLCBzdHJpY3QpO1xuICAgICAgICAgICAgaWYgKG9wdGlvbk5hbWUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0eXBlID0gdHlwZXNbb3B0aW9uTmFtZV07XG4gICAgICAgICAgICAgICAgaWYgKCh0eXBlLnZhbHVlQ291bnQgfHwgMCkgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHBlbmRpbmdPcHRpb24gPSBvcHRpb25OYW1lO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnNbb3B0aW9uTmFtZV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5maWxlcy5wdXNoKGFyZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gb3B0aW9ucztcbn1cblxuZXhwb3J0IHR5cGUgUGF0aEpvaW4gPSAoLi4uaXRlbXM6IHN0cmluZ1tdKSA9PiBzdHJpbmc7XG5cbmZ1bmN0aW9uIGpvaW4oYmFzZTogc3RyaW5nLCBpdGVtOiBzdHJpbmcsIHNlcGFyYXRvcjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBiYXNlV2l0aFNlcCA9IGJhc2UuZW5kc1dpdGgoc2VwYXJhdG9yKTtcbiAgICBjb25zdCBpdGVtV2l0aFNlcCA9IGl0ZW0uc3RhcnRzV2l0aChzZXBhcmF0b3IpO1xuICAgIGlmIChiYXNlV2l0aFNlcCAmJiBpdGVtV2l0aFNlcCkge1xuICAgICAgICByZXR1cm4gYCR7YmFzZX0ke2l0ZW0uc3Vic3RyKDEpfWA7XG4gICAgfVxuICAgIGlmICghYmFzZVdpdGhTZXAgJiYgIWl0ZW1XaXRoU2VwKSB7XG4gICAgICAgIHJldHVybiBgJHtiYXNlfS8ke2l0ZW19YDtcbiAgICB9XG4gICAgcmV0dXJuIGAke2Jhc2V9JHtpdGVtfWA7XG59XG5cbmZ1bmN0aW9uIGJpbmRQYXRoSm9pblRvKGJhc2U6IHN0cmluZywgc2VwYXJhdG9yPzogc3RyaW5nKTogUGF0aEpvaW4ge1xuICAgIGlmIChzZXBhcmF0b3IpIHtcbiAgICAgICAgY29uc3Qgc2VwID0gc2VwYXJhdG9yO1xuICAgICAgICByZXR1cm4gKC4uLml0ZW1zOiBzdHJpbmdbXSk6IHN0cmluZyA9PiB7XG4gICAgICAgICAgICBsZXQgcGF0aCA9IGJhc2U7XG4gICAgICAgICAgICBpdGVtcy5mb3JFYWNoKHggPT4gcGF0aCA9IGpvaW4ocGF0aCwgeCwgc2VwKSk7XG4gICAgICAgICAgICByZXR1cm4gcGF0aDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gKC4uLml0ZW1zOiBzdHJpbmdbXSk6IHN0cmluZyA9PiB7XG4gICAgICAgIHJldHVybiBpdGVtcy5sZW5ndGggPiAwID8gcGF0aC5qb2luKGJhc2UsIC4uLml0ZW1zKSA6IGJhc2U7XG4gICAgfVxufVxuXG5cbmZ1bmN0aW9uIGlucHV0TGluZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICBjb25zdCBzdGFuZGFyZF9pbnB1dCA9IHByb2Nlc3Muc3RkaW47XG4gICAgICAgIHN0YW5kYXJkX2lucHV0LnNldEVuY29kaW5nKCd1dGYtOCcpO1xuICAgICAgICBzdGFuZGFyZF9pbnB1dC5vbmNlKCdkYXRhJywgZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgIHJlc29sdmUoYCR7ZGF0YX1gLnRyaW0oKSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBicmVha1dvcmRzKHM6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3Qgd29yZHMgPSBzLnNwbGl0KCcgJyk7XG4gICAgbGV0IHJlc3VsdCA9ICcnO1xuICAgIGxldCBsaW5lID0gJyc7XG4gICAgd29yZHMuZm9yRWFjaCgodykgPT4ge1xuICAgICAgICBpZiAobGluZS5sZW5ndGggKyB3Lmxlbmd0aCA+IDgwKSB7XG4gICAgICAgICAgICBpZiAocmVzdWx0ICE9PSAnJykge1xuICAgICAgICAgICAgICAgIHJlc3VsdCArPSAnXFxuJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc3VsdCArPSBsaW5lO1xuICAgICAgICAgICAgbGluZSA9ICcnO1xuICAgICAgICB9XG4gICAgICAgIGlmIChsaW5lICE9PSAnJykge1xuICAgICAgICAgICAgbGluZSArPSAnICc7XG4gICAgICAgIH1cbiAgICAgICAgbGluZSArPSB3O1xuICAgIH0pO1xuICAgIGlmIChsaW5lICE9PSAnJykge1xuICAgICAgICBpZiAocmVzdWx0ICE9PSAnJykge1xuICAgICAgICAgICAgcmVzdWx0ICs9ICdcXG4nO1xuICAgICAgICB9XG4gICAgICAgIHJlc3VsdCArPSBsaW5lO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xufVxuXG5cbmNvbnN0IGh0dHBzID0gcmVxdWlyZSgnaHR0cHMnKTtcblxuZnVuY3Rpb24gaHR0cHNHZXRKc29uKHVybDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8KltdPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IHRyeVVybCA9ICh1cmwpID0+IHtcbiAgICAgICAgICAgIGh0dHBzLmdldCh1cmwsIGZ1bmN0aW9uIChyZXMpIHtcbiAgICAgICAgICAgICAgICBsZXQgYm9keSA9ICcnO1xuXG4gICAgICAgICAgICAgICAgcmVzLm9uKCdkYXRhJywgZnVuY3Rpb24gKGNodW5rKSB7XG4gICAgICAgICAgICAgICAgICAgIGJvZHkgKz0gY2h1bms7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICByZXMub24oJ2VuZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlID09PSAzMDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlZGlyZWN0VXJsID0gcmVzLmhlYWRlcnNbJ2xvY2F0aW9uJ107XG4gICAgICAgICAgICAgICAgICAgICAgICB0cnlVcmwocmVkaXJlY3RVcmwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KS5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIHRyeVVybCh1cmwpO1xuICAgIH0pXG59XG5cbmZ1bmN0aW9uIHRvSWRlbnRpZmllcihzOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGxldCBpZGVudGlmaWVyID0gJyc7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgIGNvbnN0IGMgPSBzW2ldO1xuICAgICAgICBjb25zdCBpc0xldHRlciA9IGMudG9Mb3dlckNhc2UoKSAhPT0gYy50b1VwcGVyQ2FzZSgpO1xuICAgICAgICBjb25zdCBpc0RpZ2l0ID0gIWlzTGV0dGVyICYmICcwMTIzNDU2Nzg5Jy5pbmNsdWRlcyhjKTtcbiAgICAgICAgaWYgKGlzTGV0dGVyIHx8IGlzRGlnaXQpIHtcbiAgICAgICAgICAgIGlkZW50aWZpZXIgKz0gYztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaWRlbnRpZmllcjtcbn1cblxuZXhwb3J0IHtcbiAgICB2ZXJzaW9uLFxuICAgIHNob3dVc2FnZSxcbiAgICBydW4sXG4gICAgdmVyc2lvblRvTnVtYmVyLFxuICAgIGZvcmNlUm1EaXIsXG4gICAgZW5zdXJlQ2xlYW5EaXJlY3RvcnksXG4gICAgYXJnc1RvT3B0aW9ucyxcbiAgICBiaW5kUGF0aEpvaW5UbyxcbiAgICBpbnB1dExpbmUsXG4gICAgYnJlYWtXb3JkcyxcbiAgICBodHRwc0dldEpzb24sXG4gICAgdG9JZGVudGlmaWVyLFxufVxuIl19