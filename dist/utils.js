"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.showUsage = showUsage;
exports.run = run;
exports.versionToNumber = versionToNumber;
exports.forceRmDir = forceRmDir;
exports.ensureCleanDirectory = ensureCleanDirectory;
exports.argsToOptions = argsToOptions;
exports.bindPathJoinTo = bindPathJoinTo;
exports.inputLine = inputLine;
exports.breakWords = breakWords;
exports.httpsGetJson = httpsGetJson;
exports.version = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _texts = require("./texts");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var fs = require('fs');

var path = require('path');

var _require = require('child_process'),
    spawn = _require.spawn;

var version = JSON.parse(fs.readFileSync(path.join(__dirname, '../package.json')).toString()).version;
exports.version = version;

function showUsage(usage) {
  console.log(_texts.texts.usageHeader(version));
  console.log(usage);
}

var spawnEnv = _objectSpread({}, process.env);

function run(name) {
  for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    args[_key - 1] = arguments[_key];
  }

  return new Promise(function (resolve, reject) {
    try {
      var spawned = spawn(name, args, {
        env: spawnEnv
      });
      var errors = [];
      var output = [];
      spawned.stdout.on('data', function (data) {
        output.push(data.toString());
      });
      spawned.stderr.on('data', function (data) {
        errors.push(data.toString());
      });
      spawned.on('error', function (err) {
        reject(err);
      });
      spawned.on('close', function (code) {
        if (code === 0) {
          resolve(output.join(''));
        } else {
          reject(errors.join(''));
        }
      });
    } catch (error) {
      reject(error);
    }
  });
}

function versionToNumber(s) {
  var parts = "".concat(s || '').split('.').map(function (x) {
    return Number.parseInt(x);
  }).slice(0, 3);

  while (parts.length < 3) {
    parts.push(0);
  }

  return parts[0] * 1000000 + parts[1] * 1000 + parts[2];
}

function forceRmDir(dir) {
  fs.readdirSync(dir).forEach(function (item) {
    var itemPath = path.join(dir, item);
    var stat = fs.statSync(itemPath);

    if (itemPath === "." || itemPath === "..") {} else if (stat.isDirectory()) {
      forceRmDir(itemPath);
    } else {
      fs.unlinkSync(itemPath);
    }
  });
  fs.rmdirSync(dir);
}

function ensureCleanDirectory(path) {
  if (fs.existsSync(path)) {
    forceRmDir(path);
  }

  fs.mkdirSync(path, {
    recursive: true
  });
}

function findOptionName(arg, types) {
  if (arg.startsWith('--')) {
    var name = arg.substr(2);
    var optionName = Object.keys(types).find(function (x) {
      return x.toLowerCase() === name.toLowerCase();
    });

    if (!optionName) {
      throw _texts.texts.invalidOption(arg);
    }

    return optionName;
  }

  if (arg.startsWith('-')) {
    var _name = arg.substr(1);

    var optionEntry = Object.entries(types).find(function (_ref) {
      var _ref2 = (0, _slicedToArray2["default"])(_ref, 2),
          _ = _ref2[0],
          _type = _ref2[1];

      var type = _type;
      return "".concat(type["short"] || '').toLowerCase() === _name.toLowerCase();
    });

    if (!optionEntry) {
      throw _texts.texts.invalidOption(arg);
    }

    return optionEntry[0];
  }

  return null;
}

function argsToOptions(args, types) {
  var options = {
    files: []
  };
  Object.entries(types).forEach(function (_ref3) {
    var _ref4 = (0, _slicedToArray2["default"])(_ref3, 2),
        name = _ref4[0],
        _type = _ref4[1];

    var type = _type;

    if ((type.valueCount || 0) > 1) {
      options[name] = [];
    } else {
      options[name] = type.def;
    }
  });
  var pendingOption = null;
  args.forEach(function (arg) {
    if (pendingOption) {
      var type = types[pendingOption];

      if ((type.valueCount || 0) > 1) {
        options[pendingOption].push(arg);
      } else {
        options[pendingOption] = arg;
      }

      pendingOption = null;
    } else {
      var optionName = findOptionName(arg, types);

      if (optionName) {
        var _type2 = types[optionName];

        if ((_type2.valueCount || 0) > 0) {
          pendingOption = optionName;
        } else {
          options[optionName] = true;
        }
      } else {
        options.files.push(arg);
      }
    }
  });
  return options;
}

function join(base, item, separator) {
  var baseWithSep = base.endsWith(separator);
  var itemWithSep = item.startsWith(separator);

  if (baseWithSep && itemWithSep) {
    return "".concat(base).concat(item.substr(1));
  }

  if (!baseWithSep && !itemWithSep) {
    return "".concat(base, "/").concat(item);
  }

  return "".concat(base).concat(item);
}

function bindPathJoinTo(base, separator) {
  if (separator) {
    var sep = separator;
    return function () {
      var path = base;

      for (var _len2 = arguments.length, items = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        items[_key2] = arguments[_key2];
      }

      items.forEach(function (x) {
        return path = join(path, x, sep);
      });
      return path;
    };
  }

  return function () {
    for (var _len3 = arguments.length, items = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
      items[_key3] = arguments[_key3];
    }

    return items.length > 0 ? path.join.apply(path, [base].concat(items)) : base;
  };
}

function inputLine() {
  return new Promise(function (resolve) {
    var standard_input = process.stdin;
    standard_input.setEncoding('utf-8');
    standard_input.once('data', function (data) {
      resolve("".concat(data).trim());
    });
  });
}

function breakWords(s) {
  var words = s.split(' ');
  var result = '';
  var line = '';
  words.forEach(function (w) {
    if (line.length + w.length > 80) {
      if (result !== '') {
        result += '\n';
      }

      result += line;
      line = '';
    }

    if (line !== '') {
      line += ' ';
    }

    line += w;
  });

  if (line !== '') {
    if (result !== '') {
      result += '\n';
    }

    result += line;
  }

  return result;
}

var https = require('https');

function httpsGetJson(url) {
  return new Promise(function (resolve, reject) {
    var tryUrl = function tryUrl(url) {
      https.get(url, function (res) {
        var body = '';
        res.on('data', function (chunk) {
          body += chunk;
        });
        res.on('end', function () {
          if (res.statusCode === 301) {
            var redirectUrl = res.headers['location'];
            tryUrl(redirectUrl);
            return;
          }

          var response = JSON.parse(body);
          resolve(response);
        });
      }).on('error', function (error) {
        reject(error);
      });
    };

    tryUrl(url);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwYXRoIiwic3Bhd24iLCJ2ZXJzaW9uIiwiSlNPTiIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwiam9pbiIsIl9fZGlybmFtZSIsInRvU3RyaW5nIiwic2hvd1VzYWdlIiwidXNhZ2UiLCJjb25zb2xlIiwibG9nIiwidGV4dHMiLCJ1c2FnZUhlYWRlciIsInNwYXduRW52IiwicHJvY2VzcyIsImVudiIsInJ1biIsIm5hbWUiLCJhcmdzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJzcGF3bmVkIiwiZXJyb3JzIiwib3V0cHV0Iiwic3Rkb3V0Iiwib24iLCJkYXRhIiwicHVzaCIsInN0ZGVyciIsImVyciIsImNvZGUiLCJlcnJvciIsInZlcnNpb25Ub051bWJlciIsInMiLCJwYXJ0cyIsInNwbGl0IiwibWFwIiwieCIsIk51bWJlciIsInBhcnNlSW50Iiwic2xpY2UiLCJsZW5ndGgiLCJmb3JjZVJtRGlyIiwiZGlyIiwicmVhZGRpclN5bmMiLCJmb3JFYWNoIiwiaXRlbSIsIml0ZW1QYXRoIiwic3RhdCIsInN0YXRTeW5jIiwiaXNEaXJlY3RvcnkiLCJ1bmxpbmtTeW5jIiwicm1kaXJTeW5jIiwiZW5zdXJlQ2xlYW5EaXJlY3RvcnkiLCJleGlzdHNTeW5jIiwibWtkaXJTeW5jIiwicmVjdXJzaXZlIiwiZmluZE9wdGlvbk5hbWUiLCJhcmciLCJ0eXBlcyIsInN0YXJ0c1dpdGgiLCJzdWJzdHIiLCJvcHRpb25OYW1lIiwiT2JqZWN0Iiwia2V5cyIsImZpbmQiLCJ0b0xvd2VyQ2FzZSIsImludmFsaWRPcHRpb24iLCJvcHRpb25FbnRyeSIsImVudHJpZXMiLCJfIiwiX3R5cGUiLCJ0eXBlIiwiYXJnc1RvT3B0aW9ucyIsIm9wdGlvbnMiLCJmaWxlcyIsInZhbHVlQ291bnQiLCJkZWYiLCJwZW5kaW5nT3B0aW9uIiwiYmFzZSIsInNlcGFyYXRvciIsImJhc2VXaXRoU2VwIiwiZW5kc1dpdGgiLCJpdGVtV2l0aFNlcCIsImJpbmRQYXRoSm9pblRvIiwic2VwIiwiaXRlbXMiLCJpbnB1dExpbmUiLCJzdGFuZGFyZF9pbnB1dCIsInN0ZGluIiwic2V0RW5jb2RpbmciLCJvbmNlIiwidHJpbSIsImJyZWFrV29yZHMiLCJ3b3JkcyIsInJlc3VsdCIsImxpbmUiLCJ3IiwiaHR0cHMiLCJodHRwc0dldEpzb24iLCJ1cmwiLCJ0cnlVcmwiLCJnZXQiLCJyZXMiLCJib2R5IiwiY2h1bmsiLCJzdGF0dXNDb2RlIiwicmVkaXJlY3RVcmwiLCJoZWFkZXJzIiwicmVzcG9uc2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBZUE7Ozs7OztBQUVBLElBQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUQsQ0FBbEI7O0FBQ0EsSUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7ZUFDa0JBLE9BQU8sQ0FBQyxlQUFELEM7SUFBakJFLEssWUFBQUEsSzs7QUFFUixJQUFNQyxPQUFPLEdBQUdDLElBQUksQ0FBQ0MsS0FBTCxDQUFXTixFQUFFLENBQUNPLFlBQUgsQ0FBZ0JMLElBQUksQ0FBQ00sSUFBTCxDQUFVQyxTQUFWLEVBQXFCLGlCQUFyQixDQUFoQixFQUF5REMsUUFBekQsRUFBWCxFQUFnRk4sT0FBaEc7OztBQUVBLFNBQVNPLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQWtDO0FBQzlCQyxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsYUFBTUMsV0FBTixDQUFrQlosT0FBbEIsQ0FBWjtBQUNBUyxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUYsS0FBWjtBQUNIOztBQUVELElBQU1LLFFBQVEscUJBQ1BDLE9BQU8sQ0FBQ0MsR0FERCxDQUFkOztBQUlBLFNBQVNDLEdBQVQsQ0FBYUMsSUFBYixFQUErRDtBQUFBLG9DQUFqQ0MsSUFBaUM7QUFBakNBLElBQUFBLElBQWlDO0FBQUE7O0FBQzNELFNBQU8sSUFBSUMsT0FBSixDQUFZLFVBQUNDLE9BQUQs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LFlBQUlDLElBQUksR0FBRyxFQUFYO0FBRUFELFFBQUFBLEdBQUcsQ0FBQzlFLEVBQUosQ0FBTyxNQUFQLEVBQWUsVUFBVWdGLEtBQVYsRUFBaUI7QUFDNUJELFVBQUFBLElBQUksSUFBSUMsS0FBUjtBQUNILFNBRkQ7QUFJQUYsUUFBQUEsR0FBRyxDQUFDOUUsRUFBSixDQUFPLEtBQVAsRUFBYyxZQUFZO0FBQ3RCLGNBQUk4RSxHQUFHLENBQUNHLFVBQUosS0FBbUIsR0FBdkIsRUFBNEI7QUFDeEIsZ0JBQU1DLFdBQVcsR0FBR0osR0FBRyxDQUFDSyxPQUFKLENBQVksVUFBWixDQUFwQjtBQUNBUCxZQUFBQSxNQUFNLENBQUNNLFdBQUQsQ0FBTjtBQUNBO0FBQ0g7O0FBQ0QsY0FBTUUsUUFBUSxHQUFHN0csSUFBSSxDQUFDQyxLQUFMLENBQVd1RyxJQUFYLENBQWpCO0FBQ0FyRixVQUFBQSxPQUFPLENBQUMwRixRQUFELENBQVA7QUFDSCxTQVJEO0FBU0gsT0FoQkQsRUFnQkdwRixFQWhCSCxDQWdCTSxPQWhCTixFQWdCZSxVQUFDTSxLQUFELEVBQVc7QUFDdEJYLFFBQUFBLE1BQU0sQ0FBQ1csS0FBRCxDQUFOO0FBQ0gsT0FsQkQ7QUFtQkgsS0FwQkQ7O0FBcUJBc0UsSUFBQUEsTUFBTSxDQUFDRCxHQUFELENBQU47QUFDSCxHQXZCTSxDQUFQO0FBd0JIIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4LTIwMTkgVE9OIERFViBTT0xVVElPTlMgTFRELlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXG4gKiBMaWNlbnNlIGF0OiBodHRwczovL3d3dy50b24uZGV2L2xpY2Vuc2VzXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICpcbiAqL1xuLy8gQGZsb3dcbmltcG9ydCB7IHRleHRzIH0gZnJvbSAnLi90ZXh0cyc7XG5cbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IHNwYXduIH0gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7XG5cbmNvbnN0IHZlcnNpb24gPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vcGFja2FnZS5qc29uJykpLnRvU3RyaW5nKCkpLnZlcnNpb247XG5cbmZ1bmN0aW9uIHNob3dVc2FnZSh1c2FnZTogc3RyaW5nKSB7XG4gICAgY29uc29sZS5sb2codGV4dHMudXNhZ2VIZWFkZXIodmVyc2lvbikpO1xuICAgIGNvbnNvbGUubG9nKHVzYWdlKTtcbn1cblxuY29uc3Qgc3Bhd25FbnYgPSB7XG4gICAgLi4ucHJvY2Vzcy5lbnYsXG59O1xuXG5mdW5jdGlvbiBydW4obmFtZTogc3RyaW5nLCAuLi5hcmdzOiBzdHJpbmdbXSk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHNwYXduZWQgPSBzcGF3bihuYW1lLCBhcmdzLCB7IGVudjogc3Bhd25FbnYgfSk7XG4gICAgICAgICAgICBjb25zdCBlcnJvcnMgPSBbXTtcbiAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IFtdO1xuXG4gICAgICAgICAgICBzcGF3bmVkLnN0ZG91dC5vbignZGF0YScsIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgb3V0cHV0LnB1c2goZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzcGF3bmVkLnN0ZGVyci5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzcGF3bmVkLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzcGF3bmVkLm9uKCdjbG9zZScsIChjb2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGNvZGUgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShvdXRwdXQuam9pbignJykpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcnMuam9pbignJykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiB2ZXJzaW9uVG9OdW1iZXIoczogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBjb25zdCBwYXJ0cyA9IGAke3MgfHwgJyd9YC5zcGxpdCgnLicpLm1hcCh4ID0+IE51bWJlci5wYXJzZUludCh4KSkuc2xpY2UoMCwgMyk7XG4gICAgd2hpbGUgKHBhcnRzLmxlbmd0aCA8IDMpIHtcbiAgICAgICAgcGFydHMucHVzaCgwKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhcnRzWzBdICogMTAwMDAwMCArIHBhcnRzWzFdICogMTAwMCArIHBhcnRzWzJdO1xufVxuXG5mdW5jdGlvbiBmb3JjZVJtRGlyKGRpcjogc3RyaW5nKSB7XG4gICAgZnMucmVhZGRpclN5bmMoZGlyKS5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgIGNvbnN0IGl0ZW1QYXRoID0gcGF0aC5qb2luKGRpciwgaXRlbSk7XG4gICAgICAgIGNvbnN0IHN0YXQgPSBmcy5zdGF0U3luYyhpdGVtUGF0aCk7XG5cbiAgICAgICAgaWYgKGl0ZW1QYXRoID09PSBcIi5cIiB8fCBpdGVtUGF0aCA9PT0gXCIuLlwiKSB7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICBmb3JjZVJtRGlyKGl0ZW1QYXRoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZzLnVubGlua1N5bmMoaXRlbVBhdGgpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgZnMucm1kaXJTeW5jKGRpcik7XG59XG5cbmZ1bmN0aW9uIGVuc3VyZUNsZWFuRGlyZWN0b3J5KHBhdGg6IHN0cmluZykge1xuICAgIGlmIChmcy5leGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgICAgIGZvcmNlUm1EaXIocGF0aCk7XG4gICAgfVxuICAgIGZzLm1rZGlyU3luYyhwYXRoLCAoeyByZWN1cnNpdmU6IHRydWUgfTogYW55KSk7XG59XG5cblxuZXhwb3J0IHR5cGUgQXJnVHlwZSA9IHtcbiAgICBkZWY6IGFueSxcbiAgICBzaG9ydD86IHN0cmluZyxcbiAgICB2YWx1ZUNvdW50PzogbnVtYmVyLFxufVxuXG5leHBvcnQgdHlwZSBBcmdUeXBlcyA9IHtcbiAgICBbc3RyaW5nXTogQXJnVHlwZVxufVxuXG5mdW5jdGlvbiBmaW5kT3B0aW9uTmFtZShhcmc6IHN0cmluZywgdHlwZXM6IEFyZ1R5cGVzKSB7XG4gICAgaWYgKGFyZy5zdGFydHNXaXRoKCctLScpKSB7XG4gICAgICAgIGNvbnN0IG5hbWUgPSBhcmcuc3Vic3RyKDIpO1xuICAgICAgICBjb25zdCBvcHRpb25OYW1lID0gT2JqZWN0LmtleXModHlwZXMpLmZpbmQoeCA9PiB4LnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKSk7XG4gICAgICAgIGlmICghb3B0aW9uTmFtZSkge1xuICAgICAgICAgICAgdGhyb3cgdGV4dHMuaW52YWxpZE9wdGlvbihhcmcpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvcHRpb25OYW1lO1xuICAgIH1cbiAgICBpZiAoYXJnLnN0YXJ0c1dpdGgoJy0nKSkge1xuICAgICAgICBjb25zdCBuYW1lID0gYXJnLnN1YnN0cigxKTtcbiAgICAgICAgY29uc3Qgb3B0aW9uRW50cnkgPSBPYmplY3QuZW50cmllcyh0eXBlcykuZmluZCgoW18sIF90eXBlXSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdHlwZTogQXJnVHlwZSA9IChfdHlwZTogYW55KTtcbiAgICAgICAgICAgIHJldHVybiBgJHt0eXBlLnNob3J0IHx8ICcnfWAudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCFvcHRpb25FbnRyeSkge1xuICAgICAgICAgICAgdGhyb3cgdGV4dHMuaW52YWxpZE9wdGlvbihhcmcpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvcHRpb25FbnRyeVswXTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG59XG5cblxuZnVuY3Rpb24gYXJnc1RvT3B0aW9ucyhhcmdzOiBzdHJpbmdbXSwgdHlwZXM6IHsgW3N0cmluZ106IEFyZ1R5cGUgfSk6IGFueSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgZmlsZXM6IFtdLFxuICAgIH07XG4gICAgT2JqZWN0LmVudHJpZXModHlwZXMpLmZvckVhY2goKFtuYW1lLCBfdHlwZV0pID0+IHtcbiAgICAgICAgY29uc3QgdHlwZTogQXJnVHlwZSA9IChfdHlwZTogYW55KTtcbiAgICAgICAgaWYgKCh0eXBlLnZhbHVlQ291bnQgfHwgMCkgPiAxKSB7XG4gICAgICAgICAgICBvcHRpb25zW25hbWVdID0gW107XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvcHRpb25zW25hbWVdID0gdHlwZS5kZWY7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBsZXQgcGVuZGluZ09wdGlvbiA9IG51bGw7XG4gICAgYXJncy5mb3JFYWNoKChhcmcpID0+IHtcbiAgICAgICAgaWYgKHBlbmRpbmdPcHRpb24pIHtcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSB0eXBlc1twZW5kaW5nT3B0aW9uXTtcbiAgICAgICAgICAgIGlmICgodHlwZS52YWx1ZUNvdW50IHx8IDApID4gMSkge1xuICAgICAgICAgICAgICAgIG9wdGlvbnNbcGVuZGluZ09wdGlvbl0ucHVzaChhcmcpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBvcHRpb25zW3BlbmRpbmdPcHRpb25dID0gYXJnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGVuZGluZ09wdGlvbiA9IG51bGw7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBvcHRpb25OYW1lID0gZmluZE9wdGlvbk5hbWUoYXJnLCB0eXBlcyk7XG4gICAgICAgICAgICBpZiAob3B0aW9uTmFtZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHR5cGUgPSB0eXBlc1tvcHRpb25OYW1lXTtcbiAgICAgICAgICAgICAgICBpZiAoKHR5cGUudmFsdWVDb3VudCB8fCAwKSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcGVuZGluZ09wdGlvbiA9IG9wdGlvbk5hbWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc1tvcHRpb25OYW1lXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBvcHRpb25zLmZpbGVzLnB1c2goYXJnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBvcHRpb25zO1xufVxuXG5leHBvcnQgdHlwZSBQYXRoSm9pbiA9ICguLi5pdGVtczogc3RyaW5nW10pID0+IHN0cmluZztcblxuZnVuY3Rpb24gam9pbihiYXNlOiBzdHJpbmcsIGl0ZW06IHN0cmluZywgc2VwYXJhdG9yOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IGJhc2VXaXRoU2VwID0gYmFzZS5lbmRzV2l0aChzZXBhcmF0b3IpO1xuICAgIGNvbnN0IGl0ZW1XaXRoU2VwID0gaXRlbS5zdGFydHNXaXRoKHNlcGFyYXRvcik7XG4gICAgaWYgKGJhc2VXaXRoU2VwICYmIGl0ZW1XaXRoU2VwKSB7XG4gICAgICAgIHJldHVybiBgJHtiYXNlfSR7aXRlbS5zdWJzdHIoMSl9YDtcbiAgICB9XG4gICAgaWYgKCFiYXNlV2l0aFNlcCAmJiAhaXRlbVdpdGhTZXApIHtcbiAgICAgICAgcmV0dXJuIGAke2Jhc2V9LyR7aXRlbX1gO1xuICAgIH1cbiAgICByZXR1cm4gYCR7YmFzZX0ke2l0ZW19YDtcbn1cblxuZnVuY3Rpb24gYmluZFBhdGhKb2luVG8oYmFzZTogc3RyaW5nLCBzZXBhcmF0b3I/OiBzdHJpbmcpOiBQYXRoSm9pbiB7XG4gICAgaWYgKHNlcGFyYXRvcikge1xuICAgICAgICBjb25zdCBzZXAgPSBzZXBhcmF0b3I7XG4gICAgICAgIHJldHVybiAoLi4uaXRlbXM6IHN0cmluZ1tdKTogc3RyaW5nID0+IHtcbiAgICAgICAgICAgIGxldCBwYXRoID0gYmFzZTtcbiAgICAgICAgICAgIGl0ZW1zLmZvckVhY2goeCA9PiBwYXRoID0gam9pbihwYXRoLCB4LCBzZXApKTtcbiAgICAgICAgICAgIHJldHVybiBwYXRoO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiAoLi4uaXRlbXM6IHN0cmluZ1tdKTogc3RyaW5nID0+IHtcbiAgICAgICAgcmV0dXJuIGl0ZW1zLmxlbmd0aCA+IDAgPyBwYXRoLmpvaW4oYmFzZSwgLi4uaXRlbXMpIDogYmFzZTtcbiAgICB9XG59XG5cblxuZnVuY3Rpb24gaW5wdXRMaW5lKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgIGNvbnN0IHN0YW5kYXJkX2lucHV0ID0gcHJvY2Vzcy5zdGRpbjtcbiAgICAgICAgc3RhbmRhcmRfaW5wdXQuc2V0RW5jb2RpbmcoJ3V0Zi04Jyk7XG4gICAgICAgIHN0YW5kYXJkX2lucHV0Lm9uY2UoJ2RhdGEnLCBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgcmVzb2x2ZShgJHtkYXRhfWAudHJpbSgpKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGJyZWFrV29yZHMoczogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCB3b3JkcyA9IHMuc3BsaXQoJyAnKTtcbiAgICBsZXQgcmVzdWx0ID0gJyc7XG4gICAgbGV0IGxpbmUgPSAnJztcbiAgICB3b3Jkcy5mb3JFYWNoKCh3KSA9PiB7XG4gICAgICAgIGlmIChsaW5lLmxlbmd0aCArIHcubGVuZ3RoID4gODApIHtcbiAgICAgICAgICAgIGlmIChyZXN1bHQgIT09ICcnKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ICs9ICdcXG4nO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzdWx0ICs9IGxpbmU7XG4gICAgICAgICAgICBsaW5lID0gJyc7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGxpbmUgIT09ICcnKSB7XG4gICAgICAgICAgICBsaW5lICs9ICcgJztcbiAgICAgICAgfVxuICAgICAgICBsaW5lICs9IHc7XG4gICAgfSk7XG4gICAgaWYgKGxpbmUgIT09ICcnKSB7XG4gICAgICAgIGlmIChyZXN1bHQgIT09ICcnKSB7XG4gICAgICAgICAgICByZXN1bHQgKz0gJ1xcbic7XG4gICAgICAgIH1cbiAgICAgICAgcmVzdWx0ICs9IGxpbmU7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG59XG5cblxuY29uc3QgaHR0cHMgPSByZXF1aXJlKCdodHRwcycpO1xuXG5mdW5jdGlvbiBodHRwc0dldEpzb24odXJsOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTwqW10+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgdHJ5VXJsID0gKHVybCkgPT4ge1xuICAgICAgICAgICAgaHR0cHMuZ2V0KHVybCwgZnVuY3Rpb24gKHJlcykge1xuICAgICAgICAgICAgICAgIGxldCBib2R5ID0gJyc7XG5cbiAgICAgICAgICAgICAgICByZXMub24oJ2RhdGEnLCBmdW5jdGlvbiAoY2h1bmspIHtcbiAgICAgICAgICAgICAgICAgICAgYm9keSArPSBjaHVuaztcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHJlcy5vbignZW5kJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDMwMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVkaXJlY3RVcmwgPSByZXMuaGVhZGVyc1snbG9jYXRpb24nXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyeVVybChyZWRpcmVjdFVybCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBKU09OLnBhcnNlKGJvZHkpO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pLm9uKCdlcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgdHJ5VXJsKHVybCk7XG4gICAgfSlcbn1cblxuZXhwb3J0IHtcbiAgICB2ZXJzaW9uLFxuICAgIHNob3dVc2FnZSxcbiAgICBydW4sXG4gICAgdmVyc2lvblRvTnVtYmVyLFxuICAgIGZvcmNlUm1EaXIsXG4gICAgZW5zdXJlQ2xlYW5EaXJlY3RvcnksXG4gICAgYXJnc1RvT3B0aW9ucyxcbiAgICBiaW5kUGF0aEpvaW5UbyxcbiAgICBpbnB1dExpbmUsXG4gICAgYnJlYWtXb3JkcyxcbiAgICBodHRwc0dldEpzb24sXG59XG4iXX0=